<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ephys_su_lfp_coherence_spect</title>
  <meta name="keywords" content="ephys_su_lfp_coherence_spect">
  <meta name="description" content="computes coherency spectra between fields and single units">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../menu.html">Home</a> &gt;  <a href="menu.html">ephys</a> &gt; ephys_su_lfp_coherence_spect.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../menu.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for ephys&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>ephys_su_lfp_coherence_spect
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>computes coherency spectra between fields and single units</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function ephys_su_lfp_coherence_spect(LFPCHANNEL,SUCHANNEL,SUCLUSTER,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">computes coherency spectra between fields and single units

    ephys_su_lfp_coherence_spect(LFPCHANNEL,SUCHANNEL,SUCLUSTER,HISTOGRAM,varargin)
    
    LFPCHANNEL
    LFPCHANNEL to use

    SUCHANNEL
    channel with single units (already clustered and saved in 'sua')

    SUCLUSTER
    number of cluster with single unit</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>	conditions signals for further processing</li><li><a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>	takes ephys data from Intan recordings and re-references</li><li><a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>	save in multiple formats in a single command</li><li><a href="../ephys/helpers/visualization/prettify_axislabels.html" class="code" title="function prettify_axislabels(FIGHANDLE,varargin)">prettify_axislabels</a>	makes axis labels sensible</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function ephys_su_lfp_coherence_spect(LFPCHANNEL,SUCHANNEL,SUCLUSTER,varargin)</a>
0002 <span class="comment">%computes coherency spectra between fields and single units</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%    ephys_su_lfp_coherence_spect(LFPCHANNEL,SUCHANNEL,SUCLUSTER,HISTOGRAM,varargin)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%    LFPCHANNEL</span>
0007 <span class="comment">%    LFPCHANNEL to use</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%    SUCHANNEL</span>
0010 <span class="comment">%    channel with single units (already clustered and saved in 'sua')</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%    SUCLUSTER</span>
0013 <span class="comment">%    number of cluster with single unit</span>
0014 
0015 <span class="comment">%</span>
0016 <span class="comment">%    the following may be passed as parameter/value pairs:</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%        savedir</span>
0019 <span class="comment">%        directory to save results in (default: 'coherence')</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%        filedir</span>
0022 <span class="comment">%        directory that contains the single-unit data and LFP subdirectory (default: 'pwd')</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%        colors</span>
0025 <span class="comment">%        colormap for coherence graph (default: 'jet')</span>
0026 <span class="comment">%</span>
0027 <span class="comment">%        nfft</span>
0028 <span class="comment">%        spectrum nfft (default: 2^nextpow2(length(signal)))</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%        min_f</span>
0031 <span class="comment">%        minimum frequency to display (default: 10)</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%        max_f</span>
0034 <span class="comment">%        maximum frequency to display (default: 100)</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%        w</span>
0037 <span class="comment">%        time-bandwidth product (default: 3)</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%        alpha</span>
0040 <span class="comment">%        confidence line that coherence is significant (default .001)</span>
0041 <span class="comment">%</span>
0042 <span class="comment">%        ntapers</span>
0043 <span class="comment">%        number of tapers to use (default: 2*w-1)</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%        beta</span>
0046 <span class="comment">%        parameter for z-transform of coherence (default: 1.5)</span>
0047 <span class="comment">%</span>
0048 <span class="comment">%        freq_range</span>
0049 <span class="comment">%        frequency range for LFP filtering (default: 300)</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%        lfp_fs</span>
0052 <span class="comment">%        lfp sampling rate (default: 25e3)</span>
0053 <span class="comment">%</span>
0054 <span class="comment">%        medfilt_scale</span>
0055 <span class="comment">%        median filter scale in ms (default: 1.5)</span>
0056 <span class="comment">%</span>
0057 <span class="comment">% see also ephys_su_lfp_coherence_ifr.m, ephys_su_lfp_coherence_tf.m</span>
0058 
0059 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PARAMETER COLLECTION %%%%%%%%%%%%%%%%%</span>
0060 
0061 nparams=length(varargin);
0062 
0063 filedir=pwd;
0064 savedir=pwd;
0065 nfft=[];
0066 min_f=10;
0067 max_f=100;
0068 w=3;
0069 
0070 <span class="comment">% about 200 trials seems to be our limit here...</span>
0071 
0072 ntapers=[];
0073 beta=1.5; <span class="comment">% parameter for z-transforming coherence</span>
0074 freq_range=[300]; <span class="comment">% let's just refilter</span>
0075 lfp_fs=25e3; <span class="comment">% default Intan sampling rate</span>
0076 trial_range=[];
0077 medfilt_scale=1.5; <span class="comment">% median filter scale (in ms)</span>
0078 alpha=.001; <span class="comment">% alpha for null hypothesis line</span>
0079 
0080 <span class="keyword">if</span> mod(nparams,2)&gt;0
0081     error(<span class="string">'Parameters must be specified as parameter/value pairs'</span>);
0082 <span class="keyword">end</span>
0083 
0084 <span class="keyword">for</span> i=1:2:nparams
0085     <span class="keyword">switch</span> lower(varargin{i})
0086         <span class="keyword">case</span> <span class="string">'filedir'</span>
0087             filedir=varargin{i+1};
0088         <span class="keyword">case</span> <span class="string">'dir'</span>
0089             dir=varargin{i+1};
0090         <span class="keyword">case</span> <span class="string">'lfp_winextract'</span>
0091             lfp_winextract=varargin{i+1};
0092         <span class="keyword">case</span> <span class="string">'debug'</span>
0093             debug=varargin{i+1};
0094         <span class="keyword">case</span> <span class="string">'peakedges'</span>
0095             peakedges=varargin{i+1};
0096         <span class="keyword">case</span> <span class="string">'troughedges'</span>
0097             troughedges=varargin{i+1};
0098         <span class="keyword">case</span> <span class="string">'nfft'</span>
0099             nfft=varargin{i+1};
0100         <span class="keyword">case</span> <span class="string">'freq_range'</span>
0101             freq_range=varargin{i+1};
0102         <span class="keyword">case</span> <span class="string">'trial_range'</span>
0103             trial_range=varargin{i+1};
0104         <span class="keyword">case</span> <span class="string">'medfilt_scale'</span>
0105             medfilt_scale=varargin{i+1};
0106         <span class="keyword">case</span> <span class="string">'alpha'</span>
0107             alpha=varargin{i+1};
0108 
0109     <span class="keyword">end</span>
0110 <span class="keyword">end</span>
0111 
0112 
0113 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0114 
0115 
0116 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DATA COLLECTION %%%%%%%%%%%%%%%%%%%%</span>
0117 
0118 
0119 sua_mat=fullfile(filedir,<span class="string">'sua'</span>,[<span class="string">'sua_channels '</span> num2str(SUCHANNEL) <span class="string">'.mat'</span>]);
0120 
0121 load(fullfile(filedir,<span class="string">'aggregated_data.mat'</span>),<span class="string">'CHANNELS'</span>,<span class="string">'EPHYS_DATA'</span>); <span class="comment">% get the channel map and LFPs</span>
0122 load(sua_mat,<span class="string">'smooth_spikes'</span>,<span class="string">'clust_spike_vec'</span>,<span class="string">'subtrials'</span>); <span class="comment">% smooth spikes</span>
0123 
0124 lfp_data=<a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>(EPHYS_DATA,CHANNELS,LFPCHANNEL);
0125 clear EPHYS_DATA;
0126 lfp_data=<a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>(lfp_data,<span class="string">'l'</span>,<span class="string">'freq_range'</span>,freq_range,<span class="string">'medfilt_scale'</span>,medfilt_scale);
0127 lfp_data=squeeze(lfp_data);
0128 spike_data=clust_spike_vec{1}{SUCLUSTER}; 
0129 
0130 lfp_data=lfp_data(:,subtrials);
0131 spike_data=clust_spike_vec{1}{SUCLUSTER}; 
0132 
0133 [samples,trials]=size(lfp_data);
0134 lfp_data=lfp_data';
0135 <span class="comment">% bin the spikes</span>
0136 
0137 binspike_data=zeros(trials,samples,<span class="string">'double'</span>);
0138 
0139 
0140 <span class="keyword">if</span> isempty(nfft)
0141     nfft=max([samples 2^nextpow2(samples)]);
0142 <span class="keyword">else</span>
0143     nfft=2^nextpow2(nfft);
0144 <span class="keyword">end</span>
0145 
0146 <span class="keyword">if</span> isempty(ntapers)
0147     ntapers=2*(w)-1;
0148 <span class="keyword">end</span>
0149 
0150 resolution=w*1/(samples/lfp_fs);
0151 disp([<span class="string">'Resolution:  '</span> num2str(resolution)  <span class="string">' Hz'</span>]);
0152 disp([<span class="string">'NFFT:  '</span> num2str(nfft)]);
0153 
0154 <span class="comment">% take the average spectra to compute our cross spectrum</span>
0155 
0156 <span class="comment">% normalize spectrum by samples and sampling rate</span>
0157 
0158 freqs=lfp_fs/2*linspace(0,1,nfft/2+1);
0159 
0160 <span class="comment">% smooth with multi-taper</span>
0161 
0162 [tapers,lambda]=dpss(samples,w,ntapers);
0163 
0164 <span class="comment">% pre allocate cell arrays to store taper and trial estimates</span>
0165 
0166 cross_spect_mean=zeros(1,nfft);
0167 lfp_spect_mean=zeros(1,nfft);
0168 spike_spect_mean=zeros(1,nfft);
0169 
0170 
0171 
0172 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0173 
0174 
0175 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% AVERAGE SPECTRA %%%%%%%%%%%%%%%%%%%%</span>
0176 
0177 
0178 
0179 <span class="keyword">for</span> i=1:trials
0180 
0181     spike_locs=round(spike_data{i}*lfp_fs);
0182 
0183     <span class="keyword">if</span> length(unique(spike_locs))&lt;length(spike_locs)
0184         error(<span class="string">'Error, multiple spikes in a single bin, try increasing SR'</span>);
0185     <span class="keyword">end</span>
0186 
0187     binspike_data(i,spike_locs)=1;
0188 
0189 <span class="keyword">end</span>
0190 
0191 
0192 parfor i=1:trials
0193 
0194     <span class="comment">% demean the data and compute the cross spectrum with the fields</span>
0195 
0196     currlfp=lfp_data(i,:)-mean(lfp_data(i,:));
0197     currspikes=binspike_data(i,:)-mean(binspike_data(i,:));
0198 
0199     <span class="comment">% multi-taper estimate</span>
0200     <span class="comment">% index by trial and taper, then we can estimate jackknife error bars</span>
0201 
0202     
0203     cross_spect_mean_tmp=zeros(1,nfft);
0204     lfp_spect_mean_tmp=zeros(1,nfft);
0205     spike_spect_mean_tmp=zeros(1,nfft);
0206 
0207     <span class="keyword">for</span> j=1:ntapers
0208 
0209         spectlfp=fft(currlfp.*tapers(:,j)',nfft);
0210         spectspikes=fft(currspikes.*tapers(:,j)',nfft);
0211 
0212         cross_power=(spectlfp.*conj(spectspikes))./(samples*lfp_fs);
0213 
0214         lfp_power=(abs(spectlfp).^2)./(samples*lfp_fs);
0215         spike_power=(abs(spectspikes).^2)./(samples*lfp_fs);
0216 
0217         <span class="comment">% average across tapers, store across trials and just jackknife across trials</span>
0218 
0219         cross_spect_mean_tmp=cross_spect_mean_tmp+cross_power./(ntapers);
0220         lfp_spect_mean_tmp=lfp_spect_mean_tmp+lfp_power./(ntapers);
0221         spike_spect_mean_tmp=spike_spect_mean_tmp+spike_power./(ntapers);
0222     <span class="keyword">end</span>
0223 
0224     cross_spect_mean=cross_spect_mean+cross_spect_mean_tmp./(trials);
0225     lfp_spect_mean=lfp_spect_mean+lfp_spect_mean_tmp./(trials);
0226     spike_spect_mean=spike_spect_mean+spike_spect_mean_tmp./(trials);
0227 
0228 
0229 <span class="keyword">end</span>
0230 
0231 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0232 
0233 
0234 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% STATS %%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0235 
0236 
0237 
0238 dof=ntapers*trials;
0239 
0240 coh=cross_spect_mean./sqrt(lfp_spect_mean.*spike_spect_mean);
0241 abscoh=abs(coh);
0242 
0243 <span class="comment">% asymptotic errorbars</span>
0244 
0245 abscoh=abscoh(1:nfft/2+1);
0246 
0247 <span class="comment">% take the range that we're interested in</span>
0248 
0249 startidx=max([find(freqs&lt;=min_f)]);
0250 
0251 <span class="keyword">if</span> isempty(startidx)
0252     startidx=1;
0253 <span class="keyword">end</span>
0254 
0255 stopidx=min([find(freqs&gt;=max_f)]);
0256 
0257 abscoh=abscoh(startidx:stopidx);
0258 freqs=freqs(startidx:stopidx);
0259 
0260 m_coherence_err=1.96./(sqrt(dof));
0261 m_coherence_null=sqrt(1-alpha^(1/(dof/2-1)));
0262 
0263 upperconf=abscoh+m_coherence_err;
0264 lowerconf=abscoh-m_coherence_err;
0265 
0266 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0267 
0268 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PLOTTING CODE %%%%%%%%%%%%%%%%%%%%%%</span>
0269 
0270 
0271 
0272 <span class="comment">% save plots, data and parameters</span>
0273 
0274 [path,name,ext]=fileparts(savedir);
0275 savedir=fullfile(savedir,<span class="string">'coherence'</span>);
0276 
0277 <span class="keyword">if</span> ~exist(savedir,<span class="string">'dir'</span>)
0278     mkdir(savedir);
0279 <span class="keyword">end</span>
0280 
0281 savefilename=[ name <span class="string">'_coherence_lfpch'</span><span class="keyword">...</span>
0282            num2str(LFPCHANNEL) <span class="string">'_such'</span> num2str(SUCHANNEL) <span class="string">'_cl '</span> num2str(SUCLUSTER)];
0283 
0284 <span class="comment">% construct patch vectors</span>
0285 
0286 xdata=[freqs fliplr(freqs)];
0287 ydata=[lowerconf fliplr(upperconf)];
0288 
0289 spect_fig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>,<span class="string">'Position'</span>,[0 0 800 600]);
0290 hold on;
0291 patch(xdata,ydata,1,<span class="string">'facecolor'</span>,[.52 .81 .93],<span class="string">'edgecolor'</span>,<span class="string">'none'</span>);
0292 h(1)=plot(freqs,abscoh,<span class="string">'-'</span>,<span class="string">'color'</span>,[0 0 1],<span class="string">'linewidth'</span>,1.25);
0293 h(2)=plot(freqs,ones(size(abscoh)).*m_coherence_null,<span class="string">'k--'</span>,<span class="string">'linewidth'</span>,1.25);
0294 set(gca,<span class="string">'TickDir'</span>,<span class="string">'out'</span>,<span class="string">'TickLength'</span>,[.02 .02],<span class="string">'layer'</span>,<span class="string">'top'</span>);
0295 axis tight
0296 box off
0297 
0298 l=legend(h,<span class="string">'Coh.'</span>,[<span class="string">'p='</span> num2str(alpha)]);
0299 
0300 xlabel(<span class="string">'Fs (Hz)'</span>);
0301 ylabel(<span class="string">'Coherence'</span>);
0302 title({[<span class="string">'LFP Ch. '</span> num2str(LFPCHANNEL) <span class="string">' SU Ch. '</span> num2str(SUCHANNEL) <span class="string">'cl'</span> num2str(SUCLUSTER) <span class="keyword">...</span>
0303     <span class="string">' NTapers '</span> num2str(ntapers)' <span class="string">' trials '</span> num2str(trials) <span class="string">' res. '</span> num2str(resolution) <span class="string">' Hz '</span>]})
0304 <a href="../ephys/helpers/visualization/prettify_axislabels.html" class="code" title="function prettify_axislabels(FIGHANDLE,varargin)">prettify_axislabels</a>(spect_fig);
0305 
0306 <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(spect_fig,savedir,savefilename,<span class="string">'eps,png'</span>);
0307 
0308 save(fullfile(savedir,[ savefilename <span class="string">'.mat'</span>]),<span class="string">'m_coherence_err'</span>,<span class="string">'m_coherence_null'</span>,<span class="string">'alpha'</span>,<span class="string">'coh'</span>,<span class="string">'abscoh'</span>,<span class="string">'freqs'</span>,<span class="string">'nfft'</span>,<span class="string">'samples'</span>,<span class="string">'ntapers'</span>,<span class="string">'w'</span>);
0309 
0310 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0311</pre></div>
<hr><address>Generated on Sun 22-Jul-2012 12:37:58 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>