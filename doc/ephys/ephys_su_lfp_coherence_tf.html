<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ephys_su_lfp_coherence_tf</title>
  <meta name="keywords" content="ephys_su_lfp_coherence_tf">
  <meta name="description" content="computes coherograms between LFPs and single units">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../menu.html">Home</a> &gt;  <a href="menu.html">ephys</a> &gt; ephys_su_lfp_coherence_tf.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../menu.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for ephys&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>ephys_su_lfp_coherence_tf
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>computes coherograms between LFPs and single units</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [abscoh,t,f]=ephys_su_lfp_coherence_tf(LFPCHANNEL,SUCHANNEL,SUCLUSTER,HISTOGRAM,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">computes coherograms between LFPs and single units

    [abscoh,t,f]=ephys_su_lfp_coherence_tf(LFPCHANNEL,SUCHANNEL,SUCLUSTER,HISTOGRAM,varargin)
    
    LFPCHANNEL
    LFPCHANNEL to use

    SUCHANNEL
    channel with single units (already clustered and saved in 'sua')

    SUCLUSTER
    number of cluster with single unit

    HISTOGRAM
    time frequency histogram structure (result of ephys_visual_histogram or loading histogram.mat)

    the following may be passed as parameter/value pairs:

        savedir
        directory to save results in (default: 'coherence')

        filedir
        directory that contains the single-unit data and LFP subdirectory (default: 'pwd')

        colors
        colormap for coherence graph (default: 'jet')
        
        n
        spectrogram window length (default: 6.25e3 samples)
        
        nfft
        spectrogram nfft (default: 10e3 samples)

        overlap
        spectrogram overlap (default: 6e3 samples)
        
        min_f
        minimum frequency to display (default: 10)
        
        max_f
        maximum frequency to display (default: 100)

        w
        time-bandwidth product (default: 3)

        ntapers
        number of tapers to use (default: 2*w-1)

        freq_range
        frequency range for LFP filtering (default: 300)

        lfp_fs
        lfp sampling rate (default: 25e3)

        trial_range
        only compute the coherence for these trials (leave blank for all, default: [])

        medfilt_scale
        median filter timescale in ms (default: 1.5)

        nphasebins
        number of phase bins for amplitude-weighted frequency/phase 2D histogram (default: 50)

 see also ephys_visual_histogra.m,<a href="ephys_su_lfp_coherence_spect.html" class="code" title="function ephys_su_lfp_coherence_spect(LFPCHANNEL,SUCHANNEL,SUCLUSTER,varargin)">ephys_su_lfp_coherence_spect</a>.m</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>	conditions signals for further processing</li><li><a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>	takes ephys data from Intan recordings and re-references</li><li><a href="../ephys/helpers/stats/spect_ztrans.html" class="code" title="function zval=spect_ztrans(data,beta,dof)">spect_ztrans</a>	z-transform for coherence measures</li><li><a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>	save in multiple formats in a single command</li><li><a href="../ephys/helpers/visualization/prettify_axis.html" class="code" title="function prettify_axis(FIGHANDLE,varargin)">prettify_axis</a>	changes axis to look sensible</li><li><a href="../ephys/helpers/visualization/prettify_axislabels.html" class="code" title="function prettify_axislabels(FIGHANDLE,varargin)">prettify_axislabels</a>	makes axis labels sensible</li><li><a href="../ephys/helpers/visualization/time_frequency_raster.html" class="code" title="function fig_num=time_frequency_raster(HISTOGRAM,TFIMAGE,varargin)">time_frequency_raster</a>	time frequency raster plots</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [abscoh,t,f]=ephys_su_lfp_coherence_tf(LFPCHANNEL,SUCHANNEL,SUCLUSTER,HISTOGRAM,varargin)</a>
0002 <span class="comment">%computes coherograms between LFPs and single units</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%    [abscoh,t,f]=ephys_su_lfp_coherence_tf(LFPCHANNEL,SUCHANNEL,SUCLUSTER,HISTOGRAM,varargin)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%    LFPCHANNEL</span>
0007 <span class="comment">%    LFPCHANNEL to use</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%    SUCHANNEL</span>
0010 <span class="comment">%    channel with single units (already clustered and saved in 'sua')</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%    SUCLUSTER</span>
0013 <span class="comment">%    number of cluster with single unit</span>
0014 <span class="comment">%</span>
0015 <span class="comment">%    HISTOGRAM</span>
0016 <span class="comment">%    time frequency histogram structure (result of ephys_visual_histogram or loading histogram.mat)</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%    the following may be passed as parameter/value pairs:</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%        savedir</span>
0021 <span class="comment">%        directory to save results in (default: 'coherence')</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%        filedir</span>
0024 <span class="comment">%        directory that contains the single-unit data and LFP subdirectory (default: 'pwd')</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%        colors</span>
0027 <span class="comment">%        colormap for coherence graph (default: 'jet')</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%        n</span>
0030 <span class="comment">%        spectrogram window length (default: 6.25e3 samples)</span>
0031 <span class="comment">%</span>
0032 <span class="comment">%        nfft</span>
0033 <span class="comment">%        spectrogram nfft (default: 10e3 samples)</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%        overlap</span>
0036 <span class="comment">%        spectrogram overlap (default: 6e3 samples)</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%        min_f</span>
0039 <span class="comment">%        minimum frequency to display (default: 10)</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%        max_f</span>
0042 <span class="comment">%        maximum frequency to display (default: 100)</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%        w</span>
0045 <span class="comment">%        time-bandwidth product (default: 3)</span>
0046 <span class="comment">%</span>
0047 <span class="comment">%        ntapers</span>
0048 <span class="comment">%        number of tapers to use (default: 2*w-1)</span>
0049 <span class="comment">%</span>
0050 <span class="comment">%        freq_range</span>
0051 <span class="comment">%        frequency range for LFP filtering (default: 300)</span>
0052 <span class="comment">%</span>
0053 <span class="comment">%        lfp_fs</span>
0054 <span class="comment">%        lfp sampling rate (default: 25e3)</span>
0055 <span class="comment">%</span>
0056 <span class="comment">%        trial_range</span>
0057 <span class="comment">%        only compute the coherence for these trials (leave blank for all, default: [])</span>
0058 <span class="comment">%</span>
0059 <span class="comment">%        medfilt_scale</span>
0060 <span class="comment">%        median filter timescale in ms (default: 1.5)</span>
0061 <span class="comment">%</span>
0062 <span class="comment">%        nphasebins</span>
0063 <span class="comment">%        number of phase bins for amplitude-weighted frequency/phase 2D histogram (default: 50)</span>
0064 <span class="comment">%</span>
0065 <span class="comment">% see also ephys_visual_histogra.m,ephys_su_lfp_coherence_spect.m</span>
0066 
0067 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PARAMETER COLLECTION %%%%%%%%%%%%%%%%%</span>
0068 
0069 
0070 nparams=length(varargin);
0071 
0072 savedir=pwd;
0073 filedir=pwd;
0074 fig_title=<span class="string">'noname'</span>;
0075 colors=<span class="string">'jet'</span>;
0076 phasecolors=<span class="string">'hsv'</span>;
0077 debug=0;
0078 nfft=10000;
0079 n=6250;
0080 overlap=6000;
0081 min_f=15;
0082 max_f=100;
0083 w=2.5;
0084 alpha=.001;
0085 
0086 ntapers=[];
0087 beta=1.5; <span class="comment">% parameter for z-transforming coherence</span>
0088 freq_range=[300]; <span class="comment">% let's just refilter</span>
0089 lfp_fs=25e3; <span class="comment">% default Intan sampling rate</span>
0090 trial_range=[];
0091 medfilt_scale=1.5; <span class="comment">% median filter scale (in ms)</span>
0092 nphasebins=50;
0093 
0094 <span class="keyword">if</span> mod(nparams,2)&gt;0
0095     error(<span class="string">'Parameters must be specified as parameter/value pairs'</span>);
0096 <span class="keyword">end</span>
0097 
0098 <span class="keyword">for</span> i=1:2:nparams
0099     <span class="keyword">switch</span> lower(varargin{i})
0100         <span class="keyword">case</span> <span class="string">'filedir'</span>
0101             filedir=varargin{i+1};
0102         <span class="keyword">case</span> <span class="string">'savedir'</span>
0103             savedir=varargin{i+1};
0104         <span class="keyword">case</span> <span class="string">'fig_title'</span>
0105             fig_title=varargin{i+1};
0106         <span class="keyword">case</span> <span class="string">'nfft'</span>
0107             nfft=varargin{i+1};
0108         <span class="keyword">case</span> <span class="string">'n'</span>
0109             n=varargin{i+1};
0110         <span class="keyword">case</span> <span class="string">'min_f'</span>
0111             min_f=varargin{i+1};
0112         <span class="keyword">case</span> <span class="string">'freq_range'</span>
0113             freq_range=varargin{i+1};
0114         <span class="keyword">case</span> <span class="string">'trial_range'</span>
0115             trial_range=varargin{i+1};
0116         <span class="keyword">case</span> <span class="string">'nphasebins'</span>
0117             nphasebins=varargin{i+1};
0118 
0119     <span class="keyword">end</span>
0120 <span class="keyword">end</span>
0121 
0122 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0123 
0124 <span class="keyword">if</span> isempty(nfft)
0125     nfft=max([n 2^nextpow2(n)]);
0126 <span class="keyword">else</span>
0127     nfft=2^nextpow2(nfft);
0128 <span class="keyword">end</span>
0129 
0130 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DATA COLLECTION %%%%%%%%%%%%%%%%%%%%</span>
0131 
0132 resolution=w*1/(n/lfp_fs);
0133 disp([<span class="string">'Resolution:  '</span> num2str(resolution)  <span class="string">' Hz'</span>]);
0134 disp([<span class="string">'NFFT:  '</span> num2str(nfft)]);
0135 
0136 <span class="comment">% where to grab the files from?</span>
0137 
0138 savename=[ fig_title <span class="string">'_lfpch_'</span> num2str(LFPCHANNEL) <span class="string">'_such'</span> num2str(SUCHANNEL) <span class="string">'_clust'</span> num2str(SUCLUSTER)];
0139 sua_mat=fullfile(filedir,<span class="string">'sua'</span>,[<span class="string">'sua_channels '</span> num2str(SUCHANNEL) <span class="string">'.mat'</span>]);
0140 
0141 load(fullfile(filedir,<span class="string">'aggregated_data.mat'</span>),<span class="string">'CHANNELS'</span>,<span class="string">'EPHYS_DATA'</span>); <span class="comment">% get the channel map and LFPs</span>
0142 load(sua_mat,<span class="string">'smooth_spikes'</span>,<span class="string">'clust_spike_vec'</span>,<span class="string">'subtrials'</span>); <span class="comment">% smooth spikes</span>
0143 
0144 <span class="comment">%lfp_data=double(EPHYS_DATA(:,:,CHANNELS==LFPCHANNEL));</span>
0145 
0146 lfp_data=<a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>(EPHYS_DATA,CHANNELS,LFPCHANNEL);
0147 clear EPHYS_DATA;
0148 lfp_data=<a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>(lfp_data,<span class="string">'l'</span>,<span class="string">'freq_range'</span>,freq_range,<span class="string">'medfilt_scale'</span>,medfilt_scale);
0149 lfp_data=squeeze(lfp_data);
0150 
0151 <span class="comment">% need to account for subset of trials if used in single unit data</span>
0152 
0153 lfp_data=lfp_data(:,subtrials);
0154 spike_data=clust_spike_vec{1}{SUCLUSTER}; 
0155 
0156 <span class="keyword">if</span> ~isempty(trial_range)
0157     disp([<span class="string">'Truncating trials to '</span> num2str([trial_range(1) trial_range(end)])]);
0158     lfp_data=lfp_data(:,trial_range);
0159     spike_data=spike_data(trial_range);
0160 <span class="keyword">end</span>
0161 
0162 [nsamples,ntrials]=size(lfp_data);
0163 lfp_data=lfp_data';
0164 
0165 <span class="keyword">if</span> n&gt;nsamples
0166     difference=n-overlap;
0167     n=round(nsamples/5);
0168     overlap=n-difference;
0169     disp(<span class="string">'Reset window size and overlap, longer than nsamples'</span>);
0170     disp([<span class="string">'Window size:  '</span> num2str(n) <span class="string">' samples'</span>]);
0171     disp([<span class="string">'Overlap:  '</span> num2str(overlap) <span class="string">' samples'</span>]);
0172 <span class="keyword">end</span>
0173 
0174 <span class="comment">% filter the lfp_data</span>
0175 
0176 <span class="comment">% pre-allocate the binned spike matrix, specify at a high enough</span>
0177 <span class="comment">% fs so that we don't add multiple spikes to a given bin, sampling</span>
0178 <span class="comment">% rate of LFP should be more than sufficient (25e3 for Intan)</span>
0179 
0180 binspike_data=zeros(ntrials,nsamples,<span class="string">'double'</span>);
0181 
0182 <span class="comment">% smooth with multi-taper</span>
0183 
0184 <span class="keyword">if</span> isempty(ntapers)
0185     ntapers=2*(w)-1;
0186 <span class="keyword">end</span>
0187 
0188 <span class="comment">% the degrees of freedom for determining significance, tapers*trials</span>
0189 
0190 dof=ntapers*ntrials;
0191 [tapers,lambda]=dpss(n,w,ntapers);
0192 
0193 <span class="comment">%figure();plot(tapers);</span>
0194 <span class="comment">% pre allocate cell arrays to store taper and trial estimates</span>
0195 
0196 <span class="comment">% number of rows and columns in the spectrogram</span>
0197 
0198 <span class="keyword">if</span> mod(nfft,2)==0
0199     rows=(nfft/2+1);
0200 <span class="keyword">else</span>
0201     rows=(nfft+1)/2;
0202 <span class="keyword">end</span>
0203 
0204 columns=fix((nsamples-overlap)/(n-overlap));
0205 
0206 <span class="comment">% axes</span>
0207 
0208 f=((1:rows)./rows).*(lfp_fs/2);
0209 col_idx=1+(0:(columns-1))*(n-overlap);
0210 t=((col_idx-1)+((n/2)'))/lfp_fs;
0211 
0212 startidx=max([find(f&lt;=min_f)]);
0213 
0214 <span class="keyword">if</span> isempty(startidx)
0215     startidx=1;
0216 <span class="keyword">end</span>
0217 
0218 stopidx=min([find(f&gt;=max_f)]);
0219 
0220 <span class="comment">% pre-allocate matrices</span>
0221 
0222 cross_spect_mean=zeros(rows,columns);
0223 lfp_spect_mean=zeros(rows,columns);
0224 spike_spect_mean=zeros(rows,columns);
0225 
0226 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0227 
0228 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% AVERAGE SPECTRA %%%%%%%%%%%%%%%%%%%%</span>
0229 
0230 <span class="comment">% bin spikes at the same SR as the fields</span>
0231 
0232 disp(<span class="string">'Binning spikes...'</span>);
0233 
0234 <span class="keyword">for</span> i=1:ntrials
0235 
0236     spike_locs=round(spike_data{i}*lfp_fs);
0237 
0238     <span class="keyword">if</span> length(unique(spike_locs))&lt;length(spike_locs)
0239         error(<span class="string">'Error, multiple spikes in a single bin, try increasing SR'</span>);
0240     <span class="keyword">end</span>
0241 
0242     binspike_data(i,spike_locs)=1;
0243 
0244 <span class="keyword">end</span>
0245 
0246 disp(<span class="string">'Computing spectra'</span>);
0247 
0248 parfor i=1:ntrials
0249 
0250     disp([<span class="string">'Trial '</span> num2str(i)]);
0251 
0252     currlfp=lfp_data(i,:);
0253     currspikes=binspike_data(i,:)-mean(binspike_data(i,:));
0254 
0255     <span class="comment">% spectra</span>
0256 
0257     <span class="comment">% multi-taper estimate</span>
0258 
0259     <span class="comment">% accumulate across tapers to cut down compt time, then we can use parfor</span>
0260 
0261     cross_spect_tmp=zeros(rows,columns);
0262     lfp_spect_tmp=zeros(rows,columns);
0263     spike_spect_tmp=zeros(rows,columns);
0264 
0265     <span class="keyword">for</span> j=1:ntapers
0266 
0267         spectlfp=spectrogram(currlfp,tapers(:,j)',overlap,nfft);
0268         spectspikes=spectrogram(currspikes,tapers(:,j)',overlap,nfft);
0269 
0270         <span class="comment">% take absolute value of the cross power after trial and taper</span>
0271         <span class="comment">% averaging</span>
0272 
0273         cross_power=(spectlfp.*conj(spectspikes))./(nsamples*lfp_fs);
0274 
0275         <span class="comment">% take power of the field and spikes</span>
0276 
0277         lfp_power=(abs(spectlfp).^2)./(nsamples*lfp_fs);
0278         spike_power=(abs(spectspikes).^2)./(nsamples*lfp_fs);
0279 
0280         <span class="comment">% average across tapers</span>
0281 
0282         cross_spect_tmp=cross_spect_tmp+cross_power./(ntapers);
0283         lfp_spect_tmp=lfp_spect_tmp+lfp_power./(ntapers);
0284         spike_spect_tmp=spike_spect_tmp+spike_power./(ntapers);
0285     <span class="keyword">end</span>
0286 
0287     <span class="comment">% average across trials</span>
0288 
0289     cross_spect_mean=cross_spect_mean+cross_spect_tmp./ntrials;
0290     lfp_spect_mean=lfp_spect_mean+lfp_spect_tmp./ntrials;
0291     spike_spect_mean=spike_spect_mean+spike_spect_tmp./ntrials;
0292 
0293 <span class="keyword">end</span>
0294 
0295 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0296 
0297 
0298 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PLOTTING CODE %%%%%%%%%%%%%%%%%%%%%%</span>
0299 
0300 <span class="comment">% coherence is the absolute value of the cross spectrum over the power of the</span>
0301 <span class="comment">% the two spectra</span>
0302 
0303 coh=cross_spect_mean./sqrt(lfp_spect_mean.*spike_spect_mean);
0304 
0305 <span class="comment">% coherency</span>
0306 
0307 abscoh=abs(coh);
0308 
0309 <span class="comment">% phase, could plot over the abs value as quivers per Pesaran et al.</span>
0310 
0311 phasecoh=angle(coh);
0312 
0313 <span class="comment">% z-transformed coherence</span>
0314 
0315 zabscoh=<a href="../ephys/helpers/stats/spect_ztrans.html" class="code" title="function zval=spect_ztrans(data,beta,dof)">spect_ztrans</a>(abscoh,beta,dof);
0316 
0317 <span class="comment">% we can indicate significant points using the asymptotic values per Jarvis and Mitra (2001)</span>
0318 
0319 [path,name,ext]=fileparts(savedir);
0320 
0321 savedir=fullfile(savedir,<span class="string">'coherence'</span>);
0322 
0323 <span class="keyword">if</span> ~exist(savedir,<span class="string">'dir'</span>)
0324     mkdir(savedir);
0325 <span class="keyword">end</span>
0326 
0327 savefilename=[ name <span class="string">'_tfcoherence_lfpch'</span><span class="keyword">...</span>
0328            num2str(LFPCHANNEL) <span class="string">'_such'</span> num2str(SUCHANNEL) <span class="string">'_cl '</span> num2str(SUCLUSTER)];
0329 
0330 spect_fig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>,<span class="string">'position'</span>,[0 0 round(600*nsamples/lfp_fs) 800]);
0331 
0332 plotabscoh.image=abscoh;
0333 plotabscoh.t=t;
0334 plotabscoh.f=f;
0335 
0336 fig_title=[<span class="string">'LFPCH'</span> num2str(LFPCHANNEL) <span class="string">' SUCH'</span> num2str(SUCHANNEL)<span class="keyword">...</span>
0337            <span class="string">' SUCL'</span> num2str(SUCLUSTER) <span class="string">' NTAP'</span> num2str(ntapers) <span class="string">' RES '</span> num2str(resolution) <span class="string">' Hz'</span> <span class="string">' NTRIALS'</span> num2str(ntrials)];
0338 
0339 <a href="../ephys/helpers/visualization/time_frequency_raster.html" class="code" title="function fig_num=time_frequency_raster(HISTOGRAM,TFIMAGE,varargin)">time_frequency_raster</a>(HISTOGRAM,plotabscoh,<span class="string">'tf_min_f'</span>,min_f,<span class="string">'tf_max_f'</span>,max_f,<span class="string">'scale'</span>,<span class="string">'linear'</span>,<span class="keyword">...</span>
0340     <span class="string">'fig_num'</span>,spect_fig,<span class="string">'scalelabel'</span>,<span class="string">'Coherence'</span>,<span class="string">'fig_title'</span>,fig_title,<span class="string">'tfimage_colors'</span>,colors);
0341 
0342 set(spect_fig,<span class="string">'PaperPositionMode'</span>,<span class="string">'auto'</span>);
0343 <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(spect_fig,savedir,savefilename,<span class="string">'eps,png'</span>,<span class="string">'renderer'</span>,<span class="string">'painters'</span>);
0344 close([spect_fig]);
0345 
0346 <span class="comment">% also show phase angle</span>
0347 
0348 phase_fig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>,<span class="string">'position'</span>,[0 0 round(600*nsamples/lfp_fs) 800]);
0349 
0350 plotabscoh.image=phasecoh;
0351 
0352 <span class="comment">% plot phase with HSV</span>
0353 
0354 <a href="../ephys/helpers/visualization/time_frequency_raster.html" class="code" title="function fig_num=time_frequency_raster(HISTOGRAM,TFIMAGE,varargin)">time_frequency_raster</a>(HISTOGRAM,plotabscoh,<span class="string">'tf_min_f'</span>,min_f,<span class="string">'tf_max_f'</span>,max_f,<span class="string">'scale'</span>,<span class="string">'linear'</span>,<span class="keyword">...</span>
0355     <span class="string">'fig_num'</span>,phase_fig,<span class="string">'scalelabel'</span>,<span class="string">'Phase'</span>,<span class="string">'fig_title'</span>,fig_title,<span class="string">'tfimage_colors'</span>,phasecolors);
0356 
0357 set(phase_fig,<span class="string">'PaperPositionMode'</span>,<span class="string">'auto'</span>);
0358 <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(phase_fig,savedir,[savefilename <span class="string">'_phase'</span> ],<span class="string">'eps,png'</span>,<span class="string">'renderer'</span>,<span class="string">'painters'</span>);
0359 close([phase_fig]);
0360 
0361 <span class="comment">% bin the phase angle at each frequency bin, maybe ten bins to start</span>
0362 
0363 phase_edges=linspace(-pi,pi,nphasebins);
0364 startidx=max([find(f&lt;=min_f)]);
0365 
0366 <span class="keyword">if</span> isempty(startidx)
0367     startidx=1;
0368 <span class="keyword">end</span>
0369 
0370 <span class="comment">%</span>
0371 <span class="comment">%</span>
0372 stopidx=min([find(f&gt;=max_f)]);
0373 
0374 <span class="comment">% now bin at the frequencies we're interested in</span>
0375 
0376 fvec=startidx:stopidx;
0377 amp_weighted_histogram=zeros(length(fvec),length(phase_edges));
0378 
0379 <span class="keyword">for</span> i=1:length(fvec)
0380 
0381     [density,phasebins]=histc(phasecoh(fvec(i),:),phase_edges);
0382 
0383     <span class="comment">% take the amplitude for each bin</span>
0384 
0385     <span class="keyword">for</span> j=1:length(phase_edges)
0386         
0387         <span class="comment">% where are points that are in this bin?</span>
0388 
0389         currpoints=find(phasebins==j);
0390         amp_weighted_histogram(i,j)=sum(abscoh(fvec(i),currpoints));
0391 
0392     <span class="keyword">end</span>
0393 
0394 <span class="keyword">end</span>
0395 
0396 amp_fig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>,<span class="string">'position'</span>,[0 0 800 600]);
0397 imagesc(phase_edges(1:end-1),f(fvec),amp_weighted_histogram(:,1:end-1));
0398 axis xy
0399 colormap(hot)
0400 ylabel(<span class="string">'Fs (Hz)'</span>);
0401 xlabel(<span class="string">'Phase (rad)'</span>);
0402 box off
0403 <a href="../ephys/helpers/visualization/prettify_axis.html" class="code" title="function prettify_axis(FIGHANDLE,varargin)">prettify_axis</a>(amp_fig,<span class="string">'ticklength'</span>,[.02 .02],<span class="string">'fontsize'</span>,13,<span class="string">'font'</span>,<span class="string">'helvetica'</span>,<span class="string">'linewidth'</span>,3);
0404 <a href="../ephys/helpers/visualization/prettify_axislabels.html" class="code" title="function prettify_axislabels(FIGHANDLE,varargin)">prettify_axislabels</a>(amp_fig,<span class="string">'fontsize'</span>,15,<span class="string">'font'</span>,<span class="string">'helvetica'</span>);
0405 
0406 
0407 pos=get(gca,<span class="string">'pos'</span>);
0408 set(gca,<span class="string">'pos'</span>,[pos(1) pos(2) pos(3)*.95 pos(4)]);
0409 pos=get(gca,<span class="string">'pos'</span>);
0410 hc2=colorbar(<span class="string">'location'</span>,<span class="string">'eastoutside'</span>,<span class="string">'position'</span>,[pos(1)+pos(3)+.01 pos(2)+pos(4)/2 .02 pos(4)/2]);
0411 set(hc2,<span class="string">'linewidth'</span>,2,<span class="string">'FontSize'</span>,12,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0412 ylabel(hc2,<span class="string">'sum(abs(coherence))'</span>,<span class="string">'FontSize'</span>,15,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0413 <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(amp_fig,savedir,[savefilename <span class="string">'_cohweightedphase'</span> ],<span class="string">'eps,png'</span>);
0414 close([amp_fig]);
0415 
0416 <span class="comment">% plot the tapers as well</span>
0417 
0418 tapers_fig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>,<span class="string">'position'</span>,[0 0 800 600]);
0419 plot([1:n]./lfp_fs,tapers,<span class="string">'linewidth'</span>,1.25);
0420 title([<span class="string">'Tapers, n '</span> num2str(ntapers) <span class="string">' w '</span> num2str(w)])
0421 xlabel(<span class="string">'Time (s)'</span>);
0422 <a href="../ephys/helpers/visualization/prettify_axislabels.html" class="code" title="function prettify_axislabels(FIGHANDLE,varargin)">prettify_axislabels</a>(tapers_fig,<span class="string">'fontsize'</span>,15,<span class="string">'font'</span>,<span class="string">'Helvetica'</span>);
0423 <a href="../ephys/helpers/visualization/prettify_axis.html" class="code" title="function prettify_axis(FIGHANDLE,varargin)">prettify_axis</a>(tapers_fig,<span class="string">'ticklength'</span>,[.02 .02],<span class="string">'fontsize'</span>,14,<span class="string">'font'</span>,<span class="string">'helvetica'</span>,<span class="string">'linewidth'</span>,3);
0424 box off
0425 
0426 
0427 <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(tapers_fig,savedir,[savefilename <span class="string">'_tapers'</span> ],<span class="string">'eps,png'</span>);
0428 close([tapers_fig]);
0429 
0430 save(fullfile(savedir,[savefilename <span class="string">'.mat'</span>]),<span class="string">'coh'</span>,<span class="string">'t'</span>,<span class="string">'f'</span>,<span class="string">'fvec'</span>,<span class="string">'phase_edges'</span>,<span class="string">'tapers'</span>,<span class="string">'w'</span>,<span class="string">'ntapers'</span>,<span class="string">'n'</span>,<span class="string">'nfft'</span>,<span class="string">'overlap'</span>,<span class="string">'lfp_data'</span>,<span class="string">'binspike_data'</span>,<span class="string">'amp_weighted_histogram'</span>);
0431 
0432 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0433</pre></div>
<hr><address>Generated on Sun 22-Jul-2012 12:37:58 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>