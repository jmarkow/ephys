<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ephys_visual_lfp_tf</title>
  <meta name="keywords" content="ephys_visual_lfp_tf">
  <meta name="description" content="generates a song-aligned average spectrogram of the LFP">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../menu.html">Home</a> &gt;  <a href="menu.html">ephys</a> &gt; ephys_visual_lfp_tf.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../menu.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for ephys&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>ephys_visual_lfp_tf
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>generates a song-aligned average spectrogram of the LFP</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [SPECT_AVE]=ephys_visual_lfp_tf(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">generates a song-aligned average spectrogram of the LFP

    [LFP_RASTER TIME LABEL HISTOGRAM]=ephys_lfp_amp(MIC_DATA,EPHYS_DATA,CHANNELS,varargin)

    EPHYS_DATA
    aligned ephys data generated by ephys_cluster or in extracted_data/aggregated_data.mat
    (should be the variable ephys_data), the data should be a matrix of doubles that is 
    samples x trials x channels

    HISTOGRAM
    contour histogram returned by ephys_visual_histogram.m (or loaded from histogram.mat)

    CHANNELS
    channel labels (i.e. the channel that corresponds to a given element in the cell array
    ephys_data) from ephys_cluster.m or extracted_data/aggregated_data.mat

    the following may be specified as parameter/value pairs:

        car_exclude
        electrodes to exclude from noise estimate

        SR
        data sampling rate (default: 25e3)

        noise
        noise rejection method ('car' for common average 'nn' for nearest neighbor, or 'none',
        default: 'none')

        freq_range
        vector with two elements to specify the frequency range (one element specifies low pass, default: 300)

        savedir
        directory to store results (default: pwd)

        hist_min_f
        lowermost frequency to display for contour histogram (default: 1e3)

        hist_max_f
        uppermost frequency to display for contour histogram (default: 10e3)

        lfp_min_f
        lowermost frequency to display for contour histogram (default: 1)

        lfp_max_f
        uppermost frequency to display for contour histogram (default: 100)

        scale
        scale for LFP spectrogram amplitude (linear or log, default: log)

        lfp_colors
        colormap (string) for lfp data (default: jet)

        hist_colors
        colormap(string) for histogram (default: jet)

        medfilt_scale
        timescale for median filter (in ms, leave blank to skip, default: 1.5)

        method
        method for computing the LFP spectrogram ('raw' for single Hanning taper or 'mt' for 
        multi-taper using Slepian functions, default: mt)

        lfp_nfft
        nfft for lfp spectrogram (default: 10e3)

        lfp_n
        window size for lfp spectrogram (default: 6250)

        lfp_overlap
        overlap for lfp spectrogram (default: 6000)

        lfp_w
        bandwidth for multi-taper (default: 2)

        lfp_ntapers
        override default number of tapers (leave blank for default, default: 2*w-1)

        singletrials
        number of single trial spectrograms to plot

 see also <a href="ephys_visual_sua.html" class="code" title="function ephys_visual_sua(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)">ephys_visual_sua</a>.m,<a href="ephys_visual_lfp_amp.html" class="code" title="function [LFP_RASTER TIME LABEL HISTOGRAM]=ephys_lfp_amp(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)">ephys_visual_lfp_amp</a>.m,<a href="ephys_visual_mua.html" class="code" title="function [MUA TIME LABEL HISTOGRAM]=ephys_visual_mua(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)">ephys_visual_mua</a>.m</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>	conditions signals for further processing</li><li><a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>	takes ephys data from Intan recordings and re-references</li><li><a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>	save in multiple formats in a single command</li><li><a href="../ephys/helpers/visualization/time_frequency_raster.html" class="code" title="function fig_num=time_frequency_raster(HISTOGRAM,TFIMAGE,varargin)">time_frequency_raster</a>	time frequency raster plots</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../ephys/pipeline/ephys_pipeline_lfp_standalone.html" class="code" title="function ephys_lfp_standalone(PROCDIR,CONFIG)">ephys_pipeline_lfp_standalone</a>	</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function parsave(FILE,t,f,spect)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [SPECT_AVE]=ephys_visual_lfp_tf(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)</a>
0002 <span class="comment">%generates a song-aligned average spectrogram of the LFP</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%    [LFP_RASTER TIME LABEL HISTOGRAM]=ephys_lfp_amp(MIC_DATA,EPHYS_DATA,CHANNELS,varargin)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%    EPHYS_DATA</span>
0007 <span class="comment">%    aligned ephys data generated by ephys_cluster or in extracted_data/aggregated_data.mat</span>
0008 <span class="comment">%    (should be the variable ephys_data), the data should be a matrix of doubles that is</span>
0009 <span class="comment">%    samples x trials x channels</span>
0010 <span class="comment">%</span>
0011 <span class="comment">%    HISTOGRAM</span>
0012 <span class="comment">%    contour histogram returned by ephys_visual_histogram.m (or loaded from histogram.mat)</span>
0013 <span class="comment">%</span>
0014 <span class="comment">%    CHANNELS</span>
0015 <span class="comment">%    channel labels (i.e. the channel that corresponds to a given element in the cell array</span>
0016 <span class="comment">%    ephys_data) from ephys_cluster.m or extracted_data/aggregated_data.mat</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%    the following may be specified as parameter/value pairs:</span>
0019 <span class="comment">%</span>
0020 <span class="comment">%        car_exclude</span>
0021 <span class="comment">%        electrodes to exclude from noise estimate</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%        SR</span>
0024 <span class="comment">%        data sampling rate (default: 25e3)</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%        noise</span>
0027 <span class="comment">%        noise rejection method ('car' for common average 'nn' for nearest neighbor, or 'none',</span>
0028 <span class="comment">%        default: 'none')</span>
0029 <span class="comment">%</span>
0030 <span class="comment">%        freq_range</span>
0031 <span class="comment">%        vector with two elements to specify the frequency range (one element specifies low pass, default: 300)</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%        savedir</span>
0034 <span class="comment">%        directory to store results (default: pwd)</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%        hist_min_f</span>
0037 <span class="comment">%        lowermost frequency to display for contour histogram (default: 1e3)</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%        hist_max_f</span>
0040 <span class="comment">%        uppermost frequency to display for contour histogram (default: 10e3)</span>
0041 <span class="comment">%</span>
0042 <span class="comment">%        lfp_min_f</span>
0043 <span class="comment">%        lowermost frequency to display for contour histogram (default: 1)</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%        lfp_max_f</span>
0046 <span class="comment">%        uppermost frequency to display for contour histogram (default: 100)</span>
0047 <span class="comment">%</span>
0048 <span class="comment">%        scale</span>
0049 <span class="comment">%        scale for LFP spectrogram amplitude (linear or log, default: log)</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%        lfp_colors</span>
0052 <span class="comment">%        colormap (string) for lfp data (default: jet)</span>
0053 <span class="comment">%</span>
0054 <span class="comment">%        hist_colors</span>
0055 <span class="comment">%        colormap(string) for histogram (default: jet)</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%        medfilt_scale</span>
0058 <span class="comment">%        timescale for median filter (in ms, leave blank to skip, default: 1.5)</span>
0059 <span class="comment">%</span>
0060 <span class="comment">%        method</span>
0061 <span class="comment">%        method for computing the LFP spectrogram ('raw' for single Hanning taper or 'mt' for</span>
0062 <span class="comment">%        multi-taper using Slepian functions, default: mt)</span>
0063 <span class="comment">%</span>
0064 <span class="comment">%        lfp_nfft</span>
0065 <span class="comment">%        nfft for lfp spectrogram (default: 10e3)</span>
0066 <span class="comment">%</span>
0067 <span class="comment">%        lfp_n</span>
0068 <span class="comment">%        window size for lfp spectrogram (default: 6250)</span>
0069 <span class="comment">%</span>
0070 <span class="comment">%        lfp_overlap</span>
0071 <span class="comment">%        overlap for lfp spectrogram (default: 6000)</span>
0072 <span class="comment">%</span>
0073 <span class="comment">%        lfp_w</span>
0074 <span class="comment">%        bandwidth for multi-taper (default: 2)</span>
0075 <span class="comment">%</span>
0076 <span class="comment">%        lfp_ntapers</span>
0077 <span class="comment">%        override default number of tapers (leave blank for default, default: 2*w-1)</span>
0078 <span class="comment">%</span>
0079 <span class="comment">%        singletrials</span>
0080 <span class="comment">%        number of single trial spectrograms to plot</span>
0081 <span class="comment">%</span>
0082 <span class="comment">% see also ephys_visual_sua.m,ephys_visual_lfp_amp.m,ephys_visual_mua.m</span>
0083 
0084 
0085 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PARAMETER COLLECTION %%%%%%%%%%%%%%%%%</span>
0086 
0087 <span class="keyword">if</span> nargin&lt;2 | isempty(CHANNELS), CHANNELS=1:16; <span class="keyword">end</span>
0088 
0089 nparams=length(varargin);
0090 
0091 <span class="keyword">if</span> mod(nparams,2)&gt;0
0092     error(<span class="string">'Parameters must be specified as parameter/value pairs'</span>);
0093 <span class="keyword">end</span>
0094 
0095 
0096 SR=25e3;
0097 noise=<span class="string">'none'</span>; <span class="comment">% common-average reference for noise removal</span>
0098 car_exclude=[];
0099 savedir=pwd;
0100 hist_colors=<span class="string">'jet'</span>;
0101 lfp_colors=<span class="string">'jet'</span>;
0102 lfp_min_f=1; <span class="comment">% bring down to 1</span>
0103 lfp_max_f=100;
0104 lfp_n=6250;
0105 lfp_overlap=6000;
0106 lfp_nfft=10000; <span class="comment">% we want bins on the order</span>
0107 lfp_w=2; <span class="comment">% time bandwidth product if using multi-taper</span>
0108 lfp_ntapers=[]; <span class="comment">% number of tapers, leave blank to use 2*nw-1</span>
0109 
0110 hist_min_f=1e3;
0111 hist_max_f=10e3;
0112 
0113 figtitle=[];
0114 freq_range=[300]; <span class="comment">% frequency range for filtering</span>
0115 channels=CHANNELS;
0116 method=<span class="string">'mt'</span>; <span class="comment">% raw or mt for multi-taper</span>
0117 scale=<span class="string">'log'</span>;
0118 scalelabel=<span class="string">'dB'</span>;
0119 singletrials=5;
0120 medfilt_scale=1.5; <span class="comment">% median filter scale (in ms)</span>
0121 
0122 <span class="keyword">for</span> i=1:2:nparams
0123     <span class="keyword">switch</span> lower(varargin{i})
0124         <span class="keyword">case</span> <span class="string">'sr'</span>
0125             SR=varargin{i+1};
0126         <span class="keyword">case</span> <span class="string">'savedir'</span>
0127             savedir=varargin{i+1};
0128         <span class="keyword">case</span> <span class="string">'hist_colors'</span>
0129             hist_colors=varargin{i+1};
0130         <span class="keyword">case</span> <span class="string">'car_exclude'</span>
0131             car_exclude=varargin{i+1};
0132         <span class="keyword">case</span> <span class="string">'figtitle'</span>
0133             figtitle=varargin{i+1};
0134         <span class="keyword">case</span> <span class="string">'freq_range'</span>
0135             freq_range=varargin{i+1};
0136         <span class="keyword">case</span> <span class="string">'channels'</span>
0137             channels=varargin{i+1};
0138         <span class="keyword">case</span> <span class="string">'method'</span>
0139             method=varargin{i+1};
0140         <span class="keyword">case</span> <span class="string">'noise'</span>
0141             noise=varargin{i+1};
0142         <span class="keyword">case</span> <span class="string">'lfp_ntapers'</span>
0143             lfp_ntapers=varargin{i+1};
0144         <span class="keyword">case</span> <span class="string">'lfp_w'</span>
0145             lfp_w=varargin{i+1};
0146         <span class="keyword">case</span> <span class="string">'scale'</span>
0147             scale=varargin{i+1};
0148         <span class="keyword">case</span> <span class="string">'singletrials'</span>
0149             singletrials=varargin{i+1};
0150         <span class="keyword">case</span> <span class="string">'lfp_min_f'</span>
0151             lfp_min_f=varargin{i+1};
0152         <span class="keyword">case</span> <span class="string">'lfp_max_f'</span>
0153             lfp_max_f=varargin{i+1};
0154         <span class="keyword">case</span> <span class="string">'lfp_colors'</span>
0155             lfp_colors=varargin{i+1};
0156         <span class="keyword">case</span> <span class="string">'lfn_n'</span>
0157             lfp_n=varargin{i+1};
0158         <span class="keyword">case</span> <span class="string">'lfp_nfft'</span>
0159             lfp_nfft=varargin{i+1};
0160         <span class="keyword">case</span> <span class="string">'lfp_overlap'</span>
0161             lfp_overlap=varargin{i+1};
0162     <span class="keyword">end</span>
0163 <span class="keyword">end</span>
0164 
0165 
0166 [nsamples,ntrials,nchannels]=size(EPHYS_DATA);
0167 TIME=[1:nsamples]./SR;
0168 
0169 <span class="comment">% if the window size is greater than the length of the signal</span>
0170 <span class="comment">% make the window size roughly the length of the signal/5</span>
0171 <span class="comment">% and adjust the overlap accordingly</span>
0172 
0173 
0174 <span class="keyword">if</span> lfp_n&gt;nsamples
0175     difference=lfp_n-lfp_overlap;
0176     lfp_n=round(nsamples/5);
0177     lfp_overlap=lfp_n-difference;
0178 
0179     disp(<span class="string">'Reset window size and overlap, longer than nsamples'</span>);
0180     disp([<span class="string">'Window size:  '</span> num2str(lfp_n) <span class="string">' samples'</span>]);
0181     disp([<span class="string">'Overlap:  '</span> num2str(lfp_overlap) <span class="string">' samples'</span>]);
0182 
0183 <span class="keyword">end</span>
0184 
0185 <span class="comment">% if nfft is empty set to nextpow2</span>
0186 
0187 <span class="keyword">if</span> isempty(lfp_nfft)
0188     lfp_nfft=2^nextpow2(lfp_n);
0189 <span class="keyword">end</span>
0190 
0191 
0192 <span class="comment">% check if we're using multi-taper</span>
0193 
0194 <span class="keyword">if</span> lower(method(1))==<span class="string">'m'</span>
0195 
0196     resolution=lfp_w*1/(lfp_n/SR);
0197     
0198     <span class="keyword">if</span> isempty(lfp_ntapers)
0199         lfp_ntapers=2*(lfp_w)-1;
0200     <span class="keyword">end</span>
0201     [tapers,lambda]=dpss(lfp_n,lfp_w,lfp_ntapers);
0202 <span class="keyword">else</span>
0203     lfp_ntapers=<span class="string">''</span>;
0204     resolution=lfp_n/SR;
0205     tapers=[];
0206 <span class="keyword">end</span>
0207 
0208 disp([<span class="string">'Resolution:  '</span> num2str(resolution)  <span class="string">' Hz'</span>]);
0209 disp([<span class="string">'NFFT:  '</span> num2str(lfp_nfft)]);
0210 
0211 
0212 <span class="comment">% get rows and columns</span>
0213 
0214 <span class="keyword">if</span> mod(lfp_nfft,2)==0
0215     rows=(lfp_nfft/2+1);
0216 <span class="keyword">else</span>
0217     rows=(lfp_nfft+1)/2;
0218 <span class="keyword">end</span>
0219 
0220 columns=fix((nsamples-lfp_overlap)/(lfp_n-lfp_overlap));
0221 
0222 f=((1:rows)./rows).*(SR/2);
0223 col_idx=1+(0:(columns-1))*(lfp_n-lfp_overlap);
0224 t=((col_idx-1)+((lfp_n/2)'))/SR;
0225 <span class="comment">%t=(col_idx)/SR;</span>
0226 
0227 lfp_startidx=max([find(f&lt;=lfp_min_f)]);
0228 
0229 <span class="keyword">if</span> isempty(lfp_startidx)
0230     lfp_startidx=1;
0231 <span class="keyword">end</span>
0232 
0233 lfp_stopidx=min([find(f&gt;=lfp_max_f)]);
0234 
0235 
0236 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0237 
0238 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SIGNAL CONDITIONING %%%%%%%%%%%%%%%%</span>
0239 
0240 <span class="comment">% preallocate matrices</span>
0241 
0242 SPECT_AVE.t=t;
0243 SPECT_AVE.f=f;
0244 SPECT_AVE.image=zeros(length(f),length(t),length(channels),<span class="string">'single'</span>);
0245 
0246 <span class="comment">% denoise and condition the signal</span>
0247 
0248 proc_data=<a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>(EPHYS_DATA,CHANNELS,channels,<span class="string">'method'</span>,noise,<span class="string">'car_exclude'</span>,car_exclude);
0249 clear EPHYS_DATA;
0250 proc_data=double(<a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>(proc_data,<span class="string">'l'</span>,<span class="string">'freq_range'</span>,freq_range));
0251 
0252 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0253 
0254 
0255 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PLOTTING CODE %%%%%%%%%%%%%%%%%%%%%%</span>
0256 
0257 <span class="comment">% create output directory</span>
0258 
0259 [path,name,ext]=fileparts(savedir);
0260 savedir=fullfile(savedir,<span class="string">'lfp_tf'</span>);
0261 
0262 <span class="keyword">if</span> ~exist(savedir,<span class="string">'dir'</span>)
0263     mkdir(fullfile(savedir));
0264 <span class="keyword">end</span>
0265 
0266 <span class="comment">% single trials go in a subdir</span>
0267 
0268 savefilename=[ name <span class="string">'_lfptf_electrode_'</span>];
0269 
0270 delete(fullfile(savedir,[savefilename <span class="string">'*'</span>]));
0271 
0272 <span class="keyword">if</span> exist(fullfile(savedir,<span class="string">'singletrials'</span>));
0273     rmdir(fullfile(savedir,<span class="string">'singletrials'</span>),<span class="string">'s'</span>);
0274 <span class="keyword">end</span>
0275 
0276 <span class="keyword">for</span> i=1:length(channels)
0277 
0278     savedir_st=fullfile(savedir,<span class="string">'singletrials'</span>,[ <span class="string">'ch'</span> num2str(channels(i))]);
0279 
0280     <span class="keyword">if</span> ~exist(savedir_st,<span class="string">'dir'</span>)
0281         mkdir(savedir_st);
0282     <span class="keyword">end</span>
0283     
0284     spect_ave_tmp=zeros(rows,columns);
0285 
0286     parfor j=1:ntrials
0287     
0288         currdata=proc_data(:,j,i);
0289 
0290         <span class="keyword">if</span> lower(method(1))==<span class="string">'r'</span>
0291 
0292             [spect]=spectrogram(currdata,lfp_n,lfp_overlap,lfp_nfft);
0293             spect=abs(spect);
0294 
0295         <span class="keyword">else</span>
0296 
0297             <span class="comment">% average over tapers</span>
0298 
0299             spect=zeros(rows,columns);
0300 
0301             <span class="keyword">for</span> k=1:lfp_ntapers
0302 
0303                 spect_tmp=spectrogram(currdata,tapers(:,k),lfp_overlap,lfp_nfft);
0304                 spect_tmp=abs(spect_tmp);
0305 
0306                 <span class="comment">% reduce instead to save memory</span>
0307 
0308                 spect=spect+spect_tmp./lfp_ntapers;
0309 
0310             <span class="keyword">end</span>
0311 
0312         <span class="keyword">end</span>
0313     
0314         <span class="comment">% reduction to save memory, storing in a large matrix probably not viable for large n...</span>
0315         
0316         spect_ave_tmp=spect_ave_tmp+spect./ntrials;
0317 
0318         <span class="keyword">if</span> j&lt;=singletrials
0319             
0320             singletrialfig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>,<span class="string">'position'</span>,[0 0 800 600]);
0321 
0322             <span class="comment">% just plot a simple spectrogram and save</span>
0323 
0324 
0325             <span class="keyword">switch</span> lower(scale)
0326                 <span class="keyword">case</span> <span class="string">'linear'</span>
0327                     imagesc(t,f(lfp_startidx:lfp_stopidx),spect(lfp_startidx:lfp_stopidx,:));
0328                 <span class="keyword">case</span> <span class="string">'log'</span>
0329                     imagesc(t,f(lfp_startidx:lfp_stopidx),20*log10(spect(lfp_startidx:lfp_stopidx,:)));
0330                 <span class="keyword">otherwise</span>
0331                     error(<span class="string">'Did not understand scale, must be log or linear!'</span>);
0332             <span class="keyword">end</span>
0333 
0334             set(gca,<span class="string">'ydir'</span>,<span class="string">'normal'</span>);
0335 
0336             axis tight;
0337             colormap(lfp_colors);
0338             set(gca,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="string">'ytick'</span>,[round(lfp_min_f/10):1:round(lfp_max_f/10)]*10,<span class="keyword">...</span>
0339                 <span class="string">'linewidth'</span>,1.5,<span class="string">'ticklength'</span>,[.025 .025],<span class="string">'FontSize'</span>,16,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0340             xlabel(<span class="string">'Time (in s)'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0341             ylabel(<span class="string">'Hz'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0342             box off;
0343             set(singletrialfig,<span class="string">'PaperPositionMode'</span>,<span class="string">'auto'</span>)
0344             <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(singletrialfig,savedir_st,[<span class="string">'trial'</span> num2str(j)],<span class="string">'eps,png'</span>);
0345             close([singletrialfig]);
0346 
0347             <a href="#_sub1" class="code" title="subfunction parsave(FILE,t,f,spect)">parsave</a>(fullfile(savedir_st,[ <span class="string">'trial'</span> num2str(j)]),t,f,spect);
0348 
0349         <span class="keyword">end</span>
0350         
0351     <span class="keyword">end</span>
0352 
0353     SPECT_AVE.image(:,:,i)=single(spect_ave_tmp); <span class="comment">% for saving</span>
0354     spect_ave_plot.image=spect_ave_tmp./max(max(spect_ave_tmp)); <span class="comment">% normalize so max is 0 db</span>
0355     spect_ave_plot.t=SPECT_AVE.t;
0356     spect_ave_plot.f=SPECT_AVE.f;
0357 
0358     spect_fig=figure(<span class="string">'visible'</span>,<span class="string">'off'</span>,<span class="string">'Units'</span>,<span class="string">'Pixels'</span>,<span class="string">'Position'</span>,[0 0 round(600*nsamples/SR) 800]);
0359     
0360     fig_title=[<span class="string">'CH'</span> num2str(channels(i)) <span class="string">' NTAP'</span> num2str(lfp_ntapers) <span class="string">' RES '</span> num2str(resolution) <span class="string">' Hz'</span> <span class="string">' NTRIALS'</span> num2str(ntrials)];
0361 
0362     spect_fig=<a href="../ephys/helpers/visualization/time_frequency_raster.html" class="code" title="function fig_num=time_frequency_raster(HISTOGRAM,TFIMAGE,varargin)">time_frequency_raster</a>(HISTOGRAM,spect_ave_plot,<span class="string">'fig_num'</span>,spect_fig,<span class="string">'fig_title'</span>,fig_title,<span class="string">'scale'</span>,scale,<span class="keyword">...</span>
0363         <span class="string">'scalelabel'</span>,scalelabel,<span class="string">'hist_min_f'</span>,hist_min_f,<span class="string">'hist_max_f'</span>,hist_max_f,<span class="string">'tf_min_f'</span>,lfp_min_f,<span class="string">'tf_max_f'</span>,lfp_max_f);
0364 
0365     set(spect_fig,<span class="string">'PaperPositionMode'</span>,<span class="string">'auto'</span>);
0366 
0367     <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(spect_fig,savedir,<span class="keyword">...</span>
0368         [ savefilename num2str(channels(i)) ],<span class="string">'eps,png'</span>);
0369     close([spect_fig]);
0370 
0371 <span class="keyword">end</span>
0372 
0373 save(fullfile(savedir,<span class="string">'lfp_tf_data.mat'</span>),<span class="string">'CHANNELS'</span>,<span class="string">'channels'</span>,<span class="string">'SPECT_AVE'</span>);
0374 
0375 <span class="keyword">end</span>
0376 
0377 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0378 
0379 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PARFOR SAVING %%%%%%%%%%%%%%%%%%%%%%</span>
0380 
0381 <a name="_sub1" href="#_subfunctions" class="code">function parsave(FILE,t,f,spect)</a>
0382     
0383 save(FILE,<span class="string">'t'</span>,<span class="string">'f'</span>,<span class="string">'spect'</span>);
0384 
0385 <span class="keyword">end</span>
0386 
0387 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0388 
0389 
0390</pre></div>
<hr><address>Generated on Sun 22-Jul-2012 12:37:58 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>