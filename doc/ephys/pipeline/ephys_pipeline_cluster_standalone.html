<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ephys_pipeline_cluster_standalone</title>
  <meta name="keywords" content="ephys_pipeline_cluster_standalone">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../menu.html">Home</a> &gt;  <a href="../menu.html">ephys</a> &gt; <a href="menu.html">pipeline</a> &gt; ephys_pipeline_cluster_standalone.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../menu.html"><img alt="<" border="0" src="../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for ephys/pipeline&nbsp;<img alt=">" border="0" src="../../right.png"></a></td></tr></table>-->

<h1>ephys_pipeline_cluster_standalone
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="box"><strong>function cluster_standalone(TEMPLATEFILE,DATAFILE,CLASSIFYFILE) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="../../ephys/helpers/visualization/pretty_sonogram.html" class="code" title="function [IMAGE,F,T]=pretty_sonogram(SIGNAL,SR,varargin)">pretty_sonogram</a>	</li></ul>
This function is called by:
<ul style="list-style-image:url(../../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<ul style="list-style-image:url(../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function write_done_signal(savedir,dataname)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function cluster_standalone(TEMPLATEFILE,DATAFILE,CLASSIFYFILE)</a>
0002 <span class="comment">%</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%</span>
0006 
0007 colors=hot(63); <span class="comment">% uint8 colormap</span>
0008 
0009 disp_minfs=1e3;
0010 disp_maxfs=7.5e3;
0011 NW=1024;
0012 SR=25e3;
0013 
0014 <span class="comment">% takes the classifier object, template features and data features and extracts any instances</span>
0015 <span class="comment">% of the template as determined by the classifier</span>
0016 
0017 load(TEMPLATEFILE,<span class="string">'template_features'</span>,<span class="string">'TEMPLATE'</span>);
0018 load(DATAFILE,<span class="string">'features'</span>);
0019 load(CLASSIFYFILE,<span class="string">'cluster_choice'</span>,<span class="string">'classobject'</span>);
0020 
0021 <span class="comment">% ANNOYING we have to train the classifier each time in the compiled version since objects are not supported...</span>
0022 
0023 [junk,templength]=size(template_features{1});
0024 templength=templength-1;
0025 fulltemplength=length(TEMPLATE);
0026 
0027 <span class="comment">% before extracting make sure data file exists</span>
0028 
0029 [junk,featureslength]=size(features{1});
0030 
0031 score_temp={};
0032 temp_mat=[];
0033 
0034 <span class="comment">% we'll write the done signal (.dotfile) to the datafile path</span>
0035 
0036 [templatepath,junk1,junk2]=fileparts(TEMPLATEFILE);
0037 
0038 tokens=regexp(templatepath,filesep,<span class="string">'split'</span>);
0039 
0040 <span class="comment">% the template name is the directory the template data is stored in, this will</span>
0041 <span class="comment">% be a prefix for the done signal</span>
0042 
0043 templatename=tokens{end};
0044 
0045 [datapath,file,ext]=fileparts(DATAFILE);
0046 
0047 rawfile=fullfile(datapath,<span class="string">'..'</span>,[ file(1:end-6) <span class="string">'.mat'</span>]);
0048 
0049 rawfile
0050 
0051 <span class="keyword">if</span> ~exist(rawfile,<span class="string">'file'</span>)
0052     <span class="keyword">return</span>;
0053 <span class="keyword">end</span>
0054 
0055 savedir=fullfile(datapath,<span class="string">'..'</span>,templatename);
0056 
0057 imagedir=fullfile(savedir,<span class="string">'gif'</span>);
0058 wavdir=fullfile(savedir,<span class="string">'wav'</span>);
0059 matdir=fullfile(savedir,<span class="string">'mat'</span>);
0060 
0061 <span class="keyword">if</span> ~exist(imagedir,<span class="string">'dir'</span>)
0062     mkdir(imagedir);
0063 <span class="keyword">end</span>
0064 
0065 <span class="keyword">if</span> ~exist(wavdir,<span class="string">'dir'</span>);
0066     mkdir(wavdir);
0067 <span class="keyword">end</span>
0068 
0069 <span class="keyword">if</span> ~exist(matdir,<span class="string">'dir'</span>);
0070     mkdir(matdir);
0071 <span class="keyword">end</span>
0072 
0073 fid=fopen(fullfile(savedir,<span class="string">'.songextraction'</span>),<span class="string">'w'</span>);
0074 fclose(fid);
0075 
0076 <span class="keyword">for</span> i=1:length(features)
0077     score_temp{i}=[];
0078 
0079     <span class="keyword">for</span> j=1:featureslength-templength
0080         score_temp{i}=[score_temp{i} sum(sum(abs(features{i}(:,j:j+templength)-template_features{i})))];
0081     <span class="keyword">end</span>
0082 
0083     score_temp{i}=score_temp{i}-mean(score_temp{i});
0084     score_temp{i}=score_temp{i}/std(score_temp{i});
0085     score_temp{i}(score_temp{i}&gt;0)=0;
0086     score_temp{i}=abs(score_temp{i});
0087 
0088 <span class="keyword">end</span>
0089 
0090 attributes=length(score_temp);
0091 product_score=score_temp{1};
0092 
0093 <span class="keyword">for</span> i=2:attributes, product_score=product_score.*score_temp{i}; <span class="keyword">end</span>
0094 
0095 <span class="comment">% need to tag the file as processed at the end of this fiasco</span>
0096 
0097 <span class="keyword">if</span> length(product_score)&lt;3
0098     disp(<span class="string">'too short'</span>);
0099     <a href="#_sub1" class="code" title="subfunction write_done_signal(savedir,dataname)">write_done_signal</a>(savedir,[file ext]);
0100     <span class="keyword">return</span>;
0101 <span class="keyword">end</span>
0102 
0103 [pks,locs]=findpeaks(product_score,<span class="string">'MINPEAKHEIGHT'</span>,.005);
0104 
0105 <span class="keyword">if</span> isempty(locs)
0106     disp(<span class="string">'no locs'</span>);
0107     <a href="#_sub1" class="code" title="subfunction write_done_signal(savedir,dataname)">write_done_signal</a>(savedir,[file ext]);
0108     <span class="keyword">return</span>;
0109 <span class="keyword">end</span>
0110 
0111 curvature=gradient(gradient(product_score));
0112 
0113 <span class="comment">% for each peak create matrix with rows for observations and columns features</span>
0114 <span class="comment">% this will get passed to the classifier object, thumbs up/down, then extract if necessary</span>
0115 
0116 <span class="keyword">for</span> j=1:attributes, feature_mat(:,j)=log(score_temp{j}(locs)); <span class="keyword">end</span>
0117 
0118 feature_mat(:,attributes+1)=log(product_score(locs));
0119 feature_mat(:,attributes+2)=log(abs(curvature(locs)));
0120 
0121 peak_locs=locs;
0122 
0123 <span class="comment">% classify</span>
0124 
0125 labels=svmclassify(classobject,feature_mat);
0126 
0127 <span class="comment">% instances where we have a hit</span>
0128 
0129 hits=find(labels==cluster_choice);
0130 
0131 <span class="keyword">if</span> isempty(hits)
0132     disp(<span class="string">'no hits'</span>);
0133     <a href="#_sub1" class="code" title="subfunction write_done_signal(savedir,dataname)">write_done_signal</a>(savedir,[file ext]);
0134     <span class="keyword">return</span>;
0135 <span class="keyword">end</span>
0136 
0137 
0138 <span class="comment">% else, extract</span>
0139 
0140 templength=templength+NW;
0141 data=load(rawfile,<span class="string">'mic_data'</span>,<span class="string">'ephys_data'</span>,<span class="string">'channels'</span>,<span class="string">'fs'</span>);
0142 
0143 <span class="comment">% write images to 'gif', wav to 'wav' and 'mat' to mat again</span>
0144 
0145 [sonogram_im sonogram_f sonogram_t]=<a href="../../ephys/helpers/visualization/pretty_sonogram.html" class="code" title="function [IMAGE,F,T]=pretty_sonogram(SIGNAL,SR,varargin)">pretty_sonogram</a>(data.mic_data,data.fs,<span class="string">'n'</span>,500,<span class="string">'overlap'</span>,450,<span class="string">'low'</span>,3.5);
0146 startidx=max([find(sonogram_f&lt;=disp_minfs)]);
0147 stopidx=min([find(sonogram_f&gt;=disp_maxfs)]);
0148 sonogram_im=sonogram_im(startidx:stopidx,:);
0149 sonogram_im=flipdim(sonogram_im,1);
0150 
0151 [f,t]=size(sonogram_im);
0152 im_son_to_vec=(length(data.mic_data)-450)/t;
0153 
0154 <span class="keyword">for</span> i=1:length(hits)
0155 
0156     hitloc=peak_locs(hits(i));
0157 
0158     startpoint=(hitloc*(NW-1e3)*5);
0159     endpoint=startpoint+fulltemplength;
0160 
0161     <span class="keyword">if</span> length(data.mic_data)&gt;endpoint &amp;&amp; startpoint&gt;0    
0162 
0163         mic_data=data.mic_data(startpoint:endpoint);
0164         ephys_data=data.ephys_data(startpoint:endpoint,:);
0165         channels=data.channels;
0166         fs=data.fs;
0167 
0168         savename=[ file(1:end-6) <span class="string">'_'</span> templatename <span class="string">'_'</span> num2str(i)];
0169 
0170         save(fullfile(matdir,[savename <span class="string">'.mat'</span>]),<span class="string">'mic_data'</span>,<span class="string">'ephys_data'</span>,<span class="string">'channels'</span>,<span class="string">'fs'</span>);
0171 
0172         <span class="comment">% write out the extraction</span>
0173 
0174         sonogram_im(1:10,ceil(startpoint/im_son_to_vec):ceil(endpoint/im_son_to_vec))=63;
0175 
0176         [chunk_sonogram_im chunk_sonogram_f chunk_sonogram_t]=<a href="../../ephys/helpers/visualization/pretty_sonogram.html" class="code" title="function [IMAGE,F,T]=pretty_sonogram(SIGNAL,SR,varargin)">pretty_sonogram</a>(mic_data,fs,<span class="string">'low'</span>,3.5);
0177 
0178         startidx=max([find(chunk_sonogram_f&lt;=disp_minfs)]);
0179         stopidx=min([find(chunk_sonogram_f&gt;=disp_maxfs)]);
0180         chunk_sonogram_im=chunk_sonogram_im(startidx:stopidx,:);
0181         chunk_sonogram_im=flipdim(chunk_sonogram_im,1);
0182         imwrite(uint8(chunk_sonogram_im),colors,fullfile(imagedir,[savename <span class="string">'.gif'</span>]),<span class="string">'gif'</span>);
0183         wavwrite(mic_data,fs,fullfile(wavdir,[savename <span class="string">'.wav'</span>]));
0184     
0185     <span class="keyword">end</span>
0186 <span class="keyword">end</span>
0187 
0188 imwrite(uint8(sonogram_im),colors,fullfile(imagedir,[ file(1:end-6) <span class="string">'.gif'</span>]),<span class="string">'gif'</span>);
0189 
0190 <a href="#_sub1" class="code" title="subfunction write_done_signal(savedir,dataname)">write_done_signal</a>(savedir,[file ext]);
0191 
0192 <span class="keyword">end</span>
0193 
0194 <span class="comment">% need this so the bash script does not process the same file for the same template again</span>
0195 
0196 <a name="_sub1" href="#_subfunctions" class="code">function write_done_signal(savedir,dataname)</a>
0197 
0198 fid=fopen(fullfile(savedir,[ <span class="string">'.'</span>  dataname ]),<span class="string">'w'</span>);
0199 fclose(fid);
0200 
0201 <span class="keyword">end</span>
0202</pre></div>
<hr><address>Generated on Thu 19-Jul-2012 21:29:37 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>