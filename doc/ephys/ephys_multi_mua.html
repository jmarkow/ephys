<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ephys_multi_mua</title>
  <meta name="keywords" content="ephys_multi_mua">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../menu.html">Home</a> &gt;  <a href="menu.html">ephys</a> &gt; ephys_multi_mua.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../menu.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for ephys&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>ephys_multi_mua
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function ephys_multi_mua(HISTOGRAMS,MUA,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment"></pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function ephys_multi_mua(HISTOGRAMS,MUA,varargin)</a>
0002 <span class="comment">%</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%</span>
0006 
0007 <span class="comment">% basic idea:</span>
0008 <span class="comment">% 1) pass MUA and HISTOGRAMS as cell arrays, one cell per MUA raster and HISTOGRAM</span>
0009 <span class="comment">% 2) use the histograms to find the approximate onset to align all histograms to the first</span>
0010 <span class="comment">%    (so it normally makes sense to compute larger histograms to have room to maneuver)</span>
0011 <span class="comment">% 3) adjust histogram imask and MUA according to the offset of the histogram onset</span>
0012 <span class="comment">% 4) plot MUAs on the left, HISTOGRAMS on the right, allowing you to visualize the change</span>
0013 <span class="comment">%    in the histogram and the MUA over multiple days</span>
0014 <span class="comment">%</span>
0015 
0016 smooth_window=.0025; <span class="comment">% smoothing window in secs</span>
0017 SR=40e3;
0018 dir=pwd;
0019 min_f=1e3;
0020 max_f=10e3;
0021 hist_colors=hot;
0022 mua_colors=1-bone;
0023 figtitle=<span class="string">''</span>;
0024 onset_thresh=6e-4;
0025 
0026 onset_f=[3e3 7e3];
0027 
0028 nparams=length(varargin);
0029 
0030 <span class="keyword">for</span> i=1:2:nparams
0031     <span class="keyword">switch</span> lower(varargin{i})
0032         <span class="keyword">case</span> <span class="string">'sr'</span>
0033             SR=varargin{i+1};
0034         <span class="keyword">case</span> <span class="string">'dir'</span>
0035             dir=varargin{i+1};
0036         <span class="keyword">case</span> <span class="string">'min_f'</span>
0037             min_f=varargin{i+1};
0038         <span class="keyword">case</span> <span class="string">'max_f'</span>
0039             max_f=varargin{i+1};
0040         <span class="keyword">case</span> <span class="string">'hist_colors'</span>
0041             hist_colors=varargin{i+1};
0042         <span class="keyword">case</span> <span class="string">'mua_colors'</span>
0043             mua_colors=varargin{i+1};
0044         <span class="keyword">case</span> <span class="string">'onset_f'</span>
0045             onset_f=varargin{i+1};
0046         <span class="keyword">case</span> <span class="string">'onset_thresh'</span>
0047             onset_thresh=varargin{i+1};
0048     <span class="keyword">end</span>
0049 <span class="keyword">end</span>
0050 
0051 
0052 <span class="keyword">if</span> length(MUA)~=length(HISTOGRAMS)
0053     error(<span class="string">'Did not pass in the same number of histograms and rasters, bailling!'</span>);
0054 <span class="keyword">end</span>
0055 
0056 nplots=length(MUA)*2; <span class="comment">%need one raster and one histogram per row</span>
0057 
0058 <span class="comment">% first we need to determine the offset, align everything to the histogram with the</span>
0059 <span class="comment">% earlier onset</span>
0060 
0061 <span class="keyword">for</span> i=1:length(HISTOGRAMS)
0062     
0063     sdi{i}=HISTOGRAMS{i}.imask./sum(HISTOGRAMS{i}.imask(:));
0064     sdi_t{i}=HISTOGRAMS{i}.t;
0065     mua{i}=MUA{i}.image;
0066     mua_t{i}=MUA{i}.time;
0067 
0068     startidx=max([find(HISTOGRAMS{i}.f&lt;=onset_f(1))]);
0069     stopidx=min([find(HISTOGRAMS{i}.f&gt;=onset_f(2))]);
0070 
0071     songpower{i}=smooth(sum(sdi{i}(startidx:stopidx,:)),20);
0072     onsetvec=find(songpower{i}&gt;onset_thresh);
0073 
0074     figure();plot(songpower{i})
0075 
0076     <span class="comment">%songpower{i}=double(songpower{i}&gt;onset_thresh);</span>
0077 
0078     onsetvec(onsetvec&lt;5)=[];
0079 
0080     onset(i)=min(onsetvec);
0081     duration(i)=length(songpower{i});
0082 
0083 <span class="keyword">end</span>
0084 
0085 [min_onset ref_hist]=min(onset)
0086 min_duration=min(duration);
0087 
0088 <span class="comment">% find min onset and then align everything to it</span>
0089 
0090 <span class="keyword">for</span> i=setdiff(1:length(HISTOGRAMS),ref_hist)
0091     
0092     <span class="comment">%[c,lags]=xcorr(songpower{i},songpower{ref_hist});</span>
0093     <span class="comment">%[maxc,delay]=max(c);</span>
0094     <span class="comment">%align_point=lags(delay)</span>
0095 
0096     align_point=onset(i)-min_onset
0097 
0098     align_t=sdi_t{i}(align_point);
0099 
0100     <span class="comment">% shifted version</span>
0101     
0102     sdi_t{i}=sdi_t{i}-align_t/2;
0103 
0104     <span class="comment">% now shift the MUA</span>
0105 
0106     mua_t{i}=mua_t{i}-align_t/2;
0107 
0108 <span class="keyword">end</span>
0109 
0110 
0111 <span class="comment">% chop to the minimum duration, then we'll shift MUA and histograms</span>
0112 <span class="comment">% histograms first, save axes for linking</span>
0113 
0114 multi_fig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>);
0115 counter=1;
0116 
0117 <span class="comment">% chop the rasters to the max or 400 trials</span>
0118 
0119 max_trials=-inf;
0120 
0121 <span class="keyword">for</span> i=1:length(MUA)
0122 
0123     [ntrials,samples]=size(MUA{i}.image);
0124 
0125     <span class="keyword">if</span> ntrials&gt;max_trials
0126         max_trials=ntrials;
0127     <span class="keyword">end</span>
0128 
0129 <span class="keyword">end</span>
0130 
0131 <span class="keyword">if</span> max_trials&gt;350
0132     max_trials=350;
0133 <span class="keyword">end</span>
0134 
0135 <span class="keyword">for</span> i=1:length(MUA)
0136     
0137     [ntrials,samples]=size(mua{i});
0138 
0139     <span class="comment">% pad at the bottom if necessary so all images are the right aspect ratio</span>
0140 
0141     <span class="keyword">if</span> ntrials&lt;max_trials
0142         mua{i}=[mua{i};zeros(max_trials-ntrials,samples)];
0143     <span class="keyword">end</span>
0144 
0145 <span class="keyword">end</span>
0146 
0147 <span class="keyword">for</span> i=2:2:6
0148     
0149     ax(i)=subaxis(nplots/2,2,i,<span class="string">'margin'</span>,.1,<span class="string">'spacingvert'</span>,0.05,<span class="string">'spacinghoriz'</span>,.1);
0150 
0151     startidx=max([find(HISTOGRAMS{counter}.f&lt;=min_f)]);
0152     stopidx=min([find(HISTOGRAMS{counter}.f&gt;=max_f)]);
0153 
0154     imagesc(sdi_t{counter},HISTOGRAMS{counter}.f(startidx:stopidx),sdi{counter}(startidx:stopidx,:));
0155     set(ax(i),<span class="string">'ydir'</span>,<span class="string">'normal'</span>)
0156     colormap(hist_colors);
0157     freezeColors;
0158 
0159     counter=counter+1;
0160 
0161 <span class="keyword">end</span>
0162 
0163 counter=1;
0164 
0165 <span class="keyword">for</span> i=1:2:5
0166 
0167     <span class="comment">% to size the MUA correctly just pad the smaller rasters with zeros near the top?</span>
0168     <span class="comment">% then eliminate the axes and done</span>
0169 
0170     ax(i)=subaxis(nplots/2,2,i,<span class="string">'margin'</span>,.1,<span class="string">'spacingvert'</span>,0.05,<span class="string">'spacinghoriz'</span>,.1);
0171     imagesc(mua_t{counter},1:max_trials,mua{counter}(1:max_trials,:));
0172     <span class="comment">%xlim([0 max_duration./SR]);</span>
0173     colormap(mua_colors);
0174     freezeColors;
0175 
0176     counter=counter+1;
0177 
0178 <span class="keyword">end</span>
0179 
0180 linkaxes(ax,<span class="string">'x'</span>);
0181 
0182 set(multi_fig,<span class="string">'visible'</span>,<span class="string">'on'</span>);
0183 
0184 <span class="comment">% use subaxis to align everything appropriately</span>
0185 
0186 <span class="comment">% use 1e3-7e3 power to find onset (see Barish syllable duration)</span>
0187 <span class="comment">%</span>
0188 <span class="comment">% align everything to the first crossing</span>
0189 <span class="comment">%</span>
0190 <span class="comment">% chop off the boundaries if necessary</span>
0191 
0192 <span class="comment">% this will also be useful to compute summary statistics...</span></pre></div>
<hr><address>Generated on Thu 19-Jul-2012 21:29:37 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>