<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of new_data_plotter</title>
  <meta name="keywords" content="new_data_plotter">
  <meta name="description" content="">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../../../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../../../menu.html">Home</a> &gt;  <a href="../../menu.html">ephys</a> &gt; <a href="../menu.html">helpers</a> &gt; <a href="menu.html">visualization</a> &gt; new_data_plotter.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../../../menu.html"><img alt="<" border="0" src="../../../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for ephys/helpers/visualization&nbsp;<img alt=">" border="0" src="../../../right.png"></a></td></tr></table>-->

<h1>new_data_plotter
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong></strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="box"><strong>function output=new_data_plotter(DATAFILE,SAVEFILE) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre class="comment">
 GUI for choosing a cluster based on scores calculated by
 outloop.m.  Simply run the script without any arguments
 after outloop.</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../../../matlabicon.gif)">
</ul>
This function is called by:
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="../../../ephys/ephys_cluster.html" class="code" title="function ephys_cluster(DIR,varargin)">ephys_cluster</a>	ephys_cluster.m takes extracted and aligned singing data generated by intan_songdet.m</li></ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<ul style="list-style-image:url(../../../matlabicon.gif)">
<li><a href="#_sub1" class="code">function change_plot(varargin)</a></li><li><a href="#_sub2" class="code">function save_data(varargin)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../../../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function output=new_data_plotter(DATAFILE,SAVEFILE)</a>
0002 <span class="comment">%</span>
0003 <span class="comment">% GUI for choosing a cluster based on scores calculated by</span>
0004 <span class="comment">% outloop.m.  Simply run the script without any arguments</span>
0005 <span class="comment">% after outloop.</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%</span>
0008 
0009 <span class="comment">% load the information collected by outloop</span>
0010 
0011 load(DATAFILE,<span class="string">'variableCellArray'</span>,<span class="string">'peakLocation'</span>,<span class="string">'property_names'</span>)
0012 
0013 <span class="comment">% load the scores, their locations, the file number, and</span>
0014 <span class="comment">% the peak locations for subsequent saving</span>
0015 
0016 syllable_data=[];
0017 idx=[];
0018 file_idx=[];
0019 peak_locations=[];
0020 [junk,n_properties]=size(variableCellArray{1});
0021 
0022 <span class="comment">% everything is collapsed into vectors of the same size for simpler</span>
0023 <span class="comment">% processing</span>
0024 
0025 <span class="keyword">for</span> i=1:length(variableCellArray)
0026     [m,n]=size(variableCellArray{i});
0027     syllable_data=[syllable_data;variableCellArray{i}];
0028     idx=[idx;(1:m)'];
0029     peak_locations=[peak_locations;peakLocation{i}'];
0030     file_idx=[file_idx;ones(m,1).*i];
0031 <span class="keyword">end</span>
0032 
0033 <span class="comment">% run the PCA</span>
0034 
0035 [coef score variance t2]=princomp(syllable_data);
0036 
0037 <span class="keyword">for</span> i=1:length(variance)
0038     disp([<span class="string">'Principal component '</span> num2str(i) <span class="string">' explains '</span> num2str(100*variance(i)/sum(variance)) <span class="string">'% of the variance in the data'</span>]);
0039 <span class="keyword">end</span>
0040 
0041 <span class="comment">% generate the GUI</span>
0042 
0043 <span class="keyword">for</span> i=1:3
0044     property_names{end+1}=[ <span class="string">'PC '</span> num2str(i)];
0045 <span class="keyword">end</span>
0046 
0047 <span class="comment">%if n_properties==8</span>
0048 <span class="comment">%    property_names={'angle1', 'angle2', 'deriv1', 'deriv2', 'amp','entropy','product','curvature','PC1','PC2','PC3'};</span>
0049 <span class="comment">%else</span>
0050 <span class="comment">%    property_names={'angle1', 'angle2', 'deriv1', 'deriv2', 'amp','entropy','product','curvature','ephys_score','PC1','PC2','PC3'};</span>
0051 <span class="comment">%    %syllable_data(:,8)=zscore(syllable_data(:,8));</span>
0052 <span class="comment">%end</span>
0053     
0054 syllable_data=[syllable_data,score(:,1:3)];
0055 
0056 main_window=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>,<span class="string">'Position'</span>,[360,500,700,600],<span class="string">'Name'</span>,<span class="string">'Data Plotter'</span>,<span class="string">'NumberTitle'</span>,<span class="string">'off'</span>);
0057 
0058 plot_axis=axes(<span class="string">'Units'</span>,<span class="string">'pixels'</span>,<span class="string">'Position'</span>,[50,50,400,400]);
0059 
0060 pop_up_x= uicontrol(<span class="string">'Style'</span>,<span class="string">'popupmenu'</span>,<span class="keyword">...</span>
0061     <span class="string">'String'</span>,property_names,<span class="keyword">...</span>
0062     <span class="string">'Position'</span>,[400,90,75,25],<span class="string">'call'</span>,@<a href="#_sub1" class="code" title="subfunction change_plot(varargin)">change_plot</a>,<span class="keyword">...</span>
0063     <span class="string">'Value'</span>,5);
0064 pop_up_x_text= uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="keyword">...</span>
0065     <span class="string">'String'</span>,<span class="string">'X'</span>,<span class="keyword">...</span>
0066     <span class="string">'Position'</span>,[405,130,50,45]);
0067 
0068 pop_up_y= uicontrol(<span class="string">'Style'</span>,<span class="string">'popupmenu'</span>,<span class="keyword">...</span>
0069     <span class="string">'String'</span>,property_names,<span class="keyword">...</span>
0070     <span class="string">'Position'</span>,[495,90,75,25],<span class="string">'call'</span>,@<a href="#_sub1" class="code" title="subfunction change_plot(varargin)">change_plot</a>,<span class="keyword">...</span>
0071     <span class="string">'Value'</span>,6);
0072 pop_up_y_text= uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="keyword">...</span>
0073     <span class="string">'String'</span>,<span class="string">'Y'</span>,<span class="keyword">...</span>
0074     <span class="string">'Position'</span>,[500,130,50,45]);
0075 
0076 pop_up_z= uicontrol(<span class="string">'Style'</span>,<span class="string">'popupmenu'</span>,<span class="keyword">...</span>
0077     <span class="string">'String'</span>,property_names,<span class="keyword">...</span>
0078     <span class="string">'Position'</span>,[595,90,75,25],<span class="string">'call'</span>,@<a href="#_sub1" class="code" title="subfunction change_plot(varargin)">change_plot</a>,<span class="keyword">...</span>
0079     <span class="string">'Value'</span>,7);
0080 pop_up_z_text= uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="keyword">...</span>
0081     <span class="string">'String'</span>,<span class="string">'Z'</span>,<span class="keyword">...</span>
0082     <span class="string">'Position'</span>,[600,130,50,45]);
0083 
0084 pop_up_clusters= uicontrol(<span class="string">'Style'</span>,<span class="string">'popupmenu'</span>,<span class="keyword">...</span>
0085     <span class="string">'String'</span>,[2:9],<span class="keyword">...</span>
0086     <span class="string">'Position'</span>,[475,210,75,25],<span class="string">'call'</span>,@<a href="#_sub1" class="code" title="subfunction change_plot(varargin)">change_plot</a>);
0087 pop_up_clusters_text= uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="keyword">...</span>
0088     <span class="string">'String'</span>,<span class="string">'Number of Clusters'</span>,<span class="keyword">...</span>
0089     <span class="string">'Position'</span>,[500,250,100,45]);
0090 
0091 pop_up_choice= uicontrol(<span class="string">'Style'</span>,<span class="string">'popupmenu'</span>,<span class="keyword">...</span>
0092     <span class="string">'String'</span>,[1:9],<span class="keyword">...</span>
0093     <span class="string">'Position'</span>,[475,330,75,25]);
0094 pop_up_choice_text= uicontrol(<span class="string">'Style'</span>,<span class="string">'text'</span>,<span class="keyword">...</span>
0095     <span class="string">'String'</span>,<span class="string">'Cluster selection'</span>,<span class="keyword">...</span>
0096     <span class="string">'Position'</span>,[500,370,100,45]);
0097 
0098 push_replot_save= uicontrol(<span class="string">'Style'</span>,<span class="string">'pushbutton'</span>,<span class="keyword">...</span>
0099     <span class="string">'String'</span>,<span class="string">'Save'</span>,<span class="keyword">...</span>
0100     <span class="string">'Position'</span>,[500,40,100,25],<span class="string">'call'</span>,@<a href="#_sub2" class="code" title="subfunction save_data(varargin)">save_data</a>);
0101 
0102 push_draw_mode= uicontrol(<span class="string">'Style'</span>,<span class="string">'pushbutton'</span>,<span class="keyword">...</span>
0103     <span class="string">'String'</span>,<span class="string">'Draw mode (x and y only)'</span>,<span class="keyword">...</span>
0104     <span class="string">'Position'</span>,[500,450,100,35],<span class="string">'value'</span>,0,<span class="keyword">...</span>
0105     <span class="string">'Call'</span>,@<a href="#_sub1" class="code" title="subfunction change_plot(varargin)">change_plot</a>);
0106 
0107 rows=ceil(length(property_names)/5);
0108 
0109 i=1;
0110 <span class="keyword">while</span> i&lt;=length(property_names)
0111     row=ceil(i/5);
0112     column=mod(i,5);
0113     <span class="keyword">if</span> column==0, column=5; <span class="keyword">end</span>
0114 
0115     cluster_data_check{i}=uicontrol(<span class="string">'Style'</span>,<span class="string">'checkbox'</span>,<span class="keyword">...</span>
0116         <span class="string">'String'</span>,property_names{i},<span class="keyword">...</span>
0117         <span class="string">'Value'</span>,0,<span class="string">'Position'</span>,[50+column*60,600-row*35,70,25]);
0118     set(cluster_data_check{i},<span class="string">'Units'</span>,<span class="string">'Normalized'</span>)
0119     i=i+1;
0120 <span class="keyword">end</span>
0121 
0122 
0123 <span class="comment">% now align everything and send the main_window handle to the output</span>
0124 <span class="comment">% so we can use the gui with uiwait (requires the handle as a return value)</span>
0125 
0126 align([pop_up_clusters,pop_up_clusters_text,pop_up_choice,pop_up_choice_text,push_replot_save],<span class="string">'Center'</span>,<span class="string">'None'</span>);
0127 align([pop_up_x,pop_up_x_text],<span class="string">'Center'</span>,<span class="string">'None'</span>);
0128 align([pop_up_y,pop_up_y_text],<span class="string">'Center'</span>,<span class="string">'None'</span>);
0129 align([pop_up_z,pop_up_z_text],<span class="string">'Center'</span>,<span class="string">'None'</span>);
0130 
0131 output=gcf;
0132 
0133 <span class="comment">% run change_plot, which updates the plot according to the defaults</span>
0134 
0135 <a href="#_sub1" class="code" title="subfunction change_plot(varargin)">change_plot</a>();
0136 cluster=guidata(main_window);
0137 [dummy min_centroid]=min(cluster.within_sum);
0138 
0139 set(pop_up_choice,<span class="string">'string'</span>,[1:length(unique(cluster.labels))])
0140 set(pop_up_choice,<span class="string">'value'</span>,min_centroid);
0141 
0142 set([main_window,plot_axis,pop_up_x,pop_up_x_text,pop_up_y,pop_up_y_text,pop_up_z,<span class="keyword">...</span>
0143     pop_up_z_text,pop_up_clusters,pop_up_clusters_text,pop_up_choice,pop_up_choice_text,<span class="keyword">...</span>
0144     push_replot_save,push_draw_mode],<span class="string">'Units'</span>,<span class="string">'Normalized'</span>);
0145 movegui(main_window,<span class="string">'center'</span>)
0146 set(main_window,<span class="string">'Visible'</span>,<span class="string">'On'</span>)
0147 
0148 <span class="comment">%% Callbacks</span>
0149 
0150 <span class="comment">% this callback changes the plot and returns the sum of the distances</span>
0151 <span class="comment">% from the centroid for each point in a cluster</span>
0152 
0153 <a name="_sub1" href="#_subfunctions" class="code">function change_plot(varargin)</a>
0154 
0155 <span class="comment">% get the number of dimensions for the plot (number of principal components)</span>
0156 
0157 
0158 colors={<span class="string">'b'</span>,<span class="string">'r'</span>,<span class="string">'g'</span>,<span class="string">'c'</span>,<span class="string">'m'</span>,<span class="string">'y'</span>,<span class="string">'k'</span>,<span class="string">'r'</span>,<span class="string">'g'</span>,<span class="string">'b'</span>};
0159 dim(1)=get(pop_up_x,<span class="string">'value'</span>);
0160 dim(2)=get(pop_up_y,<span class="string">'value'</span>);
0161 dim(3)=get(pop_up_z,<span class="string">'value'</span>);
0162 
0163 draw_mode=get(push_draw_mode,<span class="string">'value'</span>);
0164 
0165 <span class="keyword">for</span> i=1:length(cluster_data_check)
0166     set(cluster_data_check{i},<span class="string">'value'</span>,0)
0167 <span class="keyword">end</span>
0168 
0169 <span class="keyword">for</span> i=1:length(dim)
0170     set(cluster_data_check{dim(i)},<span class="string">'value'</span>,1);
0171 <span class="keyword">end</span>
0172 
0173 choices=get(pop_up_clusters,<span class="string">'string'</span>);
0174 clusternum=str2num(choices(get(pop_up_clusters,<span class="string">'value'</span>)));
0175 
0176 <span class="comment">% perform the kmeans analysis and return the labels, centroid coordinates,</span>
0177 <span class="comment">% sum of all points in each cluster from their respective centroid and</span>
0178 <span class="comment">% the distance of all points from all centroids</span>
0179 
0180 cluster_data=syllable_data(:,dim);
0181 [cluster.labels cluster.centroids cluster.within_sum cluster.all_dist]=kmeans(cluster_data,clusternum);
0182 guidata(main_window,cluster)
0183 
0184 <span class="comment">% clear the plot axis</span>
0185 
0186 cla;
0187 ndims=length(dim);
0188 <span class="comment">% plot in either 2 or 3 dims</span>
0189 
0190 <span class="comment">% turns out plot is MUCH faster than scatter, changed accordingly...</span>
0191 
0192 <span class="keyword">if</span> draw_mode
0193     ndims=2;
0194     plot(cluster_data(:,1),cluster_data(:,2),<span class="string">'o'</span>,<span class="string">'markerfacecolor'</span>,colors{1});view(2);
0195     hold on
0196     disp(<span class="string">'Select the corners of the enclosing polygon then press RETURN to continue...'</span>);
0197     hold off;
0198     [xv,yv]=ginput;
0199     k=convhull(xv,yv);
0200     plot(xv(k),yv(k),<span class="string">'b-'</span>,<span class="string">'linewidth'</span>,1.25);
0201     hold on;
0202     cluster.labels=inpolygon(cluster_data(:,1),cluster_data(:,2),xv(k),yv(k))+1;
0203     cluster.inpolygon=1;
0204     cluster.convhull=[xv(k) yv(k)];
0205     clusternum=2;
0206 <span class="keyword">end</span>
0207 
0208 
0209 <span class="keyword">switch</span> ndims
0210     <span class="keyword">case</span> 2
0211         <span class="keyword">for</span> i=1:clusternum
0212             clusterid{i}=num2str(i);
0213             points=find(cluster.labels==i);
0214             h(:,i)=plot(cluster_data(points,1),cluster_data(points,2),<span class="keyword">...</span>
0215                 <span class="string">'o'</span>,<span class="string">'markerfacecolor'</span>,colors{i},<span class="string">'markeredgecolor'</span>,<span class="string">'none'</span>);hold on
0216         <span class="keyword">end</span>
0217         view(2)
0218     <span class="keyword">case</span> 3
0219         <span class="keyword">for</span> i=1:clusternum
0220             clusterid{i}=num2str(i);
0221             points=find(cluster.labels==i);
0222             h(:,i)=plot3(cluster_data(points,1),cluster_data(points,2),cluster_data(points,3),<span class="keyword">...</span>
0223                 <span class="string">'o'</span>,<span class="string">'markerfacecolor'</span>,colors{i},<span class="string">'markeredgecolor'</span>,<span class="string">'none'</span>);hold on
0224 
0225         <span class="keyword">end</span>
0226         grid on
0227         view(3)
0228 
0229 <span class="keyword">end</span>
0230 
0231 
0232 <span class="comment">% label everything</span>
0233 
0234 xlabel(property_names{dim(1)});ylabel(property_names{dim(2)});zlabel(property_names{dim(3)})
0235 set(pop_up_choice,<span class="string">'string'</span>,[1:length(unique(cluster.labels))])
0236 L=legend(h,clusterid,<span class="string">'Location'</span>,<span class="string">'NorthEastOutside'</span>);legend boxoff
0237 
0238 
0239 set(L,<span class="string">'FontSize'</span>,20,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>)
0240 
0241 <span class="comment">% pass the labels back to main function via guidata since</span>
0242 <span class="comment">% we share with save_data</span>
0243 
0244 guidata(main_window,cluster);
0245 
0246 <span class="keyword">end</span>    
0247 
0248 
0249 <a name="_sub2" href="#_subfunctions" class="code">function save_data(varargin)</a>
0250 
0251 <span class="comment">% get the labels from the main_window</span>
0252 
0253 cluster=guidata(main_window);
0254 choices=get(pop_up_choice,<span class="string">'string'</span>);
0255 cluster.choice=str2num(choices(get(pop_up_choice,<span class="string">'value'</span>)));
0256 cluster.selection=find(cluster.labels==cluster.choice);
0257 
0258 <span class="comment">%[cluster.center cluster.edistance]=...</span>
0259 <span class="comment">%    cluster_dispersion(syllable_data(cluster.selection,1:end-3),syllable_data(cluster.selection,end-2:end));</span>
0260 
0261 <span class="comment">% can alternately just use pdist to compute the pairwise distance!</span>
0262 
0263 <span class="comment">% now return the indices of our selection</span>
0264 
0265 idxs=idx(cluster.selection);
0266 
0267 <span class="comment">% get the file each index comes from</span>
0268 
0269 file_idxs=file_idx(cluster.selection);
0270 peak_locs=peak_locations(cluster.selection);
0271 
0272 <span class="comment">% put everything back into a cell array where</span>
0273 <span class="comment">% each cell is a data file</span>
0274 
0275 <span class="keyword">for</span> i=1:length(variableCellArray)
0276     temp=find(file_idxs==i);
0277     sorted_syllable{i}=peak_locs(temp);
0278 <span class="keyword">end</span>
0279 
0280 <span class="comment">% save to syllable_data.mat for extract</span>
0281 
0282 <span class="comment">% train a Naive Bayes classifier based on the sellection</span>
0283 
0284 <span class="comment">% use all dimensions except PCA</span>
0285 
0286 <span class="comment">%bayesobject=NaiveBayes.fit(syllable_data(:,[1:6]),cluster.labels);</span>
0287 disp(<span class="string">'Training classifier on your selection...'</span>);
0288 
0289 classobject=svmtrain(syllable_data(:,[1:6]),cluster.labels);
0290 
0291 [path,file,ext]=fileparts(SAVEFILE);
0292 cluster_choice=cluster.choice;
0293 
0294 save(SAVEFILE,<span class="string">'sorted_syllable'</span>,<span class="string">'syllable_data'</span>,<span class="string">'cluster'</span>,<span class="string">'property_names'</span>,<span class="string">'classobject'</span>)
0295 
0296 <span class="comment">% store classify data, place in a separate directory with template for automatic clustering</span>
0297 
0298 save(fullfile(path,[<span class="string">'classify_data.mat'</span>]),<span class="string">'classobject'</span>,<span class="string">'cluster_choice'</span>);
0299 
0300 disp([<span class="string">'Data successfully saved!'</span>]);
0301 
0302 <span class="keyword">end</span>
0303 
0304 <span class="keyword">end</span></pre></div>
<hr><address>Generated on Thu 19-Jul-2012 21:29:37 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>