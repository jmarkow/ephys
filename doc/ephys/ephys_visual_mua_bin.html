<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ephys_visual_mua_bin</title>
  <meta name="keywords" content="ephys_visual_mua_bin">
  <meta name="description" content="intan_visual_mua.m takes data generated by intan_cluster.m and stored in extracted_data.mat">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../menu.html">Home</a> &gt;  <a href="menu.html">ephys</a> &gt; ephys_visual_mua_bin.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../menu.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for ephys&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>ephys_visual_mua_bin
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>intan_visual_mua.m takes data generated by intan_cluster.m and stored in extracted_data.mat</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function [MUA TIME LABEL HISTOGRAM]=ephys_visual_mua_bin(MIC_DATA,EPHYS_DATA,CHANNELS,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">intan_visual_mua.m takes data generated by intan_cluster.m and stored in extracted_data.mat
and produces song_aligned multi-unit rasters.

    [MUA TIME LABEL HISTOGRAM]=intan_visual_mua(MIC_DATA,EPHYS_DATA,CHANNELS,varargin)

    MIC_DATA
    aligned microphrone traces from extracted_data.mat (should be the variable mic_data)

    EPHYS_DATA
    aligned Intan data from extracted_data.mat (should be the variable ephys_data)

    CHANNELS
    channel labels (i.e. the channel that corresponds to a given element in the cell array
    ephys_data) from extracted_data.mat

    the following may be specified as parameter/value pairs:

        exclude
        electrodes to exclude from noise estimate

        smooth_window
        smoothing_window for multi-unit in seconds (default .005)

        SR
        data sampling rate (default: 25e3)

        noise
        noise rejection method (default: 'car', or common-average-rejection)

        filtering
        define as a two-element vector with lower and upper corner frequencies 
        to filtering multi-unit traces (default: none)

        dir
        directory to store results (default: pwd)

        min_f
        lowermost frequency to display for contour histogram

        max_f
        uppermost frequency to display for contour histogram

        colors
        colormap for contour histogram and multi-unit data</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../ephys/helpers/ephys/hampel_filter.html" class="code" title="function [REJECTS]=hampel_filter(INPUTDATA,varargin)">hampel_filter</a>	</li><li><a href="../ephys/helpers/spectral/contour_histogram.html" class="code" title="function [RMASK IMASK F T CONTOURS]=contour_histogram(SIGNALS,varargin)">contour_histogram</a>	contour_approx computes the contour approximation via Chris' method.</li><li><a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>	</li><li><a href="../ephys/helpers/visualization/prctile_bin.html" class="code" title="function [BIN BINEDGES]=prctile_bin(DATA,BININTERVAL)">prctile_bin</a>	</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function [MUA TIME LABEL HISTOGRAM]=ephys_visual_mua_bin(MIC_DATA,EPHYS_DATA,CHANNELS,varargin)</a>
0002 <span class="comment">%intan_visual_mua.m takes data generated by intan_cluster.m and stored in extracted_data.mat</span>
0003 <span class="comment">%and produces song_aligned multi-unit rasters.</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%    [MUA TIME LABEL HISTOGRAM]=intan_visual_mua(MIC_DATA,EPHYS_DATA,CHANNELS,varargin)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%    MIC_DATA</span>
0008 <span class="comment">%    aligned microphrone traces from extracted_data.mat (should be the variable mic_data)</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%    EPHYS_DATA</span>
0011 <span class="comment">%    aligned Intan data from extracted_data.mat (should be the variable ephys_data)</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%    CHANNELS</span>
0014 <span class="comment">%    channel labels (i.e. the channel that corresponds to a given element in the cell array</span>
0015 <span class="comment">%    ephys_data) from extracted_data.mat</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%    the following may be specified as parameter/value pairs:</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%        exclude</span>
0020 <span class="comment">%        electrodes to exclude from noise estimate</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%        smooth_window</span>
0023 <span class="comment">%        smoothing_window for multi-unit in seconds (default .005)</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%        SR</span>
0026 <span class="comment">%        data sampling rate (default: 25e3)</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%        noise</span>
0029 <span class="comment">%        noise rejection method (default: 'car', or common-average-rejection)</span>
0030 <span class="comment">%</span>
0031 <span class="comment">%        filtering</span>
0032 <span class="comment">%        define as a two-element vector with lower and upper corner frequencies</span>
0033 <span class="comment">%        to filtering multi-unit traces (default: none)</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%        dir</span>
0036 <span class="comment">%        directory to store results (default: pwd)</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%        min_f</span>
0039 <span class="comment">%        lowermost frequency to display for contour histogram</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%        max_f</span>
0042 <span class="comment">%        uppermost frequency to display for contour histogram</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%        colors</span>
0045 <span class="comment">%        colormap for contour histogram and multi-unit data</span>
0046 <span class="comment">%</span>
0047 <span class="comment">%</span>
0048 
0049 <span class="keyword">if</span> nargin&lt;3 | isempty(CHANNELS), CHANNELS=1:16; <span class="keyword">end</span>
0050 
0051 nparams=length(varargin);
0052 
0053 <span class="keyword">if</span> mod(nparams,2)&gt;0
0054     error(<span class="string">'Parameters must be specified as parameter/value pairs'</span>);
0055 <span class="keyword">end</span>
0056 
0057 <span class="comment">%%%</span>
0058 
0059 sigma=.0025; <span class="comment">% smoothing window in secs</span>
0060 SR=25e3;
0061 preproc=<span class="string">'square'</span>; <span class="comment">% square or abs?</span>
0062 noise=<span class="string">'car'</span>; <span class="comment">% common-average reference for noise removal</span>
0063 exclude=[];
0064 smoothing=<span class="string">'y'</span>;
0065 filtering=<span class="string">'y'</span>; <span class="comment">% if defined then filtering filter the traces</span>
0066 dir=pwd;
0067 min_f=1e3;
0068 max_f=10e3;
0069 hist_colors=<span class="string">'jet'</span>;
0070 mua_colors=<span class="string">'bone'</span>;
0071 figtitle=<span class="string">''</span>;
0072 freq_range=[500 5e3]; <span class="comment">% frequency range for filtering</span>
0073 downsampling=2;
0074 channels=CHANNELS;
0075 noisereject=1e3;
0076 bininterval=1;
0077 
0078 <span class="keyword">for</span> i=1:2:nparams
0079     <span class="keyword">switch</span> lower(varargin{i})
0080         <span class="keyword">case</span> <span class="string">'sigma'</span>
0081             smooth_window=varargin{i+1};
0082         <span class="keyword">case</span> <span class="string">'sr'</span>
0083             SR=varargin{i+1};
0084         <span class="keyword">case</span> <span class="string">'preproc'</span>
0085             preproc=varargin{i+1};
0086         <span class="keyword">case</span> <span class="string">'noise'</span>
0087             noise=varargin{i+1};
0088         <span class="keyword">case</span> <span class="string">'filtering'</span>
0089             filtering=varargin{i+1};
0090         <span class="keyword">case</span> <span class="string">'dir'</span>
0091             dir=varargin{i+1};
0092         <span class="keyword">case</span> <span class="string">'min_f'</span>
0093             min_f=varargin{i+1};
0094         <span class="keyword">case</span> <span class="string">'max_f'</span>
0095             max_f=varargin{i+1};
0096         <span class="keyword">case</span> <span class="string">'mua_colors'</span>
0097             mua_colors=varargin{i+1};
0098         <span class="keyword">case</span> <span class="string">'hist_colors'</span>
0099             hist_colors=varargin{i+1};
0100         <span class="keyword">case</span> <span class="string">'exclude'</span>
0101             exclude=varargin{i+1};
0102         <span class="keyword">case</span> <span class="string">'figtitle'</span>
0103             figtitle=varargin{i+1};
0104         <span class="keyword">case</span> <span class="string">'freq_range'</span>
0105             freq_range=varargin{i+1};
0106         <span class="keyword">case</span> <span class="string">'downsampling'</span>
0107             downsampling=varargin{i+1};
0108         <span class="keyword">case</span> <span class="string">'channels'</span>
0109             channels=varargin{i+1};
0110         <span class="keyword">case</span> <span class="string">'noisereject'</span>
0111             noisereject=varargin{i+1};
0112         <span class="keyword">case</span> <span class="string">'bininterval'</span>
0113             bininterval=varargin{i+1};
0114     <span class="keyword">end</span>
0115 <span class="keyword">end</span>
0116 
0117 <span class="comment">% perhaps add a median filter here to remove spikes from the multi-unit trace</span>
0118 
0119 <span class="comment">% intan nearest neighbor mapping</span>
0120 
0121 channel_map=[4 3 2 1 16 15 14 13 5 6 7 8 9 10 11 12];
0122 channel_ref=[3 4 3 2 1 16 15 14 6 5 6 7 8 9 10 11];
0123 
0124 <span class="comment">% kernel for smoothing multi-unit, just use a Gauss here...</span>
0125 
0126 edges=[-3*sigma:1/SR:3*sigma];
0127 kernel=(1/(sigma*sqrt(2*pi)))*exp((-(edges-0).^2)./(2*sigma^2));
0128 kernel=kernel./sum(kernel); <span class="comment">% normalize to sum to 1</span>
0129 
0130 <span class="comment">% what to exclude from CAR?</span>
0131 
0132 <span class="comment">% need to write a function for automatically determining which electrodes to reject</span>
0133 
0134 exclude_channels=[];
0135 
0136 <span class="keyword">for</span> i=1:length(exclude)
0137     exclude_channels(i)=find(CHANNELS==exclude(i));
0138 <span class="keyword">end</span>
0139 
0140 electrodes=setdiff(1:length(CHANNELS),exclude_channels); <span class="comment">% which electrodes are good?</span>
0141 
0142 <span class="keyword">if</span> max_f&gt;SR/2
0143     disp(<span class="string">'Maximum Fs must be less than Nyquist!'</span>);
0144     disp(<span class="string">'Resetting max fs'</span>);
0145     max_f==SR/2;
0146 <span class="keyword">end</span>
0147 
0148 [samples,ntrials,nelectrodes]=size(EPHYS_DATA);
0149 TIME=[1:samples]./SR;
0150 LABEL=CHANNELS;
0151 
0152 disp(<span class="string">'Referencing and filtering...'</span>);
0153 
0154 <span class="keyword">switch</span> lower(noise)
0155     <span class="keyword">case</span> <span class="string">'car'</span>
0156 
0157         car=mean(EPHYS_DATA,3);
0158         raster_fig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>);
0159         imagesc(TIME,1:ntrials,car');
0160         colormap(mua_colors);
0161         <span class="comment">%multi_fig_save(raster_fig,dir,[ 'CAR' ],'png');</span>
0162         close([raster_fig]);
0163 
0164         <span class="keyword">for</span> i=1:length(CHANNELS)
0165             EPHYS_DATA(:,:,i)=EPHYS_DATA(:,:,i)-car;
0166         <span class="keyword">end</span>
0167 
0168     <span class="keyword">case</span> <span class="string">'nn'</span>
0169 
0170         <span class="keyword">for</span> i=1:length(CHANNELS)
0171             EPHYS_DATA(:,:,i)=EPHYS_DATA(:,:,i)-EPHYS_DATA(:,:,find(channel_map==i));
0172         <span class="keyword">end</span>
0173 
0174 <span class="keyword">end</span>
0175 
0176 <span class="keyword">for</span> i=1:length(CHANNELS)
0177 
0178     disp([<span class="string">'Electrode '</span> num2str(CHANNELS(i))]);
0179 
0180     <span class="keyword">for</span> j=1:ntrials
0181 
0182         <span class="keyword">if</span> lower(filtering(1))==<span class="string">'y'</span>
0183 
0184             [b,a]=butter(2,[freq_range]./(SR/2));
0185             EPHYS_DATA(:,j,i)=single(filtfilt(b,a,double(EPHYS_DATA(:,j,i))));
0186         
0187         <span class="keyword">end</span>
0188         
0189     <span class="keyword">end</span>
0190 
0191     
0192 <span class="keyword">end</span>
0193 
0194 <span class="keyword">switch</span> lower(preproc)
0195     <span class="keyword">case</span> <span class="string">'square'</span>
0196         EPHYS_DATA=EPHYS_DATA.^2;
0197     <span class="keyword">case</span> <span class="string">'abs'</span>
0198         EPHYS_DATA=abs(EPHYS_DATA);
0199     <span class="keyword">otherwise</span>
0200 <span class="keyword">end</span>
0201 
0202 <span class="comment">% any trials to delete?</span>
0203 
0204 disp(<span class="string">'Generating contour histogram...'</span>);
0205 
0206 [HISTOGRAM.rmask HISTOGRAM.imask HISTOGRAM.f HISTOGRAM.t]=<span class="keyword">...</span>
0207     <a href="../ephys/helpers/spectral/contour_histogram.html" class="code" title="function [RMASK IMASK F T CONTOURS]=contour_histogram(SIGNALS,varargin)">contour_histogram</a>(MIC_DATA,<span class="string">'sr'</span>,SR,<span class="string">'tscale'</span>,1.5);
0208 
0209 startidx=max([find(HISTOGRAM.f&lt;=min_f)]);
0210 stopidx=min([find(HISTOGRAM.f&gt;=max_f)]);
0211 
0212 mean_osc=mean(MIC_DATA,2);
0213 clear MIC_DATA;
0214 
0215 <span class="comment">% are we downsampling</span>
0216 
0217 <span class="keyword">if</span> ~isempty(downsampling)
0218     MUA.t=downsample(TIME,downsampling);
0219 <span class="keyword">end</span>
0220 
0221 disp(<span class="string">'Converting to raster form...'</span>);
0222 
0223 MUA.image=zeros(ntrials,length(MUA.t),length(channels),<span class="string">'single'</span>);
0224 MUA.trials=1:ntrials;
0225 
0226 <span class="comment">% need a noise cutoff...</span>
0227 
0228 <span class="keyword">for</span> i=1:length(channels)
0229     channels(i)=find(channels(i)==CHANNELS);
0230 <span class="keyword">end</span>
0231 
0232 <span class="keyword">switch</span> lower(smoothing(1))
0233     <span class="keyword">case</span> <span class="string">'y'</span>
0234         <span class="keyword">for</span> i=1:length(channels)
0235             disp([<span class="string">'Electrode '</span> num2str(channels(i))]);
0236             <span class="keyword">for</span> j=1:ntrials
0237                 MUA.image(j,:,i)=downsample(conv(EPHYS_DATA(:,j,channels(i)),kernel,<span class="string">'same'</span>),downsampling);
0238                 MUA.image(j,:,i)=<a href="../ephys/helpers/visualization/prctile_bin.html" class="code" title="function [BIN BINEDGES]=prctile_bin(DATA,BININTERVAL)">prctile_bin</a>(MUA.image(j,:,i),bininterval);
0239             <span class="keyword">end</span>
0240         <span class="keyword">end</span>        
0241 
0242     <span class="keyword">otherwise</span>
0243 
0244         <span class="comment">% just downsample</span>
0245 
0246 <span class="keyword">end</span>
0247 
0248 disp(<span class="string">'Generating figures...'</span>);
0249 disp([<span class="string">'Will save to directory:  '</span> dir]);
0250 
0251 <span class="comment">% scale pixels by time</span>
0252 
0253 <span class="keyword">if</span> ~exist(fullfile(dir,<span class="string">'mua_bin'</span>),<span class="string">'dir'</span>)
0254     mkdir(fullfile(dir,<span class="string">'mua_bin'</span>));
0255 <span class="keyword">end</span>
0256 
0257 <span class="keyword">for</span> i=1:length(channels)
0258 
0259     ax=[];
0260     raster_fig=figure(<span class="string">'visible'</span>,<span class="string">'off'</span>,<span class="string">'Units'</span>,<span class="string">'Pixels'</span>,<span class="string">'Position'</span>,[0 0 1e3 1.4e3]);
0261 
0262     ax(1)=subaxis(6,1,1,1,1,2,<span class="string">'margin'</span>,.1,<span class="string">'spacingvert'</span>,0);
0263     imagesc(HISTOGRAM.t,HISTOGRAM.f(startidx:stopidx),HISTOGRAM.imask(startidx:stopidx,:));
0264     colormap(hist_colors);
0265     freezeColors;
0266     set(gca,<span class="string">'ydir'</span>,<span class="string">'normal'</span>,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="string">'xtick'</span>,[],<span class="string">'ytick'</span>,[min_f max_f],<span class="string">'linewidth'</span>,1.5,<span class="string">'ticklength'</span>,[.025 .025],<span class="keyword">...</span>
0267         <span class="string">'FontSize'</span>,16,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0268     ylim([min_f max_f]);
0269     box off;
0270     title({[ figtitle ];[ <span class="string">'Channel '</span> num2str(LABEL(i))]},<span class="string">'FontSize'</span>,18,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0271 
0272     ax(2)=subaxis(6,1,1,3,1,1,<span class="string">'spacingvert'</span>,0,<span class="string">'margin'</span>,0.1,<span class="string">'paddingbottom'</span>,.025);
0273     plot(TIME,mean_osc,<span class="string">'-k'</span>);
0274     ylabel(<span class="string">'Osc.'</span>,<span class="string">'FontSize'</span>,20,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0275     axis tight;
0276     set(gca,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="string">'xtick'</span>,[],<span class="string">'ytick'</span>,[]);
0277 
0278     <span class="comment">% any trials to exclude?</span>
0279 
0280     reject=<a href="../ephys/helpers/ephys/hampel_filter.html" class="code" title="function [REJECTS]=hampel_filter(INPUTDATA,varargin)">hampel_filter</a>(MUA.image(:,:,i)',<span class="string">'hampel_factor'</span>,3);
0281     goodtrials=setdiff(MUA.trials,reject);
0282 
0283     ax(3)=subaxis(6,1,1,4,1,3,<span class="string">'spacingvert'</span>,0.025,<span class="string">'margin'</span>,0.1,<span class="string">'paddingbottom'</span>,0);
0284     imagesc(MUA.t,MUA.trials(goodtrials),MUA.image(goodtrials,:,i));
0285     axis tight;
0286     colormap(mua_colors);
0287     freezeColors;
0288     <span class="comment">%plot(t,data(:,channelvis(i))-mean(data,2));</span>
0289     ylabel(<span class="string">'Hz'</span>);
0290     xlabel(<span class="string">'Time (in s)'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0291     ylabel(<span class="string">'Trial'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0292     box off
0293     set(gca,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="string">'linewidth'</span>,1.5,<span class="string">'ticklength'</span>,[.025 .025],<span class="string">'FontSize'</span>,11,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0294 
0295     linkaxes(ax,<span class="string">'x'</span>);
0296 
0297     [path,name,ext]=fileparts(dir);
0298 
0299     <span class="keyword">if</span> ~isempty(figtitle)
0300         name=figtitle;
0301     <span class="keyword">end</span>
0302 
0303     set(raster_fig,<span class="string">'PaperPositionMode'</span>,<span class="string">'auto'</span>)
0304 
0305     <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(raster_fig,fullfile(dir,<span class="string">'mua_bin'</span>),<span class="keyword">...</span>
0306         [ name <span class="string">'_mua_freqrange_'</span> num2str(freq_range) <span class="string">'_electrode_'</span> num2str(CHANNELS(channels(i)))],<span class="string">'eps,png'</span>);
0307     close([raster_fig]);
0308 
0309 <span class="keyword">end</span>
0310 
0311 save(fullfile(dir,<span class="string">'mua_bin'</span>,<span class="string">'mua.mat'</span>),<span class="string">'MUA'</span>,<span class="string">'LABEL'</span>,<span class="string">'TIME'</span>,<span class="string">'HISTOGRAM'</span>,<span class="string">'EPHYS_DATA'</span>,<span class="string">'freq_range'</span>,<span class="string">'channels'</span>);
0312</pre></div>
<hr><address>Generated on Thu 19-Jul-2012 21:29:37 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>