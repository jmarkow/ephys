<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ephys_visual_sua</title>
  <meta name="keywords" content="ephys_visual_sua">
  <meta name="description" content="generates song-aligned single-unit rasters">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../menu.html">Home</a> &gt;  <a href="menu.html">ephys</a> &gt; ephys_visual_sua.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../menu.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for ephys&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>ephys_visual_sua
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>generates song-aligned single-unit rasters</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function ephys_visual_sua(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">generates song-aligned single-unit rasters

    [MUA TIME LABEL HISTOGRAM]=ephys_visual_sua(MIC_DATA,EPHYS_DATA,CHANNELS,varargin)

    MIC_DATA
    aligned microphrone traces from extracted_data.mat (should be the variable mic_data)

    HISTOGRAM
    contour histogram returned by ephys_visual_histogram.m (or loaded from histogram.mat)

    CHANNELS
    channel labels (i.e. the channel that corresponds to a given element in the cell array
    ephys_data) from extracted_data.mat

    the following may be specified as parameter/value pairs:

        tetrode_channels
        channels may act as a putative n-trode (can specify an arbitrary number of channels),
        defaults to manual cluster cutting

        car_exclude
        carelectrodes to exclude from noise estimate

        SR
        data sampling rate (default: 25e3)
        
        noise
        noise rejection method ('car' for common average 'nn' for nearest neighbor, or 'none',
        default: 'none')

        freq_range
        vector with two elements to specify the frequency range (one element specifies low pass, default: [500 8e3])

        savedir
        directory to store results (default: pwd)

        min_f
        lowermost frequency to display for contour histogram (default: 1e3)

        max_f
        uppermost frequency to display for contour histogram (default: 10e3)

        auto_clust
        perform automated cluster cutting via fitting a GMM through EM (default: 0)

        sigma_t
        multiple of variance estimate for automatic threshold setting (uses the Quiroga formulation, default: 4)

        singletrials
        number of singletrials to plot

        savedir
        directory to store results (default: pwd)

        subtrials
        vector of trials to include in the analysis (default: all trials)


 see also <a href="ephys_visual_mua.html" class="code" title="function [MUA TIME LABEL HISTOGRAM]=ephys_visual_mua(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)">ephys_visual_mua</a>.m,<a href="ephys_visual_lfp_amp.html" class="code" title="function [LFP_RASTER TIME LABEL HISTOGRAM]=ephys_lfp_amp(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)">ephys_visual_lfp_amp</a>.m,<a href="ephys_visual_lfp_tf.html" class="code" title="function [SPECT_AVE]=ephys_visual_lfp_tf(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)">ephys_visual_lfp_tf</a>.m,ephys_cluster_auto.m,ephys_clustergui_tetrode.m,ephys_spike_detect.m</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>	conditions signals for further processing</li><li><a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>	takes ephys data from Intan recordings and re-references</li><li><a href="../ephys/helpers/ephys/ephys_ifr.html" class="code" title="function IFRVEC=ephys_ifr(SPIKETIMES,TIMEVECTOR,SR)">ephys_ifr</a>	computes IFR per the Hahnloser et al. 2001 definition</li><li><a href="../ephys/helpers/ephys/ephys_spike_cluster_auto.html" class="code" title="function [LABELS TRIALS ISI WINDOWS]=ephys_spike_cluster_auto(SPIKEWINDOWS,SPIKETIMES,varargin)">ephys_spike_cluster_auto</a>	automated spike clustering using a GMM with EM</li><li><a href="../ephys/helpers/ephys/ephys_spike_clustergui_tetrode.html" class="code" title="function [LABELS TRIALS ISI WINDOWS]=ephys_spike_clustergui_tetrode(SPIKEWINDOWS,SPIKETIMES,varargin)">ephys_spike_clustergui_tetrode</a>	GUI for spike cluster cutting</li><li><a href="../ephys/helpers/ephys/ephys_spike_detect.html" class="code" title="function [SPIKES_PP SPIKES_PB]=ephys_spike_detect(DATA,THRESH,varargin)">ephys_spike_detect</a>	ephys_spike_detect.m performs spike detection on a vector with a pre-determined</li><li><a href="../ephys/helpers/visualization/ephys_visual_spikestats.html" class="code" title="function fig_num=ephys_visual_spikestats(SPIKEWINDOWS,SPIKEISI,varargin)">ephys_visual_spikestats</a>	spike statistics figure, include 2D histogram and ISI distribution</li><li><a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>	save in multiple formats in a single command</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../ephys/pipeline/ephys_pipeline_sua_standalone.html" class="code" title="function ephys_lfp_standalone(PROCDIR,CONFIG)">ephys_pipeline_sua_standalone</a>	</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function ephys_visual_sua(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)</a>
0002 <span class="comment">%generates song-aligned single-unit rasters</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%    [MUA TIME LABEL HISTOGRAM]=ephys_visual_sua(MIC_DATA,EPHYS_DATA,CHANNELS,varargin)</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%    MIC_DATA</span>
0007 <span class="comment">%    aligned microphrone traces from extracted_data.mat (should be the variable mic_data)</span>
0008 <span class="comment">%</span>
0009 <span class="comment">%    HISTOGRAM</span>
0010 <span class="comment">%    contour histogram returned by ephys_visual_histogram.m (or loaded from histogram.mat)</span>
0011 <span class="comment">%</span>
0012 <span class="comment">%    CHANNELS</span>
0013 <span class="comment">%    channel labels (i.e. the channel that corresponds to a given element in the cell array</span>
0014 <span class="comment">%    ephys_data) from extracted_data.mat</span>
0015 <span class="comment">%</span>
0016 <span class="comment">%    the following may be specified as parameter/value pairs:</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%        tetrode_channels</span>
0019 <span class="comment">%        channels may act as a putative n-trode (can specify an arbitrary number of channels),</span>
0020 <span class="comment">%        defaults to manual cluster cutting</span>
0021 <span class="comment">%</span>
0022 <span class="comment">%        car_exclude</span>
0023 <span class="comment">%        carelectrodes to exclude from noise estimate</span>
0024 <span class="comment">%</span>
0025 <span class="comment">%        SR</span>
0026 <span class="comment">%        data sampling rate (default: 25e3)</span>
0027 <span class="comment">%</span>
0028 <span class="comment">%        noise</span>
0029 <span class="comment">%        noise rejection method ('car' for common average 'nn' for nearest neighbor, or 'none',</span>
0030 <span class="comment">%        default: 'none')</span>
0031 <span class="comment">%</span>
0032 <span class="comment">%        freq_range</span>
0033 <span class="comment">%        vector with two elements to specify the frequency range (one element specifies low pass, default: [500 8e3])</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%        savedir</span>
0036 <span class="comment">%        directory to store results (default: pwd)</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%        min_f</span>
0039 <span class="comment">%        lowermost frequency to display for contour histogram (default: 1e3)</span>
0040 <span class="comment">%</span>
0041 <span class="comment">%        max_f</span>
0042 <span class="comment">%        uppermost frequency to display for contour histogram (default: 10e3)</span>
0043 <span class="comment">%</span>
0044 <span class="comment">%        auto_clust</span>
0045 <span class="comment">%        perform automated cluster cutting via fitting a GMM through EM (default: 0)</span>
0046 <span class="comment">%</span>
0047 <span class="comment">%        sigma_t</span>
0048 <span class="comment">%        multiple of variance estimate for automatic threshold setting (uses the Quiroga formulation, default: 4)</span>
0049 <span class="comment">%</span>
0050 <span class="comment">%        singletrials</span>
0051 <span class="comment">%        number of singletrials to plot</span>
0052 <span class="comment">%</span>
0053 <span class="comment">%        savedir</span>
0054 <span class="comment">%        directory to store results (default: pwd)</span>
0055 <span class="comment">%</span>
0056 <span class="comment">%        subtrials</span>
0057 <span class="comment">%        vector of trials to include in the analysis (default: all trials)</span>
0058 <span class="comment">%</span>
0059 <span class="comment">%</span>
0060 <span class="comment">% see also ephys_visual_mua.m,ephys_visual_lfp_amp.m,ephys_visual_lfp_tf.m,ephys_cluster_auto.m,ephys_clustergui_tetrode.m,ephys_spike_detect.m</span>
0061 
0062 
0063 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PARAMETER COLLECTION %%%%%%%%%%%%%%%%%</span>
0064 
0065 <span class="keyword">if</span> nargin&lt;3 | isempty(CHANNELS), CHANNELS=1:16; <span class="keyword">end</span>
0066 
0067 nparams=length(varargin);
0068 
0069 <span class="keyword">if</span> mod(nparams,2)&gt;0
0070     error(<span class="string">'Parameters must be specified as parameter/value pairs'</span>);
0071 <span class="keyword">end</span>
0072 
0073 SR=25e3;
0074 noise=<span class="string">'none'</span>; <span class="comment">% common-average reference for noise removal</span>
0075 car_exclude=[];
0076 savedir=pwd;
0077 min_f=1e3;
0078 max_f=10e3;
0079 hist_colors=<span class="string">'jet'</span>;
0080 figtitle=<span class="string">''</span>;
0081 freq_range=[500 8000]; <span class="comment">% frequency range for filtering</span>
0082 sort=1; <span class="comment">% do we want to sort?</span>
0083 auto_clust=0;
0084 tetrode_channels=[];
0085 sigma_t=4;
0086 singletrials=10; <span class="comment">% number of random single trials to plot per cluster</span>
0087 subtrials=[];
0088 align=<span class="string">'com'</span>; <span class="comment">% how to align spike waveforms can be min for minimum peak or COM</span>
0089 
0090 <span class="comment">% parameter for smooth density estimate</span>
0091 
0092 smooth_rate=1e3;
0093 sigma=.0025;
0094 
0095 colors={<span class="string">'b'</span>,<span class="string">'r'</span>,<span class="string">'g'</span>,<span class="string">'c'</span>,<span class="string">'m'</span>,<span class="string">'y'</span>,<span class="string">'k'</span>,<span class="string">'r'</span>,<span class="string">'g'</span>,<span class="string">'b'</span>};
0096 
0097 <span class="keyword">for</span> i=1:2:nparams
0098     <span class="keyword">switch</span> lower(varargin{i})
0099         <span class="keyword">case</span> <span class="string">'sr'</span>
0100             SR=varargin{i+1};
0101         <span class="keyword">case</span> <span class="string">'noise'</span>
0102             noise=varargin{i+1};
0103         <span class="keyword">case</span> <span class="string">'sigma_t'</span>
0104             sigma_t=varargin{i+1};
0105         <span class="keyword">case</span> <span class="string">'filtering'</span>
0106             filtering=varargin{i+1};
0107         <span class="keyword">case</span> <span class="string">'savedir'</span>
0108             savedir=varargin{i+1};
0109         <span class="keyword">case</span> <span class="string">'min_f'</span>
0110             min_f=varargin{i+1};
0111         <span class="keyword">case</span> <span class="string">'max_f'</span>
0112             max_f=varargin{i+1};
0113         <span class="keyword">case</span> <span class="string">'hist_colors'</span>
0114             hist_colors=varargin{i+1};
0115         <span class="keyword">case</span> <span class="string">'car_exclude'</span>
0116             car_exclude=varargin{i+1};
0117         <span class="keyword">case</span> <span class="string">'figtitle'</span>
0118             figtitle=varargin{i+1};
0119         <span class="keyword">case</span> <span class="string">'freq_range'</span>
0120             freq_range=varargin{i+1};
0121         <span class="keyword">case</span> <span class="string">'sort'</span>
0122             sort=varargin{i+1};
0123         <span class="keyword">case</span> <span class="string">'channels'</span>
0124             channels=varargin{i+1};
0125         <span class="keyword">case</span> <span class="string">'tetrode_channels'</span>
0126             tetrode_channels=varargin{i+1};
0127         <span class="keyword">case</span> <span class="string">'auto_clust'</span>
0128             auto_clust=varargin{i+1};
0129         <span class="keyword">case</span> <span class="string">'sigma_t'</span>
0130             sigma_t=varargin{i+1};
0131         <span class="keyword">case</span> <span class="string">'subtrials'</span>
0132             subtrials=varargin{i+1};
0133         <span class="keyword">case</span> <span class="string">'align'</span>
0134             align=varargin{i+1};
0135     <span class="keyword">end</span>
0136 <span class="keyword">end</span>
0137 
0138 
0139 startidx=max([find(HISTOGRAM.f&lt;=min_f)]);
0140 stopidx=min([find(HISTOGRAM.f&gt;=max_f)]);
0141 
0142 <span class="keyword">if</span> max_f&gt;SR/2
0143     disp(<span class="string">'Maximum Fs must be less than Nyquist!'</span>);
0144     disp(<span class="string">'Resetting max fs'</span>);
0145     max_f==SR/2;
0146 <span class="keyword">end</span>
0147 
0148 [samples,ntrials,ncarelectrodes]=size(EPHYS_DATA);
0149 proc_data=zeros(samples,ntrials,length(channels));
0150 
0151 <span class="keyword">if</span> isempty(subtrials)
0152     subtrials=1:ntrials;
0153 <span class="keyword">end</span>
0154 
0155 TIME=[1:samples]./SR; <span class="comment">% time vector for plotting</span>
0156 
0157 <span class="comment">% kernel density estimate of smooth firing rate</span>
0158 
0159 kernedges=[-3*sigma:1/smooth_rate:3*sigma];
0160 binedges=[0:(1/smooth_rate):samples/SR];
0161 
0162 smooth_spikes.time=binedges;
0163 
0164 <span class="keyword">if</span> exist(<span class="string">'normpdf'</span>)&gt;0
0165     kernel=normpdf(kernedges,0,sigma);
0166 <span class="keyword">else</span>
0167     kernel=(1/(sigma*sqrt(2*pi)))*exp((-(kernedges-0).^2)./(2*sigma^2));
0168 <span class="keyword">end</span>
0169 
0170 
0171 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0172 
0173 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SIGNAL CONDITIONING %%%%%%%%%%%%%%%%</span>
0174 
0175 proc_data=<a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>(EPHYS_DATA,CHANNELS,channels,<span class="string">'method'</span>,noise,<span class="string">'car_exclude'</span>,car_exclude);
0176 proc_data=<a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>(proc_data,<span class="string">'s'</span>,<span class="string">'freq_range'</span>,freq_range);
0177 
0178 <span class="keyword">if</span> ~isempty(tetrode_channels)
0179     tetrode_data=<a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>(EPHYS_DATA,CHANNELS,tetrode_channels,<span class="string">'method'</span>,noise,<span class="string">'car_exclude'</span>,car_exclude);
0180     tetrode_data=<a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>(tetrode_data,<span class="string">'s'</span>,<span class="string">'freq_range'</span>,freq_range);
0181 <span class="keyword">else</span>
0182     tetrode_data=[];
0183 <span class="keyword">end</span>
0184 
0185 clear EPHYS_DATA;
0186 
0187 proc_data=proc_data(:,subtrials,:);
0188 
0189 <span class="keyword">if</span> ~isempty(tetrode_channels)
0190     tetrode_data=tetrode_data(:,subtrials,:);
0191 <span class="keyword">end</span>
0192 [samples,ntrials,newchannels]=size(proc_data);
0193 
0194 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0195 
0196 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SPIKE DETECTION %%%%%%%%%%%%%%%%%%%%</span>
0197 
0198 disp(<span class="string">'Entering spike detection...'</span>);
0199 
0200 <span class="comment">% need a noise cutoff...let's start with 3*std or Quiroga's measure</span>
0201 
0202 <span class="keyword">for</span> i=1:length(channels)
0203 
0204     disp([<span class="string">'Electrode '</span> num2str(channels(i))])
0205 
0206     <span class="keyword">if</span> ~isempty(tetrode_channels)
0207         disp([<span class="string">'Will use tetrode channels '</span> num2str(tetrode_channels) <span class="string">' for sorting'</span>]);
0208     <span class="keyword">end</span>
0209 
0210     <span class="comment">% collect spikes</span>
0211 
0212     tmp_spikewindows={};
0213     tmp_spiketimes={};
0214 
0215     sort_data=cat(3,proc_data(:,:,i),tetrode_data);
0216 
0217     parfor j=1:ntrials
0218         
0219 
0220         spike_pp=[];
0221         spikeless_data=[];
0222 
0223         threshold=sigma_t*median(abs(proc_data(:,j,i))/.6745);
0224         <span class="comment">%disp([num2str(threshold)]);</span>
0225         spike_pp=<a href="../ephys/helpers/ephys/ephys_spike_detect.html" class="code" title="function [SPIKES_PP SPIKES_PB]=ephys_spike_detect(DATA,THRESH,varargin)">ephys_spike_detect</a>(sort_data(:,j,:),threshold,<span class="string">'sr'</span>,SR,<span class="string">'visualize'</span>,<span class="string">'n'</span>,<span class="string">'align'</span>,align);
0226 
0227         <span class="comment">% after spike detect also collect trace without spikes</span>
0228 
0229         [winsamples,nspikes,tetrodes]=size(spike_pp.abs.windows);
0230 
0231         <span class="keyword">if</span> nspikes&lt;2
0232             spikeless_data=NaN;
0233             <span class="keyword">continue</span>;
0234         <span class="keyword">end</span>
0235 
0236         <span class="comment">% if tetrode then check each channel for significant spike</span>
0237 
0238         window=floor((winsamples-1)/2); <span class="comment">% how many samples to the left and right of the spike</span>
0239 
0240         <span class="comment">% should we delete?</span>
0241 
0242         adjust=0;
0243 
0244         <span class="comment">% compute the peak to peak of the mean waveform</span>
0245     
0246         spikeless_data=proc_data(:,j,i);
0247 
0248         <span class="comment">% eliminate each spike from the data</span>
0249 
0250         <span class="keyword">for</span> k=1:nspikes
0251 
0252             spike_point=spike_pp.abs.times(k)-adjust;
0253 
0254             <span class="keyword">if</span> spike_point-window&lt;1
0255                 spikeless_data=NaN;
0256                 <span class="keyword">break</span>;
0257             <span class="keyword">end</span>
0258 
0259             spikeless_data(spike_point-window:spike_point+window)=[];
0260             adjust=adjust+((window*2)+1);
0261         <span class="keyword">end</span>
0262 
0263         tmp_spiketimes{j}=spike_pp.abs.times;
0264         tmp_spikewindows{j}=spike_pp.abs.windows;
0265         tmp_threshold(j)=threshold;
0266         tmp_spikeless{j}=spikeless_data;
0267     
0268     <span class="keyword">end</span>
0269 
0270     clear sort_data;
0271 
0272     spikewindows{i}=tmp_spikewindows;
0273     spikeless{i}=tmp_spikeless;
0274     spiketimes{i}=tmp_spiketimes;
0275     threshold(i,:)=tmp_threshold;
0276     
0277     [winsamples,trials,tetrodes]=size(spikewindows{1}{1});
0278 
0279     <span class="keyword">if</span> tetrodes&gt;1
0280         tetrode_preview=figure(<span class="string">'Name'</span>,<span class="string">'Tetrode Preview'</span>,<span class="string">'Visible'</span>,<span class="string">'off'</span>);
0281         subplot(tetrodes,1,1);
0282         plot(spikewindows{1}{1}(:,:,1));
0283         title([<span class="string">'Channel '</span> num2str(CHANNELS(channels(i)))]);
0284         axis tight;
0285         <span class="keyword">for</span> k=1:tetrodes-1
0286             subplot(tetrodes,1,k+1);
0287             plot(spikewindows{1}{1}(:,:,k+1));
0288             title([<span class="string">'Channel '</span> num2str(tetrode_channels(k))]);
0289             axis tight
0290         <span class="keyword">end</span>
0291         set(tetrode_preview,<span class="string">'Visible'</span>,<span class="string">'on'</span>);
0292         pause();
0293         close([tetrode_preview]);
0294     <span class="keyword">end</span>
0295 <span class="keyword">end</span>
0296 
0297 
0298 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0299 
0300 
0301 <span class="comment">% simplest way to draw raster...plot([sample;sample]</span>
0302 <span class="comment">% vector of times [120 130 200;120 130 200], then next vector specifies bottom and top of tickmark</span>
0303 <span class="comment">% e.g. [1.5 1.5 1.5;.5 .5 .5] for trial 1, etc.</span>
0304 
0305 <span class="comment">% collapse spike windows into a single matrix, get cluster ids back and then</span>
0306 <span class="comment">% change color according to ID</span>
0307 
0308 disp(<span class="string">'Generating figures...'</span>);
0309 disp([<span class="string">'Will save to directory:  '</span> savedir]);
0310 
0311 <span class="comment">% scale pixels by time</span>
0312 <span class="comment">% now we have clusterid and the trial for all spikes, we need to color them appropriately</span>
0313 
0314 [path,name,ext]=fileparts(fullfile(savedir));
0315 savefilename=[ name <span class="string">'_sua_freqrange_'</span> num2str(freq_range) <span class="string">'_electrode_'</span> ];
0316 
0317 savedir=fullfile(savedir,<span class="string">'sua'</span>);
0318 
0319 <span class="keyword">if</span> ~exist(savedir,<span class="string">'dir'</span>)
0320     mkdir(fullfile(savedir));
0321 <span class="keyword">end</span>
0322 
0323 
0324 
0325 
0326 
0327 <span class="keyword">for</span> i=1:length(channels)
0328 
0329     <span class="comment">% [time;time] [trial+.5;trial-.5]</span>
0330 
0331     
0332 
0333     disp([<span class="string">'Channel '</span> num2str(channels(i))]);
0334 
0335     <span class="keyword">if</span> sort
0336         <span class="keyword">if</span> auto_clust
0337             [clusterid clustertrial clusterisi clusterwindows]=<a href="../ephys/helpers/ephys/ephys_spike_cluster_auto.html" class="code" title="function [LABELS TRIALS ISI WINDOWS]=ephys_spike_cluster_auto(SPIKEWINDOWS,SPIKETIMES,varargin)">ephys_spike_cluster_auto</a>(spikewindows{i},spiketimes{i},<span class="string">'sr'</span>,SR);
0338         <span class="keyword">else</span>
0339             [clusterid clustertrial clusterisi clusterwindows]=<a href="../ephys/helpers/ephys/ephys_spike_clustergui_tetrode.html" class="code" title="function [LABELS TRIALS ISI WINDOWS]=ephys_spike_clustergui_tetrode(SPIKEWINDOWS,SPIKETIMES,varargin)">ephys_spike_clustergui_tetrode</a>(spikewindows{i},spiketimes{i},<span class="string">'sr'</span>,SR);
0340         <span class="keyword">end</span>
0341 
0342         <span class="keyword">if</span> isempty(clusterid)
0343             disp(<span class="string">'No labels returned, bailing...'</span>);
0344             <span class="keyword">return</span>;
0345         <span class="keyword">end</span>
0346 
0347     <span class="keyword">else</span>
0348         clusterid=[];
0349     <span class="keyword">end</span>
0350 
0351     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0352 
0353 
0354     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% IFR, SMOOTH RATE %%%%%%%%%%%%%%%%%%%</span>
0355 
0356 
0357     uniq_clusters=unique(clusterid);
0358 
0359     <span class="keyword">if</span> ~isempty(clusterid)
0360     
0361         <span class="comment">% cycle through each cluster id</span>
0362 
0363         <span class="keyword">for</span> j=1:length(uniq_clusters)
0364 
0365             IFR{i}{j}=zeros(ntrials,samples);
0366             spike_vec{j}=[];
0367             trial_vec{j}=[];
0368 
0369             <span class="keyword">for</span> k=1:ntrials
0370 
0371                 <span class="comment">% grab the spike labels for this electrode and trial</span>
0372 
0373                 currids=clusterid(find(clustertrial==k));
0374 
0375                 <span class="comment">% get the spike times (in seconds)</span>
0376 
0377                 currspikes=spiketimes{i}{k};
0378             
0379                 <span class="comment">% now grab the spikes for THIS CLUSTER only</span>
0380 
0381                 clusterspikes=currspikes(find(currids==uniq_clusters(j)));
0382                 
0383                 <span class="comment">% IFR will use the current sampling rate</span>
0384                 
0385                 IFR{i}{j}(k,:)=<a href="../ephys/helpers/ephys/ephys_ifr.html" class="code" title="function IFRVEC=ephys_ifr(SPIKETIMES,TIMEVECTOR,SR)">ephys_ifr</a>(round(clusterspikes),samples,SR);
0386 
0387                 clusterspikes=clusterspikes./SR;
0388                 
0389                 tmp=repmat(clusterspikes,2,1);
0390                 spike_vec{j}=[spike_vec{j} tmp];
0391 
0392                 tmp=[k+.3;k-.3];
0393                 tmp=repmat(tmp,1,length(clusterspikes));
0394                 trial_vec{j}=[trial_vec{j} tmp];
0395 
0396                 <span class="comment">% for storage resort the spike vector by cluster</span>
0397 
0398                 clust_spike_vec{i}{j}{k}=clusterspikes;
0399 
0400                 binned_spikes=histc(clusterspikes,binedges);
0401                 smooth_spikes.density{j}(k,:)=conv(binned_spikes,kernel,<span class="string">'same'</span>);
0402 
0403 
0404             <span class="keyword">end</span>
0405         <span class="keyword">end</span>
0406     <span class="keyword">else</span>
0407 
0408         clust_spike_vec=[];
0409         spike_vec{1}=[];
0410         trial_vec{1}=[];
0411 
0412         <span class="keyword">for</span> j=1:ntrials
0413 
0414             <span class="comment">% now for each trial, we need to label the spikes appropriately,</span>
0415             <span class="comment">% first sort by id</span>
0416 
0417             <span class="comment">% find command is already sorted, ascending</span>
0418 
0419             tmp=repmat(spiketimes{i}{j},2,1)./SR;
0420             spike_vec{1}=[spike_vec{1} tmp];
0421 
0422             tmp=[j+.3;j-.3];
0423             tmp=repmat(tmp,1,length(spiketimes{i}{j}));
0424             trial_vec{1}=[trial_vec{1} tmp];
0425 
0426             binned_spikes=histc(spiketimes{i}{j},binedges);
0427             smooth_spikes{1}(j,:)=conv(binned_spikes,kernel,<span class="string">'same'</span>);
0428 
0429         <span class="keyword">end</span>
0430 
0431     <span class="keyword">end</span>
0432 
0433     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0434 
0435 
0436     <span class="keyword">if</span> ~isempty(uniq_clusters)
0437         nplots=length(uniq_clusters);
0438     <span class="keyword">else</span>
0439         nplots=1;
0440     <span class="keyword">end</span>
0441 
0442     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% STATS PLOTTING %%%%%%%%%%%%%%%%%%%%%</span>
0443 
0444 
0445     <span class="comment">% plot the spike stats</span>
0446 
0447     savefilename_stats=[ savefilename num2str(channels(i))<span class="keyword">...</span>
0448                    <span class="string">'_stats_cluster_'</span>];
0449 
0450     <span class="comment">% delete all old files</span>
0451 
0452     delete(fullfile(savedir,[ <span class="string">'*_sua_freqrange*electrode_'</span> num2str(channels(i)) <span class="string">'*'</span>]));
0453     
0454     <span class="keyword">if</span> ~isempty(clusterid)
0455 
0456         <span class="comment">% delete old stats figures if they exist</span>
0457 
0458         delete(fullfile(savedir,[savefilename_stats <span class="string">'*.png'</span>]));
0459         delete(fullfile(savedir,[savefilename_stats <span class="string">'*.eps'</span>]));
0460 
0461         <span class="keyword">for</span> j=1:length(uniq_clusters)
0462 
0463             <span class="comment">% estimate SNR from 6*std of spikeless trace</span>
0464 
0465             ntrials=length(spikeless{i});
0466 
0467             <span class="keyword">for</span> k=1:ntrials
0468                 noise_p2p(k)=6*std(spikeless{i}{k});
0469             <span class="keyword">end</span>
0470 
0471             noise_p2p(isnan(noise_p2p))=[];
0472             mean_noise_p2p=mean(noise_p2p);
0473             stats_fig=<a href="../ephys/helpers/visualization/ephys_visual_spikestats.html" class="code" title="function fig_num=ephys_visual_spikestats(SPIKEWINDOWS,SPIKEISI,varargin)">ephys_visual_spikestats</a>(clusterwindows{uniq_clusters(j)},clusterisi{uniq_clusters(j)},<span class="keyword">...</span>
0474                 <span class="string">'noise_p2p'</span>,mean_noise_p2p,<span class="string">'sr'</span>,25e3,<span class="string">'spike_sr'</span>,50e3);
0475 
0476             <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(stats_fig,savedir,<span class="keyword">...</span>
0477                 [ savefilename_stats num2str(uniq_clusters(j))],<span class="string">'eps,png'</span>);
0478             close([stats_fig]);
0479 
0480         <span class="keyword">end</span>
0481     <span class="keyword">end</span>
0482 
0483     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0484 
0485 
0486     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% RASTER PLOTTING %%%%%%%%%%%%%%%%%%%%%</span>
0487 
0488     savefilename_raster=[ savefilename num2str(channels(i))<span class="keyword">...</span>
0489                    <span class="string">'_raster_cluster_'</span>];
0490 
0491     ax=[];
0492 
0493     <span class="comment">% delete any old single trial plots</span>
0494 
0495     <span class="keyword">if</span> exist(fullfile(savedir,<span class="string">'singletrials'</span>,[<span class="string">'ch'</span> num2str(channels(i)) ]),<span class="string">'dir'</span>)
0496         rmdir(fullfile(savedir,<span class="string">'singletrials'</span>,[<span class="string">'ch'</span> num2str(channels(i)) ]),<span class="string">'s'</span>);
0497     <span class="keyword">end</span>
0498 
0499     <span class="keyword">for</span> j=1:length(uniq_clusters)
0500 
0501         raster_fig=figure(<span class="string">'visible'</span>,<span class="string">'off'</span>,<span class="string">'Units'</span>,<span class="string">'Pixels'</span>,<span class="string">'Position'</span>,[0 0 600 800]);
0502         ax(1)=subaxis(6,1,1,1,1,2,<span class="string">'margin'</span>,.1,<span class="string">'spacingvert'</span>,0);
0503         imagesc(HISTOGRAM.t,HISTOGRAM.f(startidx:stopidx),HISTOGRAM.imask(startidx:stopidx,:));
0504         colormap(hist_colors);
0505         freezeColors;
0506         set(gca,<span class="string">'ydir'</span>,<span class="string">'normal'</span>,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="string">'xtick'</span>,[],<span class="string">'ytick'</span>,[min_f max_f],<span class="string">'linewidth'</span>,1.5,<span class="string">'ticklength'</span>,[.025 .025],<span class="keyword">...</span>
0507             <span class="string">'FontSize'</span>,11,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0508         ylim([min_f max_f]);
0509         box off;
0510         title({[ figtitle ];[ <span class="string">'Channel '</span> num2str(channels(i))]},<span class="string">'FontSize'</span>,18,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0511 
0512         ax(2)=subaxis(6,1,1,3,1,1,<span class="string">'spacingvert'</span>,0,<span class="string">'margin'</span>,0.1,<span class="string">'paddingbottom'</span>,.025);
0513         plot(TIME,HISTOGRAM.mean_osc,<span class="string">'-k'</span>);
0514         ylabel(<span class="string">'Osc.'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0515         axis tight;
0516         set(gca,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="string">'xtick'</span>,[],<span class="string">'ytick'</span>,[]);
0517 
0518         ax(3)=subaxis(6,1,1,4,1,3,<span class="string">'spacingvert'</span>,0.025,<span class="string">'margin'</span>,0.1,<span class="string">'paddingbottom'</span>,0);
0519 
0520         plot(spike_vec{j},trial_vec{j},<span class="string">'-'</span>,<span class="string">'color'</span>,<span class="string">'k'</span>);    
0521         axis([0 TIME(end) 0 ntrials+1]);
0522         xlabel(<span class="string">'Time (in s)'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0523         ylabel(<span class="string">'Trial'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0524         box off
0525         set(gca,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="string">'linewidth'</span>,1.5,<span class="string">'ticklength'</span>,[.025 .025],<span class="string">'FontSize'</span>,11,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>,<span class="string">'ydir'</span>,<span class="string">'rev'</span>);
0526 
0527         linkaxes(ax,<span class="string">'x'</span>);
0528 
0529         <span class="keyword">if</span> ~isempty(figtitle)
0530             name=figtitle;
0531         <span class="keyword">end</span>
0532 
0533         set(raster_fig,<span class="string">'PaperPositionMode'</span>,<span class="string">'auto'</span>);
0534         <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(raster_fig,savedir,<span class="keyword">...</span>
0535             [ savefilename_raster num2str(uniq_clusters(j)) ],<span class="string">'eps,png'</span>);
0536         close([raster_fig]);
0537 
0538         <span class="comment">% generate single trial plots, simply the spikes marked along with the filtered traces</span>
0539 
0540         population=[1:ntrials];
0541         randtrials=population(randsample(ntrials,singletrials));
0542 
0543         singletrialdir=fullfile(savedir,<span class="string">'singletrials'</span>,[<span class="string">'ch'</span> num2str(channels(i)) ],[ <span class="string">'clust'</span> num2str(j)]);
0544 
0545         <span class="keyword">if</span> ~exist(fullfile(singletrialdir),<span class="string">'dir'</span>);
0546             mkdir(singletrialdir);
0547         <span class="keyword">end</span>
0548 
0549         <span class="keyword">if</span> ~isempty(clusterid)
0550 
0551             disp(<span class="string">'Plotting single trials'</span>);
0552 
0553             <span class="keyword">for</span> k=1:singletrials
0554 
0555                 singletrialfig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>);
0556                 idx=randtrials(k);
0557                 currspikes=clust_spike_vec{i}{j}{idx};
0558                 plot(TIME,proc_data(:,idx,i),<span class="string">'k-'</span>);
0559                 hold on
0560                 plot(currspikes,proc_data(round(currspikes*SR),idx,i),<span class="string">'r*'</span>);
0561                 set(gca,<span class="string">'TickDir'</span>,<span class="string">'out'</span>,<span class="string">'TickLength'</span>,[.02 .02],<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>,<span class="string">'FontSize'</span>,11);
0562                 xlabel(<span class="string">'Time (s)'</span>,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>);
0563                 ylabel(<span class="string">'Voltage ($\mu$V)'</span>,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>);
0564                 box off
0565                 axis tight
0566                 <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(singletrialfig,singletrialdir,[<span class="string">'trial'</span> num2str(idx)],<span class="string">'eps,png'</span>);
0567 
0568                 close([singletrialfig]);
0569 
0570             <span class="keyword">end</span>
0571         <span class="keyword">end</span>
0572     <span class="keyword">end</span>
0573 
0574     <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0575 
0576 <span class="keyword">end</span>
0577 
0578 <span class="keyword">if</span> sort 
0579     save(fullfile(savedir,[<span class="string">'sua_channels '</span> num2str(channels) <span class="string">'.mat'</span>]),<span class="string">'clusterid'</span>,<span class="string">'clustertrial'</span>,<span class="string">'clusterisi'</span>,<span class="string">'clusterwindows'</span>,<span class="keyword">...</span>
0580         <span class="string">'threshold'</span>,<span class="string">'CHANNELS'</span>,<span class="string">'channels'</span>,<span class="string">'TIME'</span>,<span class="string">'proc_data'</span>,<span class="string">'freq_range'</span>,<span class="string">'clust_spike_vec'</span>,<span class="string">'smooth_spikes'</span>,<span class="string">'spikeless'</span>,<span class="string">'IFR'</span>,<span class="string">'subtrials'</span>);<span class="keyword">else</span>
0581     save(fullfile(savedir,[<span class="string">'sua_channels '</span> num2str(channels) <span class="string">'.mat'</span>]),<span class="string">'threshold'</span>,<span class="string">'CHANNELS'</span>,<span class="string">'channels'</span>,<span class="string">'TIME'</span>,<span class="string">'proc_data'</span>,<span class="string">'freq_range'</span>);
0582 <span class="keyword">end</span>
0583</pre></div>
<hr><address>Generated on Sun 22-Jul-2012 12:37:58 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>