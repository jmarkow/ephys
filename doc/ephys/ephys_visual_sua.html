<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ephys_visual_sua</title>
  <meta name="keywords" content="ephys_visual_sua">
  <meta name="description" content="ephys_visual_sua.m takes data generated by intan_cluster.m and stored in extracted_data.mat">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../menu.html">Home</a> &gt;  <a href="menu.html">ephys</a> &gt; ephys_visual_sua.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../menu.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for ephys&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>ephys_visual_sua
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>ephys_visual_sua.m takes data generated by intan_cluster.m and stored in extracted_data.mat</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function ephys_visual_sua(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">ephys_visual_sua.m takes data generated by intan_cluster.m and stored in extracted_data.mat
and produces song_aligned single-unit rasters

    [MUA TIME LABEL HISTOGRAM]=ephys_visual_sua(MIC_DATA,EPHYS_DATA,CHANNELS,varargin)

    MIC_DATA
    aligned microphrone traces from extracted_data.mat (should be the variable mic_data)

    HISTOGRAM
    contour histogram returned by ephys_visual_histogram.m (or loaded from histogram.mat)

    CHANNELS
    channel labels (i.e. the channel that corresponds to a given element in the cell array
    ephys_data) from extracted_data.mat

    the following may be specified as parameter/value pairs:

        tetrode_channels
        channels may act as a putative n-trode (can specify an arbitrary number of channels),
        defaults to manual cluster cutting

        car_exclude
        carelectrodes to exclude from noise estimate

        SR
        data sampling rate (default: 25e3)
        
        noise
        noise rejection method ('car' for common average 'nn' for nearest neighbor, or 'none',
        default: 'none')

        freq_range
        vector with two elements to specify the frequency range (one element specifies low pass, default: [500 8e3])

        savedir
        directory to store results (default: pwd)

        min_f
        lowermost frequency to display for contour histogram (default: 1e3)

        max_f
        uppermost frequency to display for contour histogram (default: 10e3)

        auto_clust
        perform automated cluster cutting via fitting a GMM through EM (default: 0)

        sigma_t
        multiple of variance estimate for automatic threshold setting (uses the Quiroga formulation, default: 4)

        singletrials
        number of singletrials to plot

        savedir
        directory to store results (default: pwd)

        subtrials
        vector of trials to include in the analysis (default: all trials)</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>	</li><li><a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>	</li><li><a href="../ephys/helpers/ephys/ephys_ifr.html" class="code" title="function IFRVEC=ephys_ifr(SPIKETIMES,TIMEVECTOR,SR)">ephys_ifr</a>	</li><li><a href="../ephys/helpers/ephys/ephys_spike_cluster_auto.html" class="code" title="function [LABELS TRIALS ISI WINDOWS]=ephys_spike_cluster_auto(SPIKEWINDOWS,SPIKETIMES,varargin)">ephys_spike_cluster_auto</a>	</li><li><a href="../ephys/helpers/ephys/ephys_spike_clustergui_tetrode.html" class="code" title="function [LABELS TRIALS ISI WINDOWS]=ephys_spike_clustergui_tetrode(SPIKEWINDOWS,SPIKETIMES,varargin)">ephys_spike_clustergui_tetrode</a>	</li><li><a href="../ephys/helpers/ephys/ephys_spike_detect.html" class="code" title="function [SPIKES_PP SPIKES_PB]=ephys_spike_detect(DATA,THRESH,varargin)">ephys_spike_detect</a>	ephys_spike_detect.m performs spike detection on a vector with a pre-determined</li><li><a href="../ephys/helpers/visualization/ephys_visual_spikestats.html" class="code" title="function fig_num=ephys_visual_spikestats(SPIKEWINDOWS,SPIKEISI,varargin)">ephys_visual_spikestats</a>	</li><li><a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>	</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../ephys/pipeline/ephys_pipeline_sua_standalone.html" class="code" title="function ephys_lfp_standalone(PROCDIR,CONFIG)">ephys_pipeline_sua_standalone</a>	</li></ul>
<!-- crossreference -->



<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function ephys_visual_sua(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)</a>
0002 <span class="comment">%ephys_visual_sua.m takes data generated by intan_cluster.m and stored in extracted_data.mat</span>
0003 <span class="comment">%and produces song_aligned single-unit rasters</span>
0004 <span class="comment">%</span>
0005 <span class="comment">%    [MUA TIME LABEL HISTOGRAM]=ephys_visual_sua(MIC_DATA,EPHYS_DATA,CHANNELS,varargin)</span>
0006 <span class="comment">%</span>
0007 <span class="comment">%    MIC_DATA</span>
0008 <span class="comment">%    aligned microphrone traces from extracted_data.mat (should be the variable mic_data)</span>
0009 <span class="comment">%</span>
0010 <span class="comment">%    HISTOGRAM</span>
0011 <span class="comment">%    contour histogram returned by ephys_visual_histogram.m (or loaded from histogram.mat)</span>
0012 <span class="comment">%</span>
0013 <span class="comment">%    CHANNELS</span>
0014 <span class="comment">%    channel labels (i.e. the channel that corresponds to a given element in the cell array</span>
0015 <span class="comment">%    ephys_data) from extracted_data.mat</span>
0016 <span class="comment">%</span>
0017 <span class="comment">%    the following may be specified as parameter/value pairs:</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%        tetrode_channels</span>
0020 <span class="comment">%        channels may act as a putative n-trode (can specify an arbitrary number of channels),</span>
0021 <span class="comment">%        defaults to manual cluster cutting</span>
0022 <span class="comment">%</span>
0023 <span class="comment">%        car_exclude</span>
0024 <span class="comment">%        carelectrodes to exclude from noise estimate</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%        SR</span>
0027 <span class="comment">%        data sampling rate (default: 25e3)</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%        noise</span>
0030 <span class="comment">%        noise rejection method ('car' for common average 'nn' for nearest neighbor, or 'none',</span>
0031 <span class="comment">%        default: 'none')</span>
0032 <span class="comment">%</span>
0033 <span class="comment">%        freq_range</span>
0034 <span class="comment">%        vector with two elements to specify the frequency range (one element specifies low pass, default: [500 8e3])</span>
0035 <span class="comment">%</span>
0036 <span class="comment">%        savedir</span>
0037 <span class="comment">%        directory to store results (default: pwd)</span>
0038 <span class="comment">%</span>
0039 <span class="comment">%        min_f</span>
0040 <span class="comment">%        lowermost frequency to display for contour histogram (default: 1e3)</span>
0041 <span class="comment">%</span>
0042 <span class="comment">%        max_f</span>
0043 <span class="comment">%        uppermost frequency to display for contour histogram (default: 10e3)</span>
0044 <span class="comment">%</span>
0045 <span class="comment">%        auto_clust</span>
0046 <span class="comment">%        perform automated cluster cutting via fitting a GMM through EM (default: 0)</span>
0047 <span class="comment">%</span>
0048 <span class="comment">%        sigma_t</span>
0049 <span class="comment">%        multiple of variance estimate for automatic threshold setting (uses the Quiroga formulation, default: 4)</span>
0050 <span class="comment">%</span>
0051 <span class="comment">%        singletrials</span>
0052 <span class="comment">%        number of singletrials to plot</span>
0053 <span class="comment">%</span>
0054 <span class="comment">%        savedir</span>
0055 <span class="comment">%        directory to store results (default: pwd)</span>
0056 <span class="comment">%</span>
0057 <span class="comment">%        subtrials</span>
0058 <span class="comment">%        vector of trials to include in the analysis (default: all trials)</span>
0059 <span class="comment">%</span>
0060 
0061 <span class="keyword">if</span> nargin&lt;3 | isempty(CHANNELS), CHANNELS=1:16; <span class="keyword">end</span>
0062 
0063 nparams=length(varargin);
0064 
0065 <span class="keyword">if</span> mod(nparams,2)&gt;0
0066     error(<span class="string">'Parameters must be specified as parameter/value pairs'</span>);
0067 <span class="keyword">end</span>
0068 
0069 <span class="comment">%%%</span>
0070 
0071 SR=25e3;
0072 noise=<span class="string">'none'</span>; <span class="comment">% common-average reference for noise removal</span>
0073 car_exclude=[];
0074 savedir=pwd;
0075 min_f=1e3;
0076 max_f=10e3;
0077 hist_colors=<span class="string">'jet'</span>;
0078 figtitle=<span class="string">''</span>;
0079 freq_range=[500 8000]; <span class="comment">% frequency range for filtering</span>
0080 sort=1; <span class="comment">% do we want to sort?</span>
0081 auto_clust=0;
0082 tetrode_channels=[];
0083 sigma_t=4;
0084 singletrials=10; <span class="comment">% number of random single trials to plot per cluster</span>
0085 subtrials=[];
0086 align=<span class="string">'com'</span>; <span class="comment">% how to align spike waveforms can be min for minimum peak or COM</span>
0087 
0088 <span class="comment">% parameter for smooth density estimate</span>
0089 
0090 smooth_rate=1e3;
0091 sigma=.0025;
0092 
0093 colors={<span class="string">'b'</span>,<span class="string">'r'</span>,<span class="string">'g'</span>,<span class="string">'c'</span>,<span class="string">'m'</span>,<span class="string">'y'</span>,<span class="string">'k'</span>,<span class="string">'r'</span>,<span class="string">'g'</span>,<span class="string">'b'</span>};
0094 
0095 <span class="keyword">for</span> i=1:2:nparams
0096     <span class="keyword">switch</span> lower(varargin{i})
0097         <span class="keyword">case</span> <span class="string">'sr'</span>
0098             SR=varargin{i+1};
0099         <span class="keyword">case</span> <span class="string">'noise'</span>
0100             noise=varargin{i+1};
0101         <span class="keyword">case</span> <span class="string">'sigma_t'</span>
0102             sigma_t=varargin{i+1};
0103         <span class="keyword">case</span> <span class="string">'filtering'</span>
0104             filtering=varargin{i+1};
0105         <span class="keyword">case</span> <span class="string">'savedir'</span>
0106             savedir=varargin{i+1};
0107         <span class="keyword">case</span> <span class="string">'min_f'</span>
0108             min_f=varargin{i+1};
0109         <span class="keyword">case</span> <span class="string">'max_f'</span>
0110             max_f=varargin{i+1};
0111         <span class="keyword">case</span> <span class="string">'hist_colors'</span>
0112             hist_colors=varargin{i+1};
0113         <span class="keyword">case</span> <span class="string">'car_exclude'</span>
0114             car_exclude=varargin{i+1};
0115         <span class="keyword">case</span> <span class="string">'figtitle'</span>
0116             figtitle=varargin{i+1};
0117         <span class="keyword">case</span> <span class="string">'freq_range'</span>
0118             freq_range=varargin{i+1};
0119         <span class="keyword">case</span> <span class="string">'sort'</span>
0120             sort=varargin{i+1};
0121         <span class="keyword">case</span> <span class="string">'channels'</span>
0122             channels=varargin{i+1};
0123         <span class="keyword">case</span> <span class="string">'tetrode_channels'</span>
0124             tetrode_channels=varargin{i+1};
0125         <span class="keyword">case</span> <span class="string">'auto_clust'</span>
0126             auto_clust=varargin{i+1};
0127         <span class="keyword">case</span> <span class="string">'sigma_t'</span>
0128             sigma_t=varargin{i+1};
0129         <span class="keyword">case</span> <span class="string">'subtrials'</span>
0130             subtrials=varargin{i+1};
0131         <span class="keyword">case</span> <span class="string">'align'</span>
0132             align=varargin{i+1};
0133     <span class="keyword">end</span>
0134 <span class="keyword">end</span>
0135 
0136 
0137 startidx=max([find(HISTOGRAM.f&lt;=min_f)]);
0138 stopidx=min([find(HISTOGRAM.f&gt;=max_f)]);
0139 
0140 <span class="keyword">if</span> max_f&gt;SR/2
0141     disp(<span class="string">'Maximum Fs must be less than Nyquist!'</span>);
0142     disp(<span class="string">'Resetting max fs'</span>);
0143     max_f==SR/2;
0144 <span class="keyword">end</span>
0145 
0146 [samples,ntrials,ncarelectrodes]=size(EPHYS_DATA);
0147 proc_data=zeros(samples,ntrials,length(channels));
0148 
0149 <span class="keyword">if</span> isempty(subtrials)
0150     subtrials=1:ntrials;
0151 <span class="keyword">end</span>
0152 
0153 TIME=[1:samples]./SR; <span class="comment">% time vector for plotting</span>
0154 
0155 proc_data=<a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>(EPHYS_DATA,CHANNELS,channels,<span class="string">'method'</span>,noise,<span class="string">'car_exclude'</span>,car_exclude);
0156 proc_data=<a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>(proc_data,<span class="string">'s'</span>,<span class="string">'freq_range'</span>,freq_range);
0157 
0158 <span class="keyword">if</span> ~isempty(tetrode_channels)
0159     tetrode_data=<a href="../ephys/helpers/ephys/ephys_denoise_signal.html" class="code" title="function [DATA,CAR]=ephys_denoise_signal(EPHYS_DATA,CHIN,CHOUT,varargin)">ephys_denoise_signal</a>(EPHYS_DATA,CHANNELS,tetrode_channels,<span class="string">'method'</span>,noise,<span class="string">'car_exclude'</span>,car_exclude);
0160     tetrode_data=<a href="../ephys/helpers/ephys/ephys_condition_signal.html" class="code" title="function EPHYS_DATA=ephys_condition_signal(EPHYS_DATA,DATA_TYPE,varargin)">ephys_condition_signal</a>(tetrode_data,<span class="string">'s'</span>,<span class="string">'freq_range'</span>,freq_range);
0161 <span class="keyword">else</span>
0162     tetrode_data=[];
0163 <span class="keyword">end</span>
0164 
0165 clear EPHYS_DATA;
0166 
0167 proc_data=proc_data(:,subtrials,:);
0168 
0169 <span class="keyword">if</span> ~isempty(tetrode_channels)
0170     tetrode_data=tetrode_data(:,subtrials,:);
0171 <span class="keyword">end</span>
0172 [samples,ntrials,newchannels]=size(proc_data);
0173 
0174 disp(<span class="string">'Entering spike detection...'</span>);
0175 
0176 <span class="comment">% need a noise cutoff...let's start with 3*std or Quiroga's measure</span>
0177 
0178 <span class="keyword">for</span> i=1:length(channels)
0179 
0180     disp([<span class="string">'Electrode '</span> num2str(channels(i))])
0181 
0182     <span class="keyword">if</span> ~isempty(tetrode_channels)
0183         disp([<span class="string">'Will use tetrode channels '</span> num2str(tetrode_channels) <span class="string">' for sorting'</span>]);
0184     <span class="keyword">end</span>
0185 
0186     <span class="comment">% collect spikes</span>
0187 
0188     tmp_spikewindows={};
0189     tmp_spiketimes={};
0190 
0191     sort_data=cat(3,proc_data(:,:,i),tetrode_data);
0192 
0193     parfor j=1:ntrials
0194         
0195 
0196         spike_pp=[];
0197         spikeless_data=[];
0198 
0199         threshold=sigma_t*median(abs(proc_data(:,j,i))/.6745);
0200         <span class="comment">%disp([num2str(threshold)]);</span>
0201         spike_pp=<a href="../ephys/helpers/ephys/ephys_spike_detect.html" class="code" title="function [SPIKES_PP SPIKES_PB]=ephys_spike_detect(DATA,THRESH,varargin)">ephys_spike_detect</a>(sort_data(:,j,:),threshold,<span class="string">'sr'</span>,SR,<span class="string">'visualize'</span>,<span class="string">'n'</span>,<span class="string">'align'</span>,align);
0202 
0203         <span class="comment">% after spike detect also collect trace without spikes</span>
0204 
0205         [winsamples,nspikes,tetrodes]=size(spike_pp.abs.windows);
0206 
0207         <span class="keyword">if</span> nspikes&lt;2
0208             spikeless_data=NaN;
0209             <span class="keyword">continue</span>;
0210         <span class="keyword">end</span>
0211 
0212         <span class="comment">% if tetrode then check each channel for significant spike</span>
0213 
0214         window=floor((winsamples-1)/2); <span class="comment">% how many samples to the left and right of the spike</span>
0215 
0216         <span class="comment">% should we delete?</span>
0217 
0218         adjust=0;
0219 
0220         <span class="comment">% compute the peak to peak of the mean waveform</span>
0221     
0222         spikeless_data=proc_data(:,j,i);
0223 
0224         <span class="comment">% eliminate each spike from the data</span>
0225 
0226         <span class="keyword">for</span> k=1:nspikes
0227 
0228             spike_point=spike_pp.abs.times(k)-adjust;
0229 
0230             <span class="keyword">if</span> spike_point-window&lt;1
0231                 spikeless_data=NaN;
0232                 <span class="keyword">break</span>;
0233             <span class="keyword">end</span>
0234 
0235             spikeless_data(spike_point-window:spike_point+window)=[];
0236             adjust=adjust+((window*2)+1);
0237         <span class="keyword">end</span>
0238 
0239         tmp_spiketimes{j}=spike_pp.abs.times;
0240         tmp_spikewindows{j}=spike_pp.abs.windows;
0241         tmp_threshold(j)=threshold;
0242         tmp_spikeless{j}=spikeless_data;
0243     
0244     <span class="keyword">end</span>
0245 
0246     clear sort_data;
0247 
0248     spikewindows{i}=tmp_spikewindows;
0249     spikeless{i}=tmp_spikeless;
0250     spiketimes{i}=tmp_spiketimes;
0251     threshold(i,:)=tmp_threshold;
0252     
0253     [winsamples,trials,tetrodes]=size(spikewindows{1}{1});
0254 
0255     <span class="keyword">if</span> tetrodes&gt;1
0256         tetrode_preview=figure(<span class="string">'Name'</span>,<span class="string">'Tetrode Preview'</span>,<span class="string">'Visible'</span>,<span class="string">'off'</span>);
0257         subplot(tetrodes,1,1);
0258         plot(spikewindows{1}{1}(:,:,1));
0259         title([<span class="string">'Channel '</span> num2str(CHANNELS(channels(i)))]);
0260         axis tight;
0261         <span class="keyword">for</span> k=1:tetrodes-1
0262             subplot(tetrodes,1,k+1);
0263             plot(spikewindows{1}{1}(:,:,k+1));
0264             title([<span class="string">'Channel '</span> num2str(tetrode_channels(k))]);
0265             axis tight
0266         <span class="keyword">end</span>
0267         set(tetrode_preview,<span class="string">'Visible'</span>,<span class="string">'on'</span>);
0268         pause();
0269         close([tetrode_preview]);
0270     <span class="keyword">end</span>
0271 <span class="keyword">end</span>
0272 
0273 <span class="comment">% simplest way to draw raster...plot([sample;sample]</span>
0274 <span class="comment">% vector of times [120 130 200;120 130 200], then next vector specifies bottom and top of tickmark</span>
0275 <span class="comment">% e.g. [1.5 1.5 1.5;.5 .5 .5] for trial 1, etc.</span>
0276 
0277 <span class="comment">% collapse spike windows into a single matrix, get cluster ids back and then</span>
0278 <span class="comment">% change color according to ID</span>
0279 
0280 disp(<span class="string">'Generating figures...'</span>);
0281 disp([<span class="string">'Will save to directory:  '</span> savedir]);
0282 
0283 <span class="comment">% scale pixels by time</span>
0284 <span class="comment">% now we have clusterid and the trial for all spikes, we need to color them appropriately</span>
0285 
0286 [path,name,ext]=fileparts(fullfile(savedir));
0287 savefilename=[ name <span class="string">'_sua_freqrange_'</span> num2str(freq_range) <span class="string">'_electrode_'</span> ];
0288 
0289 savedir=fullfile(savedir,<span class="string">'sua'</span>);
0290 
0291 <span class="keyword">if</span> ~exist(savedir,<span class="string">'dir'</span>)
0292     mkdir(fullfile(savedir));
0293 <span class="keyword">end</span>
0294 
0295 <span class="comment">% kernel density estimate of smooth firing rate</span>
0296 
0297 kernedges=[-3*sigma:1/smooth_rate:3*sigma];
0298 binedges=[0:(1/smooth_rate):samples/SR];
0299 
0300 smooth_spikes.time=binedges;
0301 
0302 <span class="keyword">if</span> exist(<span class="string">'normpdf'</span>)&gt;0
0303     kernel=normpdf(kernedges,0,sigma);
0304 <span class="keyword">else</span>
0305     kernel=(1/(sigma*sqrt(2*pi)))*exp((-(kernedges-0).^2)./(2*sigma^2));
0306 <span class="keyword">end</span>
0307 
0308 <span class="keyword">for</span> i=1:length(channels)
0309 
0310     <span class="comment">% [time;time] [trial+.5;trial-.5]</span>
0311 
0312     disp([<span class="string">'Channel '</span> num2str(channels(i))]);
0313 
0314     <span class="keyword">if</span> sort
0315         <span class="keyword">if</span> auto_clust
0316             [clusterid clustertrial clusterisi clusterwindows]=<a href="../ephys/helpers/ephys/ephys_spike_cluster_auto.html" class="code" title="function [LABELS TRIALS ISI WINDOWS]=ephys_spike_cluster_auto(SPIKEWINDOWS,SPIKETIMES,varargin)">ephys_spike_cluster_auto</a>(spikewindows{i},spiketimes{i},<span class="string">'sr'</span>,SR);
0317         <span class="keyword">else</span>
0318             [clusterid clustertrial clusterisi clusterwindows]=<a href="../ephys/helpers/ephys/ephys_spike_clustergui_tetrode.html" class="code" title="function [LABELS TRIALS ISI WINDOWS]=ephys_spike_clustergui_tetrode(SPIKEWINDOWS,SPIKETIMES,varargin)">ephys_spike_clustergui_tetrode</a>(spikewindows{i},spiketimes{i},<span class="string">'sr'</span>,SR);
0319         <span class="keyword">end</span>
0320 
0321         <span class="keyword">if</span> isempty(clusterid)
0322             disp(<span class="string">'No labels returned, bailing...'</span>);
0323             <span class="keyword">return</span>;
0324         <span class="keyword">end</span>
0325 
0326     <span class="keyword">else</span>
0327         clusterid=[];
0328     <span class="keyword">end</span>
0329 
0330     uniq_clusters=unique(clusterid);
0331 
0332     <span class="keyword">if</span> ~isempty(clusterid)
0333     
0334         <span class="comment">% cycle through each cluster id</span>
0335 
0336         <span class="keyword">for</span> j=1:length(uniq_clusters)
0337 
0338             IFR{i}{j}=zeros(ntrials,samples);
0339             spike_vec{j}=[];
0340             trial_vec{j}=[];
0341 
0342             <span class="keyword">for</span> k=1:ntrials
0343 
0344                 <span class="comment">% grab the spike labels for this electrode and trial</span>
0345 
0346                 currids=clusterid(find(clustertrial==k));
0347 
0348                 <span class="comment">% get the spike times (in seconds)</span>
0349 
0350                 currspikes=spiketimes{i}{k};
0351             
0352                 <span class="comment">% now grab the spikes for THIS CLUSTER only</span>
0353 
0354                 clusterspikes=currspikes(find(currids==uniq_clusters(j)));
0355                 
0356                 <span class="comment">% IFR will use the current sampling rate</span>
0357                 
0358                 IFR{i}{j}(k,:)=<a href="../ephys/helpers/ephys/ephys_ifr.html" class="code" title="function IFRVEC=ephys_ifr(SPIKETIMES,TIMEVECTOR,SR)">ephys_ifr</a>(round(clusterspikes),samples,SR);
0359 
0360                 clusterspikes=clusterspikes./SR;
0361                 
0362                 tmp=repmat(clusterspikes,2,1);
0363                 spike_vec{j}=[spike_vec{j} tmp];
0364 
0365                 tmp=[k+.3;k-.3];
0366                 tmp=repmat(tmp,1,length(clusterspikes));
0367                 trial_vec{j}=[trial_vec{j} tmp];
0368 
0369                 <span class="comment">% for storage resort the spike vector by cluster</span>
0370 
0371                 clust_spike_vec{i}{j}{k}=clusterspikes;
0372 
0373                 binned_spikes=histc(clusterspikes,binedges);
0374                 smooth_spikes.density{j}(k,:)=conv(binned_spikes,kernel,<span class="string">'same'</span>);
0375 
0376 
0377             <span class="keyword">end</span>
0378         <span class="keyword">end</span>
0379     <span class="keyword">else</span>
0380 
0381         clust_spike_vec=[];
0382         spike_vec{1}=[];
0383         trial_vec{1}=[];
0384 
0385         <span class="keyword">for</span> j=1:ntrials
0386 
0387             <span class="comment">% now for each trial, we need to label the spikes appropriately,</span>
0388             <span class="comment">% first sort by id</span>
0389 
0390             <span class="comment">% find command is already sorted, ascending</span>
0391 
0392             tmp=repmat(spiketimes{i}{j},2,1)./SR;
0393             spike_vec{1}=[spike_vec{1} tmp];
0394 
0395             tmp=[j+.3;j-.3];
0396             tmp=repmat(tmp,1,length(spiketimes{i}{j}));
0397             trial_vec{1}=[trial_vec{1} tmp];
0398 
0399             binned_spikes=histc(spiketimes{i}{j},binedges);
0400             smooth_spikes{1}(j,:)=conv(binned_spikes,kernel,<span class="string">'same'</span>);
0401 
0402         <span class="keyword">end</span>
0403 
0404     <span class="keyword">end</span>
0405 
0406     <span class="keyword">if</span> ~isempty(uniq_clusters)
0407         nplots=length(uniq_clusters);
0408     <span class="keyword">else</span>
0409         nplots=1;
0410     <span class="keyword">end</span>
0411 
0412     <span class="comment">% plot the spike stats</span>
0413 
0414     savefilename_stats=[ savefilename num2str(channels(i))<span class="keyword">...</span>
0415                    <span class="string">'_stats_cluster_'</span>];
0416 
0417     <span class="comment">% delete all old files</span>
0418 
0419     delete(fullfile(savedir,[ <span class="string">'*_sua_freqrange*electrode_'</span> num2str(channels(i)) <span class="string">'*'</span>]));
0420     
0421     <span class="keyword">if</span> ~isempty(clusterwindows)
0422 
0423         <span class="comment">% delete old stats figures if they exist</span>
0424 
0425         delete(fullfile(savedir,[savefilename_stats <span class="string">'*.png'</span>]));
0426         delete(fullfile(savedir,[savefilename_stats <span class="string">'*.eps'</span>]));
0427 
0428         <span class="keyword">for</span> j=1:length(uniq_clusters)
0429 
0430             <span class="comment">% estimate SNR from 6*std of spikeless trace</span>
0431 
0432             ntrials=length(spikeless{i});
0433 
0434             <span class="keyword">for</span> k=1:ntrials
0435                 noise_p2p(k)=6*std(spikeless{i}{k});
0436             <span class="keyword">end</span>
0437 
0438             noise_p2p(isnan(noise_p2p))=[];
0439             mean_noise_p2p=mean(noise_p2p);
0440             stats_fig=<a href="../ephys/helpers/visualization/ephys_visual_spikestats.html" class="code" title="function fig_num=ephys_visual_spikestats(SPIKEWINDOWS,SPIKEISI,varargin)">ephys_visual_spikestats</a>(clusterwindows{uniq_clusters(j)},clusterisi{uniq_clusters(j)},<span class="keyword">...</span>
0441                 <span class="string">'noise_p2p'</span>,mean_noise_p2p,<span class="string">'sr'</span>,25e3,<span class="string">'spike_sr'</span>,50e3);
0442 
0443             <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(stats_fig,savedir,<span class="keyword">...</span>
0444                 [ savefilename_stats num2str(uniq_clusters(j))],<span class="string">'eps,png'</span>);
0445             close([stats_fig]);
0446 
0447         <span class="keyword">end</span>
0448     <span class="keyword">end</span>
0449 
0450 
0451     savefilename_raster=[ savefilename num2str(channels(i))<span class="keyword">...</span>
0452                    <span class="string">'_raster_cluster_'</span>];
0453 
0454     ax=[];
0455 
0456     <span class="comment">% delete any old single trial plots</span>
0457 
0458     <span class="keyword">if</span> exist(fullfile(savedir,<span class="string">'singletrials'</span>,[<span class="string">'ch'</span> num2str(channels(i)) ]),<span class="string">'dir'</span>)
0459         rmdir(fullfile(savedir,<span class="string">'singletrials'</span>,[<span class="string">'ch'</span> num2str(channels(i)) ]),<span class="string">'s'</span>);
0460     <span class="keyword">end</span>
0461 
0462     <span class="keyword">for</span> j=1:length(uniq_clusters)
0463 
0464         raster_fig=figure(<span class="string">'visible'</span>,<span class="string">'off'</span>,<span class="string">'Units'</span>,<span class="string">'Pixels'</span>,<span class="string">'Position'</span>,[0 0 600 800]);
0465         ax(1)=subaxis(6,1,1,1,1,2,<span class="string">'margin'</span>,.1,<span class="string">'spacingvert'</span>,0);
0466         imagesc(HISTOGRAM.t,HISTOGRAM.f(startidx:stopidx),HISTOGRAM.imask(startidx:stopidx,:));
0467         colormap(hist_colors);
0468         freezeColors;
0469         set(gca,<span class="string">'ydir'</span>,<span class="string">'normal'</span>,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="string">'xtick'</span>,[],<span class="string">'ytick'</span>,[min_f max_f],<span class="string">'linewidth'</span>,1.5,<span class="string">'ticklength'</span>,[.025 .025],<span class="keyword">...</span>
0470             <span class="string">'FontSize'</span>,11,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0471         ylim([min_f max_f]);
0472         box off;
0473         title({[ figtitle ];[ <span class="string">'Channel '</span> num2str(channels(i))]},<span class="string">'FontSize'</span>,18,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0474 
0475         ax(2)=subaxis(6,1,1,3,1,1,<span class="string">'spacingvert'</span>,0,<span class="string">'margin'</span>,0.1,<span class="string">'paddingbottom'</span>,.025);
0476         plot(TIME,HISTOGRAM.mean_osc,<span class="string">'-k'</span>);
0477         ylabel(<span class="string">'Osc.'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0478         axis tight;
0479         set(gca,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="string">'xtick'</span>,[],<span class="string">'ytick'</span>,[]);
0480 
0481         ax(3)=subaxis(6,1,1,4,1,3,<span class="string">'spacingvert'</span>,0.025,<span class="string">'margin'</span>,0.1,<span class="string">'paddingbottom'</span>,0);
0482 
0483         plot(spike_vec{j},trial_vec{j},<span class="string">'-'</span>,<span class="string">'color'</span>,<span class="string">'k'</span>);    
0484         axis([0 TIME(end) 0 ntrials+1]);
0485         xlabel(<span class="string">'Time (in s)'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0486         ylabel(<span class="string">'Trial'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>);
0487         box off
0488         set(gca,<span class="string">'tickdir'</span>,<span class="string">'out'</span>,<span class="string">'linewidth'</span>,1.5,<span class="string">'ticklength'</span>,[.025 .025],<span class="string">'FontSize'</span>,11,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>,<span class="string">'ydir'</span>,<span class="string">'rev'</span>);
0489 
0490         linkaxes(ax,<span class="string">'x'</span>);
0491 
0492         <span class="keyword">if</span> ~isempty(figtitle)
0493             name=figtitle;
0494         <span class="keyword">end</span>
0495 
0496         set(raster_fig,<span class="string">'PaperPositionMode'</span>,<span class="string">'auto'</span>);
0497         <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(raster_fig,savedir,<span class="keyword">...</span>
0498             [ savefilename_raster num2str(uniq_clusters(j)) ],<span class="string">'eps,png'</span>);
0499         close([raster_fig]);
0500 
0501         <span class="comment">% generate single trial plots, simply the spikes marked along with the filtered traces</span>
0502 
0503         population=[1:ntrials];
0504         randtrials=population(randsample(ntrials,singletrials));
0505 
0506         singletrialdir=fullfile(savedir,<span class="string">'singletrials'</span>,[<span class="string">'ch'</span> num2str(channels(i)) ],[ <span class="string">'clust'</span> num2str(j)]);
0507 
0508         <span class="keyword">if</span> ~exist(fullfile(singletrialdir),<span class="string">'dir'</span>);
0509             mkdir(singletrialdir);
0510         <span class="keyword">end</span>
0511 
0512         disp(<span class="string">'Plotting single trials'</span>);
0513 
0514         <span class="keyword">for</span> k=1:singletrials
0515             
0516             singletrialfig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>);
0517             idx=randtrials(k);
0518             currspikes=clust_spike_vec{i}{j}{idx};
0519             plot(TIME,proc_data(:,idx,i),<span class="string">'k-'</span>);
0520             hold on
0521             plot(currspikes,proc_data(round(currspikes*SR),idx,i),<span class="string">'r*'</span>);
0522             set(gca,<span class="string">'TickDir'</span>,<span class="string">'out'</span>,<span class="string">'TickLength'</span>,[.02 .02],<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>,<span class="string">'FontSize'</span>,11);
0523             xlabel(<span class="string">'Time (s)'</span>,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>);
0524             ylabel(<span class="string">'Voltage ($\mu$V)'</span>,<span class="string">'FontName'</span>,<span class="string">'Helvetica'</span>,<span class="string">'FontSize'</span>,13,<span class="string">'interpreter'</span>,<span class="string">'latex'</span>);
0525             box off
0526             axis tight
0527             <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(singletrialfig,singletrialdir,[<span class="string">'trial'</span> num2str(idx)],<span class="string">'eps,png'</span>);
0528 
0529             close([singletrialfig]);
0530 
0531         <span class="keyword">end</span>
0532     <span class="keyword">end</span>
0533 
0534 
0535 <span class="keyword">end</span>
0536 
0537 save(fullfile(savedir,[<span class="string">'sua_channels '</span> num2str(channels) <span class="string">'.mat'</span>]),<span class="string">'clusterid'</span>,<span class="string">'clustertrial'</span>,<span class="string">'clusterisi'</span>,<span class="string">'clusterwindows'</span>,<span class="keyword">...</span>
0538     <span class="string">'threshold'</span>,<span class="string">'CHANNELS'</span>,<span class="string">'channels'</span>,<span class="string">'TIME'</span>,<span class="string">'proc_data'</span>,<span class="string">'freq_range'</span>,<span class="string">'clust_spike_vec'</span>,<span class="string">'smooth_spikes'</span>,<span class="string">'spikeless'</span>,<span class="string">'IFR'</span>,<span class="string">'subtrials'</span>);
0539</pre></div>
<hr><address>Generated on Thu 19-Jul-2012 21:29:37 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>