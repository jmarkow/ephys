<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN"
                "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
  <title>Description of ephys_cluster</title>
  <meta name="keywords" content="ephys_cluster">
  <meta name="description" content="extracts and aligns renditions of a template along with slaved ephys">
  <meta http-equiv="Content-Type" content="text/html; charset=iso-8859-1">
  <meta name="generator" content="m2html v1.5 &copy; 2003-2005 Guillaume Flandin">
  <meta name="robots" content="index, follow">
  <link type="text/css" rel="stylesheet" href="../m2html.css">
</head>
<body>
<a name="_top"></a>
<div><a href="../menu.html">Home</a> &gt;  <a href="menu.html">ephys</a> &gt; ephys_cluster.m</div>

<!--<table width="100%"><tr><td align="left"><a href="../menu.html"><img alt="<" border="0" src="../left.png">&nbsp;Master index</a></td>
<td align="right"><a href="menu.html">Index for ephys&nbsp;<img alt=">" border="0" src="../right.png"></a></td></tr></table>-->

<h1>ephys_cluster
</h1>

<h2><a name="_name"></a>PURPOSE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>extracts and aligns renditions of a template along with slaved ephys</strong></div>

<h2><a name="_synopsis"></a>SYNOPSIS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="box"><strong>function ephys_cluster(DIR,varargin) </strong></div>

<h2><a name="_description"></a>DESCRIPTION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre class="comment">extracts and aligns renditions of a template along with slaved ephys

example:

ephys_cluster(pwd)

First the script prompts the user to create a directory or continue a
previous run, then
the user selects a .mat file that contains the template vocalization and is prompted to 
draw a bounding box around the template.  All of the sound files in the same directory
are checked for spectral similarity to the template, and the user then manually cuts clusters
to choose the cluster of sounds similar to the template (the cluster with a mean highest score
in the feature dimensions is the likeliest candidate).  Finally, the cluster is saved to 
a directory specified by the user in extracted_data.mat.  The results can be visualized with
ephys_visual_mua.m (for multi-unit data).


    ephys_cluster(DIR,varargin)
    
    DIR
    directory that contains the extracted files (default: pwd)

    the following may be specified as parameter/value pairs:

        SR
        sampling rate for aligned data (25e3, default Intan)

        min_f
        lowermost frequency for template spectrogram

        max_f
        uppermost frequency for template spectrogram
        
        colors
        colormap for template spectrogram

see also nidaq_songdet.m,<a href="ephys_visual_mua.html" class="code" title="function [MUA TIME LABEL HISTOGRAM]=ephys_visual_mua(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)">ephys_visual_mua</a>.m,<a href="ephys_visual_sua.html" class="code" title="function ephys_visual_sua(EPHYS_DATA,HISTOGRAM,CHANNELS,varargin)">ephys_visual_sua</a>.m</pre></div>

<!-- crossreference -->
<h2><a name="_cross"></a>CROSS-REFERENCE INFORMATION <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
This function calls:
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="../ephys/helpers/spectral/ephys_pipeline_smscore.html" class="code" title="function [features]=ephys_pipeline_smscore(s,sr,varargin)">ephys_pipeline_smscore</a>	computes spectral features of a given signal</li><li><a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>	save in multiple formats in a single command</li><li><a href="../ephys/helpers/visualization/new_data_plotter.html" class="code" title="function output=new_data_plotter(DATAFILE,SAVEFILE)">new_data_plotter</a>	GUI for choosing a cluster for ephys_cluster.m</li><li><a href="../ephys/helpers/visualization/pretty_sonogram.html" class="code" title="function [IMAGE,F,T]=pretty_sonogram(SIGNAL,SR,varargin)">pretty_sonogram</a>	simple 2-taper histogram (Gauss and DGauss)</li><li><a href="../ephys/helpers/visualization/spectro_navigate.html" class="code" title="function [EXTRACTED_SOUND,EXTRACTED_IMAGE,TIME_POINTS]=spectro_navigate(DATA)">spectro_navigate</a>	simple GUI for selecting a sound using its spectrogram</li></ul>
This function is called by:
<ul style="list-style-image:url(../matlabicon.gif)">
</ul>
<!-- crossreference -->

<h2><a name="_subfunctions"></a>SUBFUNCTIONS <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<ul style="list-style-image:url(../matlabicon.gif)">
<li><a href="#_sub1" class="code">function TEMPLATE=select_template(DIR)</a></li><li><a href="#_sub2" class="code">function sound_file_features(DIR,SOUND_FILES,N,OVERLAP,FILTER_SCALE,DOWNSAMPLING)</a></li><li><a href="#_sub3" class="code">function template_match(TEMPLATE,TARGET_FILES,SAVEFILE,TEMPLATESIZE)</a></li><li><a href="#_sub4" class="code">function [MIC_DATA EPHYS_DATA CHANNELS USED_FILENAMES]=extract_hits(SELECTED_PEAKS,FILENAMES,TEMPLATESIZE,SPECT_THRESH,TIME_RANGE,SR,N,OVERLAP,DOWNSAMPLING)</a></li></ul>

<h2><a name="_source"></a>SOURCE CODE <a href="#_top"><img alt="^" border="0" src="../up.png"></a></h2>
<div class="fragment"><pre>0001 <a name="_sub0" href="#_subfunctions" class="code">function ephys_cluster(DIR,varargin)</a>
0002 <span class="comment">%extracts and aligns renditions of a template along with slaved ephys</span>
0003 <span class="comment">%</span>
0004 <span class="comment">%example:</span>
0005 <span class="comment">%</span>
0006 <span class="comment">%ephys_cluster(pwd)</span>
0007 <span class="comment">%</span>
0008 <span class="comment">%First the script prompts the user to create a directory or continue a</span>
0009 <span class="comment">%previous run, then</span>
0010 <span class="comment">%the user selects a .mat file that contains the template vocalization and is prompted to</span>
0011 <span class="comment">%draw a bounding box around the template.  All of the sound files in the same directory</span>
0012 <span class="comment">%are checked for spectral similarity to the template, and the user then manually cuts clusters</span>
0013 <span class="comment">%to choose the cluster of sounds similar to the template (the cluster with a mean highest score</span>
0014 <span class="comment">%in the feature dimensions is the likeliest candidate).  Finally, the cluster is saved to</span>
0015 <span class="comment">%a directory specified by the user in extracted_data.mat.  The results can be visualized with</span>
0016 <span class="comment">%ephys_visual_mua.m (for multi-unit data).</span>
0017 <span class="comment">%</span>
0018 <span class="comment">%</span>
0019 <span class="comment">%    ephys_cluster(DIR,varargin)</span>
0020 <span class="comment">%</span>
0021 <span class="comment">%    DIR</span>
0022 <span class="comment">%    directory that contains the extracted files (default: pwd)</span>
0023 <span class="comment">%</span>
0024 <span class="comment">%    the following may be specified as parameter/value pairs:</span>
0025 <span class="comment">%</span>
0026 <span class="comment">%        SR</span>
0027 <span class="comment">%        sampling rate for aligned data (25e3, default Intan)</span>
0028 <span class="comment">%</span>
0029 <span class="comment">%        min_f</span>
0030 <span class="comment">%        lowermost frequency for template spectrogram</span>
0031 <span class="comment">%</span>
0032 <span class="comment">%        max_f</span>
0033 <span class="comment">%        uppermost frequency for template spectrogram</span>
0034 <span class="comment">%</span>
0035 <span class="comment">%        colors</span>
0036 <span class="comment">%        colormap for template spectrogram</span>
0037 <span class="comment">%</span>
0038 <span class="comment">%see also nidaq_songdet.m,ephys_visual_mua.m,ephys_visual_sua.m</span>
0039 
0040 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0041 
0042 spect_thresh=.1; <span class="comment">% deprecated, this parameter is no longer used</span>
0043 SR=25e3; <span class="comment">% sampling</span>
0044 colors=<span class="string">'hot'</span>;
0045 min_f=1e3;
0046 max_f=16e3;
0047 time_range=[0 inf];
0048 subset=<span class="string">''</span>;
0049 
0050 <span class="comment">% smscore parameters, THESE MUST MATCH THE PIPELINE PARAMETERS IN EPHYS_PIPELINE.CFG, OTHERWISE</span>
0051 <span class="comment">% THE FEATURE COMPUTATION BETWEEN THE TEMPLATE AND CANDIDATE SOUNDS WILL NOT</span>
0052 <span class="comment">% BE APPROPRIATELY MATCHED</span>
0053 
0054 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% SMSCORE PIPELINE PARAMETERS %%%%%%%%</span>
0055 
0056 n=1024;
0057 overlap=1000;
0058 filter_scale=10;
0059 downsampling=5;
0060 
0061 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0062 
0063 
0064 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% PARAMETER COLLECTION  %%%%%%%%%%%%%%</span>
0065 
0066 nparams=length(varargin);
0067 
0068 <span class="keyword">if</span> mod(nparams,2)&gt;0
0069     error(<span class="string">'Parameters must be specified as parameter/value pairs'</span>);
0070 <span class="keyword">end</span>
0071 
0072 <span class="keyword">for</span> i=1:2:nparams
0073     <span class="keyword">switch</span> lower(varargin{i})
0074         <span class="keyword">case</span> <span class="string">'spect_thresh'</span>
0075             spect_thresh=varargin{i+1};
0076         <span class="keyword">case</span> <span class="string">'sr'</span>
0077             SR=varargin{i+1};
0078         <span class="keyword">case</span> <span class="string">'colors'</span>
0079             colors=varargin{i+1};
0080         <span class="keyword">case</span> <span class="string">'masks'</span>
0081             masks=varargin{i+1};
0082         <span class="keyword">case</span> <span class="string">'time_range'</span>
0083             time_range=varargin{i+1};
0084         <span class="keyword">case</span> <span class="string">'subset'</span>
0085             subset=varargin{i+1};
0086     <span class="keyword">end</span>
0087 <span class="keyword">end</span>
0088 
0089 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0090 
0091 <span class="comment">% TODO features to read from config file, need to make this play nice with changes to smscore...</span>
0092 
0093 
0094 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DIRECTORY CHECK %%%%%%%%%%%%%%%%%%%%</span>
0095 
0096 
0097 <span class="keyword">if</span> nargin&lt;1 | isempty(DIR)
0098     DIR=uigetdir(pwd,<span class="string">'Select the directory with .mat files to process...'</span>);
0099 <span class="keyword">end</span>
0100 
0101 prev_run_listing={};
0102 
0103 listing=dir(fullfile(DIR));
0104 
0105 <span class="comment">% all embedded directories could be previous runs</span>
0106 
0107 <span class="keyword">for</span> i=1:length(listing)
0108     <span class="keyword">if</span> listing(i).isdir
0109         prev_run_listing{end+1}=listing(i).name;
0110     <span class="keyword">end</span>
0111 <span class="keyword">end</span>
0112 
0113 proc_dir=[];
0114 
0115 <span class="comment">% check for previous runs</span>
0116 
0117 <span class="keyword">if</span> ~isempty(prev_run_listing)
0118     response=[];
0119     <span class="keyword">while</span> isempty(response)
0120         response=input(<span class="string">'Would you like to go to a (p)revious run or (c)reate a new one?  '</span>,<span class="string">'s'</span>);
0121         
0122         <span class="keyword">switch</span> lower(response(1))
0123 
0124             <span class="keyword">case</span> <span class="string">'p'</span>
0125                 dir_num=menu(<span class="string">'Which directory would you like to use?'</span>,prev_run_listing);
0126 
0127                 <span class="keyword">if</span> isempty(dir_num), <span class="keyword">continue</span>; <span class="keyword">end</span>
0128 
0129                 dir_name=prev_run_listing{dir_num};
0130                 proc_dir=fullfile(DIR,dir_name);
0131 
0132             <span class="keyword">case</span> <span class="string">'c'</span>
0133 
0134             <span class="keyword">otherwise</span>
0135                 response=[];
0136         <span class="keyword">end</span>
0137 
0138     <span class="keyword">end</span>
0139 <span class="keyword">end</span>
0140 
0141 <span class="comment">% prompt the user for a directory name if necessary</span>
0142 
0143 <span class="keyword">if</span> isempty(proc_dir)
0144 
0145     dir_name=[];
0146 
0147     <span class="keyword">while</span> isempty(dir_name)
0148 
0149         dir_name=input(<span class="string">'What would you like to name the new directory?  '</span>,<span class="string">'s'</span>);
0150 
0151         <span class="keyword">if</span> exist(fullfile(DIR,dir_name),<span class="string">'dir'</span>)
0152             disp(<span class="string">'Directory exists!'</span>);
0153             dir_name=[];
0154         <span class="keyword">end</span>
0155 
0156     <span class="keyword">end</span>
0157 
0158     proc_dir=fullfile(DIR,[ dir_name <span class="string">'_MANUALCLUST'</span>]);
0159     mkdir(proc_dir);
0160 
0161 <span class="keyword">end</span>
0162 
0163 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0164 
0165 
0166 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% TEMPLATE CHECK %%%%%%%%%%%%%%%%%%%%%</span>
0167 
0168 
0169 
0170 <span class="comment">% check for previously extracted templates</span>
0171 
0172 <span class="keyword">if</span> ~exist(fullfile(proc_dir,<span class="string">'template_data.mat'</span>),<span class="string">'file'</span>)
0173 
0174     TEMPLATE=<a href="#_sub1" class="code" title="subfunction TEMPLATE=select_template(DIR)">select_template</a>(fullfile(DIR));
0175 
0176     <span class="comment">% compute the features of the template</span>
0177 
0178     disp(<span class="string">'Computing the spectral features of the template'</span>);
0179     template_features=<a href="../ephys/helpers/spectral/ephys_pipeline_smscore.html" class="code" title="function [features]=ephys_pipeline_smscore(s,sr,varargin)">ephys_pipeline_smscore</a>(TEMPLATE,SR,<span class="keyword">...</span>
0180         <span class="string">'n'</span>,n,<span class="string">'overlap'</span>,overlap,<span class="string">'filter_scale'</span>,filter_scale,<span class="string">'downsampling'</span>,downsampling);
0181     save(fullfile(proc_dir,<span class="string">'template_data.mat'</span>),<span class="string">'TEMPLATE'</span>,<span class="string">'template_features'</span>);
0182 
0183 <span class="keyword">else</span>
0184     disp(<span class="string">'Loading stored template...'</span>);
0185     load(fullfile(proc_dir,<span class="string">'template_data.mat'</span>),<span class="string">'TEMPLATE'</span>);
0186     
0187     disp(<span class="string">'Computing the spectral features of the template'</span>);
0188     template_features=<a href="../ephys/helpers/spectral/ephys_pipeline_smscore.html" class="code" title="function [features]=ephys_pipeline_smscore(s,sr,varargin)">ephys_pipeline_smscore</a>(TEMPLATE,SR,<span class="keyword">...</span>
0189         <span class="string">'n'</span>,n,<span class="string">'overlap'</span>,overlap,<span class="string">'filter_scale'</span>,filter_scale,<span class="string">'downsampling'</span>,downsampling);
0190     save(fullfile(proc_dir,<span class="string">'template_data.mat'</span>),<span class="string">'TEMPLATE'</span>,<span class="string">'template_features'</span>);
0191 
0192 <span class="keyword">end</span>
0193 
0194 <span class="comment">% generate a nice sonogram of the selected template</span>
0195 
0196 template_fig=figure(<span class="string">'Visible'</span>,<span class="string">'off'</span>);
0197 [template_image,f,t]=<a href="../ephys/helpers/visualization/pretty_sonogram.html" class="code" title="function [IMAGE,F,T]=pretty_sonogram(SIGNAL,SR,varargin)">pretty_sonogram</a>(TEMPLATE,SR,<span class="string">'N'</span>,1024,<span class="string">'overlap'</span>,1000);
0198 
0199 startidx=max([find(f&lt;=min_f);1]);
0200 stopidx=min([find(f&gt;=max_f);length(f)]);
0201 
0202 imagesc(t,f(startidx:stopidx),template_image(startidx:stopidx,:));
0203 set(gca,<span class="string">'ydir'</span>,<span class="string">'normal'</span>);
0204 
0205 xlabel(<span class="string">'Time (in s)'</span>);
0206 ylabel(<span class="string">'Fs'</span>);
0207 colormap(colors);
0208 <a href="../ephys/helpers/visualization/multi_fig_save.html" class="code" title="function multi_fig_save(fighandle,save_dir,filename,formats,varargin)">multi_fig_save</a>(template_fig,proc_dir,<span class="string">'template'</span>,<span class="string">'png'</span>);
0209 
0210 close([template_fig]);
0211 
0212 <span class="comment">% get the template size so we can extract hits of the same size</span>
0213 
0214 [junk,templength]=size(template_features{1});
0215 templength=templength-1;
0216 
0217 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0218 
0219 
0220 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% GET DIFFERENCE SCORES %%%%%%%%%%%%%%</span>
0221 
0222 
0223 
0224 <span class="comment">% have we computed the difference between the template and the sound data?</span>
0225 
0226 skip=0;
0227 response=[];
0228 <span class="keyword">if</span> exist(fullfile(proc_dir,<span class="string">'cluster_data.mat'</span>),<span class="string">'file'</span>)
0229     disp(<span class="string">'Looks like you have computed the scores before...'</span>);
0230 
0231     <span class="keyword">while</span> isempty(response)
0232         response=input(<span class="string">'Would you like to (r)ecompute or (s)kip to clustering?  '</span>,<span class="string">'s'</span>);    
0233         <span class="keyword">switch</span> (lower(response))
0234             <span class="keyword">case</span> <span class="string">'r'</span>
0235                 skip=0;
0236             <span class="keyword">case</span> <span class="string">'s'</span>
0237                 skip=1;
0238             <span class="keyword">otherwise</span>
0239                 response=[];
0240         <span class="keyword">end</span>
0241     <span class="keyword">end</span>
0242 <span class="keyword">end</span>
0243 
0244 <span class="comment">% if we haven't computed the scores, do it!</span>
0245 
0246 <span class="keyword">if</span> ~skip
0247 
0248     <span class="comment">% collect all of the relevant .mat files</span>
0249 
0250     pre_files_to_proc=dir(fullfile(DIR,<span class="string">'*.mat'</span>));
0251 
0252     <span class="keyword">for</span> i=1:length(pre_files_to_proc)
0253 
0254         <span class="keyword">if</span> ~isempty(findstr(<span class="string">'match_scores.mat'</span>,pre_files_to_proc(i).name))
0255             <span class="keyword">continue</span>;
0256         <span class="keyword">end</span>
0257 
0258         files_to_proc{i}=fullfile(DIR,pre_files_to_proc(i).name);
0259     <span class="keyword">end</span>
0260 
0261     disp(<span class="string">'Computing features for all sounds...'</span>);
0262 
0263     <a href="#_sub2" class="code" title="subfunction sound_file_features(DIR,SOUND_FILES,N,OVERLAP,FILTER_SCALE,DOWNSAMPLING)">sound_file_features</a>(DIR,files_to_proc,n,overlap,filter_scale,downsampling);
0264 
0265     disp(<span class="string">'Comparing sound files to the template...'</span>);
0266 
0267     <span class="comment">% take a subset if the user has passed the option</span>
0268     <span class="comment">%</span>
0269     
0270     <span class="keyword">if</span> length(subset)==1
0271         disp([<span class="string">'Will use '</span> num2str(subset*100) <span class="string">'% of the available files'</span>]);
0272         <span class="comment">%selection=randsample(1:length(files_to_proc),floor(length(files_to_proc)*subset));</span>
0273         <span class="comment">%selection=sort(selection);</span>
0274         selection=round(linspace(1,length(files_to_proc),<span class="keyword">...</span>
0275             floor(length(files_to_proc)*subset)));
0276         files_to_proc=files_to_proc(selection);
0277     <span class="keyword">elseif</span> length(subset&gt;1)
0278         disp(<span class="string">'Will use the user provided subset'</span>);
0279 
0280         subset(subset&gt;length(files_to_proc))=[];
0281         files_to_proc=files_to_proc(subset);
0282     <span class="keyword">end</span>
0283 
0284     <a href="#_sub3" class="code" title="subfunction template_match(TEMPLATE,TARGET_FILES,SAVEFILE,TEMPLATESIZE)">template_match</a>(template_features,files_to_proc,fullfile(proc_dir,<span class="string">'cluster_data.mat'</span>),templength);
0285 
0286 <span class="keyword">end</span>
0287 
0288 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0289 
0290 
0291 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% CLUSTERING GUI %%%%%%%%%%%%%%%%%%%%%</span>
0292 
0293 <span class="comment">% TODO update cluster gui so that it has parity with the spike sorting GUI (more advanced)</span>
0294 
0295 
0296 property_names={<span class="string">'cos'</span>,<span class="string">'derivx'</span>, <span class="string">'derivy'</span>, <span class="string">'amp'</span>,<span class="string">'product'</span>,<span class="string">'curvature'</span>};
0297 save(fullfile(proc_dir,<span class="string">'cluster_data.mat'</span>),<span class="string">'property_names'</span>,<span class="string">'proc_dir'</span>,<span class="string">'-append'</span>);
0298 
0299 <span class="comment">% do we need to cluster again?</span>
0300 
0301 skip=0;
0302 response=[];
0303 <span class="keyword">if</span> exist(fullfile(proc_dir,<span class="string">'cluster_results.mat'</span>),<span class="string">'file'</span>)
0304     disp(<span class="string">'Looks like you have clustered the data before..'</span>);
0305 
0306     <span class="keyword">while</span> isempty(response)
0307         response=input(<span class="string">'Would you like to (r)ecluster or (s)kip?  '</span>,<span class="string">'s'</span>);    
0308         <span class="keyword">switch</span> (lower(response))
0309             <span class="keyword">case</span> <span class="string">'r'</span>
0310                 skip=0;
0311             <span class="keyword">case</span> <span class="string">'s'</span>
0312                 skip=1;
0313             <span class="keyword">otherwise</span>
0314                 response=[];
0315         <span class="keyword">end</span>
0316     <span class="keyword">end</span>
0317 <span class="keyword">end</span>
0318 
0319 
0320 <span class="keyword">if</span> ~skip
0321     uiwait(<a href="../ephys/helpers/visualization/new_data_plotter.html" class="code" title="function output=new_data_plotter(DATAFILE,SAVEFILE)">new_data_plotter</a>(fullfile(proc_dir,<span class="string">'cluster_data.mat'</span>),fullfile(proc_dir,<span class="string">'cluster_results.mat'</span>)));
0322 <span class="keyword">end</span>
0323 
0324 load(fullfile(proc_dir,<span class="string">'cluster_results.mat'</span>),<span class="string">'sorted_syllable'</span>);
0325 load(fullfile(proc_dir,<span class="string">'cluster_data.mat'</span>),<span class="string">'filenames'</span>);
0326 
0327 act_templatesize=length(TEMPLATE);
0328 
0329 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0330 
0331 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% HIT EXTRACTION %%%%%%%%%%%%%%%%%%%%%</span>
0332 
0333 
0334 skip=0;
0335 response=[];
0336 <span class="keyword">if</span> exist(fullfile(proc_dir,<span class="string">'extracted_data.mat'</span>),<span class="string">'file'</span>)
0337     disp(<span class="string">'Looks like you have extracted the data before..'</span>);
0338 
0339     <span class="keyword">while</span> isempty(response)
0340         response=input(<span class="string">'Would you like to (r)eextract or (s)kip?  '</span>,<span class="string">'s'</span>);    
0341         <span class="keyword">switch</span> (lower(response))
0342             <span class="keyword">case</span> <span class="string">'r'</span>
0343                 skip=0;
0344             <span class="keyword">case</span> <span class="string">'s'</span>
0345                 skip=1;
0346             <span class="keyword">otherwise</span>
0347                 response=[];
0348         <span class="keyword">end</span>
0349     <span class="keyword">end</span>
0350 <span class="keyword">end</span>
0351 
0352 
0353 <span class="keyword">if</span> ~skip
0354     [mic_data ephys_data channels used_filenames]=<a href="#_sub4" class="code" title="subfunction [MIC_DATA EPHYS_DATA CHANNELS USED_FILENAMES]=extract_hits(SELECTED_PEAKS,FILENAMES,TEMPLATESIZE,SPECT_THRESH,TIME_RANGE,SR,N,OVERLAP,DOWNSAMPLING)">extract_hits</a>(sorted_syllable,filenames,<span class="keyword">...</span>
0355         act_templatesize,spect_thresh,time_range,SR,n,overlap,downsampling);
0356     save(fullfile(proc_dir,<span class="string">'extracted_data.mat'</span>),<span class="string">'used_filenames'</span>,<span class="string">'mic_data'</span>,<span class="string">'ephys_data'</span>,<span class="string">'time_range'</span>,<span class="string">'channels'</span>,<span class="string">'-v7.3'</span>);
0357 <span class="keyword">end</span>
0358 
0359 
0360 <span class="keyword">end</span>
0361 
0362 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0363 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0364 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0365 
0366 
0367 
0368 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% TEMPLATE SELECT %%%%%%%%%%%%%%%%%%%%</span>
0369 
0370 <a name="_sub1" href="#_subfunctions" class="code">function TEMPLATE=select_template(DIR)</a>
0371 
0372 pause(.001); <span class="comment">% inserting 1 msec pause since uigetfile does not always open without it, not sure why...</span>
0373 
0374 response=[];
0375 
0376 <span class="keyword">while</span> isempty(response)
0377     [filename,pathname]=uigetfile(<span class="string">'*.mat'</span>,<span class="string">'Pick a sound file to extract the template from'</span>,fullfile(DIR));
0378     load(fullfile(pathname,filename),<span class="string">'mic_data'</span>);
0379     TEMPLATE=<a href="../ephys/helpers/visualization/spectro_navigate.html" class="code" title="function [EXTRACTED_SOUND,EXTRACTED_IMAGE,TIME_POINTS]=spectro_navigate(DATA)">spectro_navigate</a>(mic_data);
0380 
0381     response2=[];
0382     <span class="keyword">while</span> isempty(response2)
0383         
0384         response2=input(<span class="string">'(C)ontinue with selected template or (s)elect another sound file?  '</span>,<span class="string">'s'</span>);
0385 
0386         <span class="keyword">switch</span> lower(response2(1))
0387             <span class="keyword">case</span> <span class="string">'c'</span>
0388                 response=1;
0389             <span class="keyword">case</span> <span class="string">'s'</span>
0390                 response=[];
0391             <span class="keyword">otherwise</span>
0392                 response2=[];
0393         <span class="keyword">end</span>
0394 
0395     <span class="keyword">end</span>
0396 <span class="keyword">end</span>
0397 
0398 <span class="keyword">end</span>
0399 
0400 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0401 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0402 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0403 
0404 <span class="comment">%%%%</span>
0405 
0406 <span class="comment">% function to compute the spectral features for all the pertinent wave files</span>
0407 
0408 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% COMPUTE FEATURES %%%%%%%%%%%%%%%%%%%</span>
0409 
0410 
0411 <a name="_sub2" href="#_subfunctions" class="code">function sound_file_features(DIR,SOUND_FILES,N,OVERLAP,FILTER_SCALE,DOWNSAMPLING)</a>
0412 
0413 par_save = @(FILE,features) save([FILE],<span class="string">'features'</span>);
0414 
0415 <span class="keyword">if</span> ~exist(fullfile(DIR,<span class="string">'syllable_data'</span>),<span class="string">'dir'</span>)
0416     mkdir(fullfile(DIR,<span class="string">'syllable_data'</span>));
0417 <span class="keyword">end</span>
0418 
0419 parfor i=1:length(SOUND_FILES)
0420 
0421     input_file=SOUND_FILES{i};
0422     disp([input_file])
0423 
0424     [path,name,ext]=fileparts(input_file);
0425     output_file=fullfile(DIR,<span class="string">'syllable_data'</span>,[ name <span class="string">'_score.mat'</span>]);
0426 
0427     <span class="keyword">if</span> exist(output_file,<span class="string">'file'</span>), <span class="keyword">continue</span>; <span class="keyword">end</span>
0428 
0429     disp([<span class="string">'Computing features for '</span> input_file]);
0430 
0431     <span class="comment">% simply read in the file and score it</span>
0432 
0433     <span class="comment">% getfield hack to get around parfor errors</span>
0434 
0435     data=load(input_file,<span class="string">'mic_data'</span>,<span class="string">'fs'</span>);
0436     <span class="keyword">if</span> ~isfield(data,<span class="string">'mic_data'</span>)
0437         disp([<span class="string">'Problem encountered with '</span> input_file]);
0438         disp(<span class="string">'Skipping...'</span>);
0439         <span class="keyword">continue</span>;
0440     <span class="keyword">end</span>
0441     
0442     sound_data=data.mic_data;
0443     fs=data.fs;
0444 
0445     <span class="keyword">if</span> length(sound_data)&lt;N
0446         disp(<span class="string">'Sound extraction too short, skipping...'</span>);
0447         disp([input_file]);
0448         <span class="keyword">continue</span>;
0449     <span class="keyword">end</span>
0450 
0451     sound_features=<a href="../ephys/helpers/spectral/ephys_pipeline_smscore.html" class="code" title="function [features]=ephys_pipeline_smscore(s,sr,varargin)">ephys_pipeline_smscore</a>(sound_data,fs,<span class="keyword">...</span>
0452         <span class="string">'n'</span>,N,<span class="string">'overlap'</span>,OVERLAP,<span class="string">'filter_scale'</span>,FILTER_SCALE,<span class="string">'downsampling'</span>,DOWNSAMPLING);
0453 
0454     <span class="comment">% save for posterity's sake</span>
0455 
0456     par_save(output_file,sound_features);
0457 
0458 <span class="keyword">end</span>
0459 
0460 <span class="keyword">end</span>
0461 
0462 
0463 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0464 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0465 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0466 
0467 
0468 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% COMPARE FEATURES WITH TEMPLATE %%%%%</span>
0469 
0470 
0471 <a name="_sub3" href="#_subfunctions" class="code">function template_match(TEMPLATE,TARGET_FILES,SAVEFILE,TEMPLATESIZE)</a>
0472 
0473 <span class="comment">% do the template matching here...</span>
0474 
0475 <span class="comment">%disp('Comparing the target sounds to the template...');</span>
0476 
0477 parfor i=1:length(TARGET_FILES)
0478 
0479     <span class="comment">% load the features of the sound data</span>
0480 
0481     target=[];
0482 
0483     [path,name,ext]=fileparts(TARGET_FILES{i});
0484 
0485     input_file=fullfile(path,<span class="string">'syllable_data'</span>,[ name <span class="string">'_score.mat'</span>]);    
0486     
0487     <span class="keyword">try</span>
0488         target=getfield(load(input_file,<span class="string">'features'</span>),<span class="string">'features'</span>);
0489     <span class="keyword">catch</span>
0490         disp([<span class="string">'Troubling reading '</span> input_file]);
0491         <span class="keyword">continue</span>;
0492     <span class="keyword">end</span>
0493 
0494     [junk,targetlength]=size(target{1});
0495 
0496     score_temp={};
0497     temp_mat=[];
0498 
0499     <span class="keyword">for</span> j=1:length(target)
0500         score_temp{j}=[];
0501 
0502         <span class="keyword">for</span> k=1:targetlength-TEMPLATESIZE
0503             score_temp{j}=[score_temp{j} sum(sum(abs(target{j}(:,k:k+TEMPLATESIZE)-TEMPLATE{j})))];
0504         <span class="keyword">end</span>
0505 
0506         score_temp{j}=score_temp{j}-mean(score_temp{j});
0507         score_temp{j}=score_temp{j}/std(score_temp{j});
0508         score_temp{j}(score_temp{j}&gt;0)=0;
0509         score_temp{j}=abs(score_temp{j});
0510 
0511     <span class="keyword">end</span>
0512 
0513     attributes=length(score_temp);
0514     product_score=score_temp{1};
0515     
0516     <span class="keyword">for</span> j=2:attributes, product_score=product_score.*score_temp{j}; <span class="keyword">end</span>
0517 
0518     <span class="keyword">if</span> length(product_score)&lt;3
0519         variableCellArray{i}=temp_mat;
0520         peakLocation{i}=[];
0521         <span class="keyword">continue</span>;
0522     <span class="keyword">end</span>
0523 
0524     [pks,locs]=findpeaks(product_score,<span class="string">'MINPEAKHEIGHT'</span>,.005);
0525 
0526     <span class="keyword">if</span> isempty(locs)
0527         variableCellArray{i}=temp_mat;
0528         peakLocation{i}=[];
0529         <span class="keyword">continue</span>; 
0530     <span class="keyword">end</span>
0531 
0532     curvature=gradient(gradient(product_score));
0533 
0534     <span class="keyword">for</span> j=1:attributes, temp_mat(:,j)=log(score_temp{j}(locs)); <span class="keyword">end</span>
0535 
0536     temp_mat(:,attributes+1)=log(product_score(locs));
0537     temp_mat(:,attributes+2)=log(abs(curvature(locs)));
0538 
0539     peakLocation{i}=locs;
0540     variableCellArray{i}=temp_mat;
0541 
0542 <span class="keyword">end</span>
0543 
0544 filenames=TARGET_FILES;
0545 
0546 empty_coords=find(cellfun(@isempty,variableCellArray));
0547 variableCellArray(empty_coords)=[];
0548 peakLocation(empty_coords)=[];
0549 filenames(empty_coords)=[];
0550 
0551 disp([length(variableCellArray)]);
0552 
0553 save(SAVEFILE,<span class="string">'variableCellArray'</span>,<span class="string">'peakLocation'</span>,<span class="string">'filenames'</span>);
0554 
0555 <span class="keyword">end</span>
0556 
0557 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0558 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0559 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%</span>
0560 
0561 
0562 
0563 <span class="comment">%%%% the grand finale, extract the data!</span>
0564 
0565 <span class="comment">% need to adapt to grab aligned sound data in a sample x trials matrix</span>
0566 <span class="comment">% and a cell array of matrices for the Intan data (aligned for each electrodes)</span>
0567 <span class="comment">%</span>
0568 <span class="comment">%</span>
0569 
0570 <span class="comment">%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%% DATA EXTRACTION %%%%%%%%%%%%%%%%%%%%</span>
0571 
0572 
0573 <a name="_sub4" href="#_subfunctions" class="code">function [MIC_DATA EPHYS_DATA CHANNELS USED_FILENAMES]=extract_hits(SELECTED_PEAKS,FILENAMES,TEMPLATESIZE,SPECT_THRESH,TIME_RANGE,SR,N,OVERLAP,DOWNSAMPLING)</a>
0574 
0575 TEMPLATESIZE=TEMPLATESIZE+N;
0576 USED_FILENAMES={};
0577 MIC_DATA=[];
0578 
0579 load(FILENAMES{1});
0580 
0581 <span class="keyword">if</span> ~exist(<span class="string">'channels'</span>,<span class="string">'var'</span>);
0582     [samples,nchannels]=size(ephys_data);
0583     CHANNELS=1:nchannels;
0584 <span class="keyword">else</span>
0585     CHANNELS=channels;
0586 <span class="keyword">end</span>
0587 
0588 disp([<span class="string">'Extracting cluster ('</span> num2str(length(SELECTED_PEAKS)) <span class="string">' peaks):   '</span>]);
0589 disp(<span class="string">'Preallocating matrices...'</span>);
0590 
0591 formatstring=progressbar(length(SELECTED_PEAKS));
0592 counter=0;
0593 
0594 parfor i=1:length(SELECTED_PEAKS)
0595 
0596     <span class="keyword">if</span> length(SELECTED_PEAKS{i})&lt;1
0597         <span class="keyword">continue</span>;
0598     <span class="keyword">end</span>
0599 
0600     data=load(FILENAMES{i});
0601     sound_data=single(data.mic_data);
0602     
0603     <span class="keyword">if</span> ~isfield(data,<span class="string">'ephys_data'</span>)
0604         ephys_data=data.intan_data;
0605     <span class="keyword">else</span>
0606         ephys_data=data.ephys_data;
0607         <span class="keyword">end</span>
0608     
0609         channels=data.channels;
0610 
0611         <span class="keyword">if</span> ~isempty(setdiff(CHANNELS,channels)) || ~isempty(setdiff(channels,CHANNELS))
0612         disp([<span class="string">'Channel mismatch '</span> FILENAMES{i}]);
0613             <span class="keyword">continue</span>;
0614         <span class="keyword">end</span>
0615     
0616     
0617     fs=data.fs;
0618     <span class="keyword">for</span> j=1:length(SELECTED_PEAKS{i})
0619         
0620         peakLoc=SELECTED_PEAKS{i}(j);
0621 
0622         <span class="comment">% the startpoint needs to be adjusted using the following formula</span>
0623         <span class="comment">% peaklocation*(WINDOWLENGTH-OVERLAP)*SUBSAMPLING-WINDOWLENGTH</span>
0624 
0625         startpoint=(peakLoc*(N-OVERLAP)*DOWNSAMPLING)-N;
0626         endpoint=startpoint+TEMPLATESIZE;
0627 
0628         <span class="keyword">if</span> startpoint/SR&gt;=TIME_RANGE(1) &amp; endpoint/SR&lt;=TIME_RANGE(2)
0629 
0630             <span class="keyword">if</span> length(sound_data)&gt;endpoint &amp;&amp; startpoint&gt;0
0631                 
0632                 counter=counter+1;
0633             
0634             <span class="keyword">end</span>
0635 
0636         <span class="keyword">end</span>
0637     <span class="keyword">end</span>
0638 <span class="keyword">end</span>
0639 
0640 disp([<span class="string">'Found '</span> num2str(counter) <span class="string">' trials '</span>]);
0641 fprintf(1,<span class="string">'\n'</span>);
0642 
0643 <span class="comment">%%%%</span>
0644 
0645 EPHYS_DATA=zeros(TEMPLATESIZE+1,counter,length(CHANNELS),<span class="string">'single'</span>);
0646 MIC_DATA=zeros(TEMPLATESIZE+1,counter,<span class="string">'single'</span>);
0647 
0648 disp(<span class="string">'Extracting data'</span>);
0649 fprintf(1,<span class="string">'\n\n\n\n\n\n'</span>);
0650 
0651 trial=1;
0652 <span class="keyword">for</span> i=1:length(SELECTED_PEAKS)
0653 
0654     fprintf(1,formatstring,i);
0655 
0656     <span class="keyword">if</span> length(SELECTED_PEAKS{i})&lt;1
0657         <span class="keyword">continue</span>;
0658     <span class="keyword">end</span>
0659 
0660     data=load(FILENAMES{i});
0661     sound_data=single(data.mic_data);
0662     
0663     <span class="keyword">if</span> ~isfield(data,<span class="string">'ephys_data'</span>)
0664         ephys_data=data.intan_data;
0665     <span class="keyword">else</span>
0666         ephys_data=data.ephys_data;
0667         <span class="keyword">end</span>
0668      
0669     fs=data.fs;
0670     <span class="keyword">for</span> j=1:length(SELECTED_PEAKS{i})
0671         
0672         peakLoc=SELECTED_PEAKS{i}(j);
0673 
0674         <span class="comment">% the startpoint needs to be adjusted using the following formula</span>
0675         <span class="comment">% peaklocation*(WINDOWLENGTH-OVERLAP)*SUBSAMPLING-WINDOWLENGTH</span>
0676 
0677         startpoint=(peakLoc*(N-OVERLAP)*DOWNSAMPLING)-N;
0678         endpoint=startpoint+TEMPLATESIZE;
0679 
0680         <span class="keyword">if</span> startpoint/SR&gt;=TIME_RANGE(1) &amp; endpoint/SR&lt;=TIME_RANGE(2)
0681 
0682             <span class="keyword">if</span> length(sound_data)&gt;endpoint &amp;&amp; startpoint&gt;0
0683 
0684                 USED_FILENAMES{end+1}=FILENAMES{i};
0685                         MIC_DATA(:,trial)=single(sound_data(startpoint:endpoint));               
0686                 
0687                 <span class="comment">% if we have differences in channel number, how to resolve?</span>
0688 
0689                 <span class="keyword">for</span> k=1:length(CHANNELS)
0690                     
0691                     EPHYS_DATA(:,trial,k)=single(ephys_data(startpoint:endpoint,k));
0692 
0693                 <span class="keyword">end</span>
0694 
0695                 trial=trial+1;
0696 
0697             <span class="keyword">end</span>
0698 
0699         <span class="keyword">end</span>
0700     <span class="keyword">end</span>
0701 <span class="keyword">end</span>
0702 
0703 fprintf(<span class="string">'\n'</span>);
0704 
0705 <span class="keyword">end</span>
0706</pre></div>
<hr><address>Generated on Sun 22-Jul-2012 12:37:58 by <strong><a href="http://www.artefact.tk/software/matlab/m2html/" title="Matlab Documentation in HTML">m2html</a></strong> &copy; 2005</address>
</body>
</html>